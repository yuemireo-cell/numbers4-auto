<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒŠãƒ³ãƒãƒ¼ã‚º4 å®Œæˆç‰ˆï¼ˆå¼·åŒ–ï¼šãªã£ã¡ã‚ƒã‚“æ–¹å¼å†…è”µï¼‰</title>
  <style>
    :root{
      --bg:#0b0f18;
      --card:#101827;
      --card2:#0f172a;
      --fg:#e8eefc;
      --muted:#9fb0d0;
      --line:rgba(255,255,255,.08);
      --btn:#2563eb;
      --btn2:#111827;
      --danger:#ef4444;
      --ok:#10b981;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius:18px;
    }

    body{
      margin:0;
      font-family: system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;
      background: linear-gradient(180deg,#070b12 0%, #0b1322 50%, #070b12 100%);
      color:var(--fg);
    }

    .wrap{
      max-width: 920px;
      margin: 0 auto;
      padding: 18px 14px 80px;
    }

    h1{
      margin: 8px 0 14px;
      font-size: 28px;
      letter-spacing:.02em;
    }
    .sub{
      color:var(--muted);
      font-size: 12px;
      line-height: 1.6;
      margin-bottom: 14px;
    }

    .panel{
      background: rgba(16,24,39,.85);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }

    input, textarea, select, button{
      font-size: 16px;
      width:100%;
      box-sizing:border-box;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--fg);
      outline: none;
    }
    input::placeholder, textarea::placeholder{ color: rgba(232,238,252,.45); }

    button{
      border:none;
      font-weight: 900;
      cursor:pointer;
    }
    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .btn{
      background: var(--btn);
      color:#fff;
      border-radius: 16px;
      padding: 14px 14px;
    }
    .btn.secondary{
      background: rgba(255,255,255,.08);
      color: var(--fg);
      border: 1px solid rgba(255,255,255,.12);
    }
    .btn.ghost{
      background: transparent;
      border: 1px solid rgba(255,255,255,.18);
      color: var(--fg);
    }
    .btn.danger{
      background: rgba(239,68,68,.12);
      border: 1px solid rgba(239,68,68,.35);
      color: #ffd7d7;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:720px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .label{
      font-weight: 900;
      margin: 8px 0 6px;
      font-size: 13px;
      color: rgba(232,238,252,.92);
    }

    .note{
      color: rgba(232,238,252,.65);
      font-size: 12px;
      line-height: 1.6;
      margin-top: 8px;
    }

    .resultBox{
      margin-top: 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding: 12px;
    }

    pre{
      white-space: pre-wrap;
      word-break: break-word;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px;
      margin: 10px 0 0;
      color: var(--fg);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 14px;
    }

    .ok{ color: var(--ok); font-weight: 900; }
    .warn{ color: #ffb4b4; font-weight: 900; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    /* ä½åˆ¥ãƒ‘ãƒãƒ«ï¼ˆæ—¢å­˜ï¼‰ */
    .posGrid{
      display:flex; gap:12px; flex-wrap:wrap; margin-top:10px;
    }
    .posCard{
      border: 2px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 12px;
      background: rgba(0,0,0,.18);
      flex:1;
      min-width:170px;
    }
    .posTitle{ font-weight:1000; font-size:16px; margin-bottom:8px; color: rgba(232,238,252,.9); }
    .posRow{
      display:flex; align-items:flex-end; justify-content:space-between;
      padding:10px 0; border-bottom:1px solid rgba(255,255,255,.10);
    }
    .posRow:last-child{ border-bottom:none; }
    .posNum{ font-size: 36px; font-weight: 1000; line-height: 1; }
    .posScore{ color: rgba(232,238,252,.55); font-weight: 900; }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.85); color:#fff;
      padding:10px 14px; border-radius:999px;
      font-weight:900; font-size:13px; opacity:0;
      pointer-events:none; transition:opacity .18s ease;
      z-index:9999; max-width:92vw; text-align:center;
      border: 1px solid rgba(255,255,255,.15);
      backdrop-filter: blur(10px);
    }
    .toast.show{ opacity:0.96; }

    /* ========== ãªã£ã¡ã‚ƒã‚“æ–¹å¼ãƒ¢ãƒ¼ãƒ€ãƒ« ========== */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index: 9998;
      padding: 18px 14px;
      overflow:auto;
    }
    .modalBack.show{ display:block; }
    .modal{
      max-width: 920px;
      margin: 0 auto;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      overflow:hidden;
    }
    .modalHead{
      background: rgba(255,255,255,.06);
      border-bottom: 1px solid rgba(255,255,255,.10);
      padding: 14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalTitle{
      font-weight: 1000;
      letter-spacing:.02em;
    }
    .modalBody{
      padding: 14px;
      background: rgba(6,10,18,.55);
    }

    .tabRow{
      display:flex;
      gap:10px;
      margin-top: 10px;
    }
    .tab{
      flex:1;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(232,238,252,.85);
      padding: 12px 10px;
      border-radius: 14px;
      font-weight: 1000;
      text-align:center;
      cursor:pointer;
    }
    .tab.active{
      background: rgba(37,99,235,.20);
      border-color: rgba(37,99,235,.45);
      color: #fff;
    }

    .nTable{
      width:100%;
      border-collapse: collapse;
      margin-top: 12px;
      overflow:hidden;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
    }
    .nTable th, .nTable td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      text-align:center;
      font-weight: 900;
      color: rgba(232,238,252,.9);
    }
    .nTable th{
      background: rgba(255,255,255,.06);
      color: rgba(232,238,252,.75);
      font-size: 12px;
      letter-spacing:.04em;
    }
    .nTable tr:last-child td{ border-bottom:none; }
    .pill{
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.15);
      color: rgba(232,238,252,.85);
      font-size: 12px;
      font-weight: 1000;
    }

    .cards10{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width:720px){
      .cards10{ grid-template-columns: 1fr; }
    }
    .cardNum{
      border-radius: 16px;
      padding: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .rankNo{
      font-weight: 1000;
      color: rgba(232,238,252,.75);
      font-size: 12px;
    }
    .numBig{
      font-size: 26px;
      font-weight: 1000;
      letter-spacing:.06em;
    }
    .scoreSmall{
      color: rgba(232,238,252,.65);
      font-weight: 1000;
      font-size: 12px;
      text-align:right;
      min-width: 80px;
    }

    .divider{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 14px 0;
    }

    .tiny{
      font-size: 11px;
      color: rgba(232,238,252,.55);
      line-height: 1.6;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>ãƒŠãƒ³ãƒãƒ¼ã‚º4 å®Œæˆç‰ˆï¼ˆå¼·åŒ–ï¼‰</h1>
    <div class="sub">
      ãƒ»æ—¢å­˜æ©Ÿèƒ½ã¯å‰Šé™¤ã—ãªã„ï¼ˆã‚†ã†ã¡ã‚ƒã‚“æ–¹é‡ï¼‰ï¼ å…¨æ©Ÿèƒ½å¸¸æ™‚ON<br>
      ãƒ»éå»ãƒ‡ãƒ¼ã‚¿ã¯å†…éƒ¨ï¼ˆéè¡¨ç¤ºï¼‰ã«ä¿æŒï¼ˆæœ€å¤§300å›ï¼‰<br>
      ãƒ»18æ™‚ã‚®ãƒªã‚®ãƒªã®ãƒªãƒæ•°å­—ã¯åˆ†æã«ä½¿ã‚ãªã„ï¼ˆæ—¢å®šï¼šé™¤å¤–ï¼‰
    </div>

    <!-- è¿½åŠ ï¼šãªã£ã¡ã‚ƒã‚“æ–¹å¼ãƒœã‚¿ãƒ³ -->
    <div class="panel">
      <div class="label">ãªã£ã¡ã‚ƒã‚“æ–¹å¼ å¾¹åº•è§£æï¼ˆç”»åƒã¨åŒã˜æ§‹æˆï¼‰</div>
      <div class="note">
        ã€Œè§£æç”¨ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã€ã‚’å‡ºã•ãªã„ãŸã‚ã€åˆå›ã«å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚’æ³¨å…¥ â†’ ç«¯æœ«å†…ã«ä¿å­˜ã—ã¾ã™ï¼ˆè¡¨ã«ã¯å‡ºã—ã¾ã›ã‚“ï¼‰ã€‚
      </div>
      <div class="btnRow">
        <button class="btn" type="button" onclick="openNacchan()">ãªã£ã¡ã‚ƒã‚“æ–¹å¼ã‚’é–‹ã</button>
        <button class="btn secondary" type="button" onclick="forceInjectBuiltin()">å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚’å†æ³¨å…¥ï¼ˆå¿…è¦æ™‚ï¼‰</button>
      </div>
    </div>

    <!-- ===== ã“ã“ã‹ã‚‰ï¼šæ—¢å­˜ï¼ˆã‚†ã†ã¡ã‚ƒã‚“ã®ä»Šã®ã‚³ãƒ¼ãƒ‰ï¼‰ã‚’æ¸©å­˜ã—ã¤ã¤å¼·åŒ– ===== -->
    <div class="panel" style="margin-top:14px;">
      <div class="label">ãƒ’ãƒ³ãƒˆ1ï¼ˆä¾‹ï¼š168 / 1ãƒ»6ãƒ»8ï¼‰</div>
      <input id="hint1" inputmode="numeric" placeholder="ãƒ’ãƒ³ãƒˆ1 ä¾‹ï¼š168">

      <div class="label">ãƒ’ãƒ³ãƒˆ2ï¼ˆä¾‹ï¼š3920 / 3ãƒ»9ãƒ»2ãƒ»0ï¼‰</div>
      <input id="hint2" inputmode="numeric" placeholder="ãƒ’ãƒ³ãƒˆ2 ä¾‹ï¼š3920">

      <div class="grid2">
        <div>
          <div class="label">å‰å›ï¼ˆè‡ªå‹•ï¼‰</div>
          <input id="prev" inputmode="numeric" placeholder="å‰å› ä¾‹ï¼š5105" maxlength="4">
        </div>
        <div>
          <div class="label">å‰ã€…å›ï¼ˆè‡ªå‹•ï¼‰</div>
          <input id="prev2" inputmode="numeric" placeholder="å‰ã€…å› ä¾‹ï¼š4588" maxlength="4">
        </div>
      </div>

      <div class="grid2">
        <div>
          <div class="label">ä»Šå›ã®æŠ½é¸çµæœï¼ˆä¿å­˜ç”¨ãƒ»4æ¡ï¼‰</div>
          <input id="saveWin" inputmode="numeric" placeholder="ä¾‹ï¼š3727" maxlength="4">
        </div>
        <div>
          <div class="label">ãƒ¡ãƒ¢ï¼šãƒªãƒæ•°å­—ï¼ˆè§£æã§ã¯â€œåŸºæœ¬é™¤å¤–â€ï¼‰</div>
          <input id="rehearsal" inputmode="numeric" placeholder="ä¾‹ï¼š1755" maxlength="4">
        </div>
      </div>

      <div class="note">
        âœ… ä¿å­˜ãƒœã‚¿ãƒ³ã§ã€Œä»Šå›â†’å‰å›ã€ã€Œå‰å›â†’å‰ã€…å›ã€ã‚’è‡ªå‹•æ›´æ–°ã€‚<br>
        âœ… ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã¯è¡¨ã«å‡ºã•ãšã€ç«¯æœ«å†…ï¼ˆlocalStorageï¼‰ã«æœ€å¤§<strong>300å›</strong>ä¿æŒã€‚<br>
        â€»18æ™‚ã‚®ãƒªã‚®ãƒªã®ãƒªãƒã¯åˆ†æã«ä½¿ã‚ãªã„ï¼ˆã‚†ã†ã¡ã‚ƒã‚“æ–¹é‡ï¼‰
      </div>

      <div class="btnRow">
        <button class="btn" type="button" onclick="saveDraw()">ğŸ“© æŠ½é¸çµæœã‚’ä¿å­˜</button>
        <button class="btn secondary" type="button" onclick="generate()">ğŸ”® ç•ªå·ã‚’ç”Ÿæˆã™ã‚‹</button>
      </div>
    </div>

    <!-- ä½åˆ¥ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆè§£æ -->
    <div class="resultBox">
      <div class="label">ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆäºˆæƒ³ï¼ˆä½åˆ¥4å€™è£œ / ä¿å­˜300å›ï¼‹åŠ ç‚¹è§£æï¼‰</div>
      <div class="note">
        ä¿å­˜å±¥æ­´ã®ã€Œä½åˆ¥é »åº¦ã€ã‚’ä¸»è»¸ã«ã€è£æ•°å­—ãƒ»Â±1ãƒ»Â±2ãƒ»å¼•ã£å¼µã‚Šãƒ»è¶³ã™9ãƒ»é€£ç•ªãƒ»ãƒ€ãƒ–ãƒ«ç­‰ã‚’å¸¸æ™‚ONã§ã‚¹ã‚³ã‚¢åŒ–ã€‚
      </div>
      <div id="posOut" class="posGrid"></div>
    </div>

    <!-- åˆ¤å®š -->
    <div class="resultBox">
      <div class="label">å½“é¸ç•ªå·ï¼ˆçµæœãŒå‡ºãŸã‚‰ã“ã“ã«4æ¡ï¼‰</div>
      <input id="win" inputmode="numeric" placeholder="ä¾‹ï¼š3727" maxlength="4">
      <button class="btn" type="button" onclick="judge()">çµæœã‚’åˆ¤å®šã™ã‚‹</button>
      <div id="judgeOut" class="mono" style="margin-top:10px;"></div>
      <div class="note">â€»åˆ¤å®šã¯ã€Œã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼‹ã‚»ãƒƒãƒˆã€ä¸¡æ–¹ï¼ˆå›ºå®šï¼‰</div>
    </div>

    <div class="resultBox">
      <div class="label">ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</div>
      <div id="dayPower" class="mono" style="margin-top:6px;"></div>

      <div class="label" style="margin-top:10px;">æœ¬å‘½ï¼ˆå¼·ï¼‰</div>
      <pre id="straightMain">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>

      <div class="label" style="margin-top:10px;">ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</div>
      <pre id="straightIns">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>
    </div>

    <div class="resultBox">
      <div class="label">ã‚»ãƒƒãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</div>

      <div class="label" style="margin-top:10px;">æœ¬å‘½ï¼ˆå¼·ï¼‰</div>
      <pre id="setMain">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>

      <div class="label" style="margin-top:10px;">ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</div>
      <pre id="setIns">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- ===== ãªã£ã¡ã‚ƒã‚“æ–¹å¼ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
  <div id="nBack" class="modalBack">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div class="modalTitle">ãªã£ã¡ã‚ƒã‚“æ–¹å¼ å¾¹åº•è§£æ</div>
          <div class="tiny" id="nMeta">éå»å±¥æ­´ï¼šâ€”</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;">
          <button class="btn secondary" style="width:auto;" onclick="runNacchan()">è§£æã™ã‚‹</button>
          <button class="btn" style="width:auto;" onclick="saveNacchanPreset()">ä¿å­˜</button>
          <button class="btn ghost" style="width:auto;" onclick="closeNacchan()">é–‰ã˜ã‚‹</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="grid2">
          <div>
            <div class="label">éå»å±¥æ­´ï¼ˆå›å·ã‚’è¡¨ç¤º / å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ï¼‰</div>
            <select id="nPick"></select>
            <div class="tiny">â€»ã“ã“ã§é¸ã‚“ã å›ã‚’ã€Œå‰å›ã€ã¨ã—ã¦æ‰±ã†ï¼ˆç”»åƒã®æŒ™å‹•ã«åˆã‚ã›ã‚‹ï¼‰</div>
          </div>
          <div>
            <div class="label">ãƒªãƒæ•°å­—ï¼ˆ4æ¡ï¼‰</div>
            <input id="nReh" inputmode="numeric" placeholder="ä¾‹ï¼š1755" maxlength="4">
            <div class="tiny">
              â€»æ—¢å®šã§ã¯ã€Œ18æ™‚ã‚®ãƒªã‚®ãƒªã®ãƒªãƒã€ã¯è§£æã«ä½¿ã‚ãªã„ï¼ˆã‚†ã†ã¡ã‚ƒã‚“æ–¹é‡ï¼‰  
              <span class="pill" id="rehPolicyPill">é™¤å¤–ON</span>
              <button class="btn ghost" style="width:auto;margin-left:8px;padding:8px 10px;font-size:12px;border-radius:999px;" onclick="toggleRehPolicy()">åˆ‡æ›¿</button>
            </div>
          </div>
        </div>

        <div class="tabRow">
          <div class="tab" id="tabBasic" onclick="setNTab('basic')">â‘  åŸºæœ¬è§£æ</div>
          <div class="tab active" id="tabZure" onclick="setNTab('zure')">â‘¡ ã‚ºãƒ¬è§£æ</div>
        </div>

        <div id="paneBasic" style="display:none;">
          <div class="divider"></div>
          <div class="tiny">
            ã“ã“ã¯ã€Œä¿å­˜300å›ã€ï¼‹ã€Œå‰å›/å‰ã€…å›ã€ï¼‹ã€Œãƒ’ãƒ³ãƒˆã€ï¼‹ã€ŒãƒŠãƒ³ã¡ã‚ƒã‚“åŠ ç‚¹ï¼ˆè£ãƒ»Â±1ãƒ»Â±2ï¼‰ã€ã‚’ã¾ã¨ã‚ãŸç·åˆäºˆæƒ³ã€‚<br>
            ï¼ˆä¸‹ã®ã€Œã‚ºãƒ¬è§£æã€ã¯ç”»åƒã®å†…å®¹ã‚’å†ç¾ï¼‰
          </div>
          <div class="btnRow" style="margin-top:12px;">
            <button class="btn" type="button" onclick="generate();toast('ç·åˆäºˆæƒ³ã‚’æ›´æ–°ã—ãŸã‚ˆ');">ç·åˆäºˆæƒ³ï¼ˆã“ã®ãƒšãƒ¼ã‚¸ã®ç”Ÿæˆï¼‰ã‚’å®Ÿè¡Œ</button>
          </div>
        </div>

        <div id="paneZure">
          <table class="nTable">
            <thead>
              <tr>
                <th style="width:22%;">é …ç›®</th>
                <th>åƒ</th>
                <th>ç™¾</th>
                <th>å</th>
                <th>ä¸€</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span class="pill">æœ€æ–°ãƒªãƒ</span></td>
                <td id="z_k">â€”</td>
                <td id="z_h">â€”</td>
                <td id="z_t">â€”</td>
                <td id="z_o">â€”</td>
              </tr>
              <tr>
                <td><span class="pill">ã‚ºãƒ¬(Â±1)</span></td>
                <td id="z_k_pm1">â€”</td>
                <td id="z_h_pm1">â€”</td>
                <td id="z_t_pm1">â€”</td>
                <td id="z_o_pm1">â€”</td>
              </tr>
              <tr>
                <td><span class="pill">ãƒ›ãƒƒãƒˆç•ª</span></td>
                <td id="z_k_hot">â€”</td>
                <td id="z_h_hot">â€”</td>
                <td id="z_t_hot">â€”</td>
                <td id="z_o_hot">â€”</td>
              </tr>
            </tbody>
          </table>

          <div class="cards10" id="nTop10"></div>

          <div class="divider"></div>
          <div class="tiny">
            â€»ã“ã®10å£ã¯ã€Œãƒªãƒã®Â±1/Â±2ã€ã€Œè£æ•°å­—ã€ã€Œå‡ºç¾é–“éš”ã€ã€Œæ¬¡ã«æ¥ã‚„ã™ã„é·ç§»ã€ã€Œãƒ€ãƒ–ãƒ«å‚¾å‘ã€ã‚’ã‚¹ã‚³ã‚¢åŒ–ã—ã¦ä¸Šä½ã‹ã‚‰ä¸¦ã¹ã¦ã„ã¾ã™ã€‚<br>
            â€»â€œåŒã˜æ•°å­—ãŒç¶šãï¼Ÿâ€ã¯ã‚¼ãƒ­ã˜ã‚ƒãªã„ã‘ã©ã€åŸºæœ¬ã¯<strong>é·ç§»ï¼ˆå‰å›â†’æ¬¡ï¼‰</strong>ã‚’é‡è¦–ã—ã¦ã€Œå®Œå…¨åŒä¸€ã€ã‚’å„ªå…ˆã—ãªã„è¨­è¨ˆã«ã—ã¦ã‚‹ã€‚
          </div>
        </div>

        <div class="btnRow" style="margin-top:14px;">
          <button class="btn danger" type="button" onclick="clearAllLocal()">ç«¯æœ«å†…ãƒ‡ãƒ¼ã‚¿ã‚’å…¨æ¶ˆå»ï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰</button>
        </div>

      </div>
    </div>
  </div>

<script>
/***************************************************************
 * âœ… å›ºå®šæ–¹é‡ï¼ˆã‚†ã†ã¡ã‚ƒã‚“ä»•æ§˜ï¼‰
 * - æ—¢å­˜æ©Ÿèƒ½ã¯å‰Šé™¤ã—ãªã„ï¼ˆæ‹¡å¼µã®ã¿ï¼‰
 * - å±¥æ­´ã¯ç«¯æœ«å†…(localStorage)ã«æœ€å¤§300å›ã€è¡¨ã«ã¯å‡ºã•ãªã„
 * - ä¿å­˜ãƒœã‚¿ãƒ³ã§ ä»Šå›â†’å‰å›(prev)ã€å‰å›â†’å‰ã€…å›(prev2) è‡ªå‹•æ›´æ–°
 * - å…¨æ©Ÿèƒ½å¸¸æ™‚ONï¼ˆãƒã‚§ãƒƒã‚¯UIä¸è¦ï¼‰
 * - 18æ™‚ã‚®ãƒªã‚®ãƒªã®ãƒªãƒæ•°å­—ã¯åˆ†æã«ä½¿ã‚ãªã„ï¼ˆæ—¢å®šï¼šé™¤å¤–ï¼‰
 ***************************************************************/

/* ========= å†…è”µãƒ‡ãƒ¼ã‚¿ï¼ˆã‚†ã†ã¡ã‚ƒã‚“ãŒè²¼ã£ã¦ãã‚ŒãŸç¯„å›²ï¼‰ =========
  â€»è¡¨ç¤ºã¯ã—ãªã„ã€‚åˆå›ã ã‘ localStorage ã¸æ³¨å…¥ã—ã¦è§£æã‚’æˆç«‹ã•ã›ã‚‹ã€‚
  â€»ã“ã“ã«ã¯ã€Œç¬¬xxxxå›ã€ã€Œ4æ¡ã€ã®çµ„ã‚’å…¥ã‚Œã‚‹ã€‚æ›œæ—¥ãƒ»é‡‘é¡ã¯ç„¡è¦–ã—ã¦OKã€‚
*/
const BUILTIN_RAW = `
ç¬¬6909å› 9827
ç¬¬6908å› 6120
ç¬¬6907å› 4588
ç¬¬6906å› 7964
ç¬¬6905å› 0176
ç¬¬6904å› 0515
ç¬¬6903å› 6022
ç¬¬6902å› 0615
ç¬¬6901å› 9534
ç¬¬6900å› 8174
ç¬¬6899å› 6436
ç¬¬6898å› 8060
ç¬¬6897å› 2404
ç¬¬6896å› 2699
ç¬¬6895å› 2827
ç¬¬6894å› 6551
ç¬¬6893å› 1632
ç¬¬6892å› 7263
ç¬¬6891å› 2300
ç¬¬6890å› 7526
ç¬¬6889å› 7202
ç¬¬6888å› 2121
ç¬¬6887å› 4141
ç¬¬6886å› 6333
ç¬¬6885å› 3984
ç¬¬6884å› 3278
ç¬¬6883å› 9785
ç¬¬6882å› 4944
ç¬¬6881å› 5879
ç¬¬6880å› 0497
ç¬¬6879å› 2310
ç¬¬6878å› 7221
ç¬¬6877å› 2528
ç¬¬6876å› 2208
ç¬¬6875å› 5272
ç¬¬6874å› 3123
ç¬¬6873å› 3493
ç¬¬6872å› 4784
ç¬¬6871å› 5571
ç¬¬6870å› 7263
ç¬¬6869å› 6936
ç¬¬6868å› 5396
ç¬¬6867å› 3076
ç¬¬6866å› 2803
ç¬¬6865å› 3324
ç¬¬6864å› 5445
ç¬¬6863å› 1258
ç¬¬6862å› 9741
ç¬¬6861å› 4693
ç¬¬6860å› 5186
ç¬¬6859å› 6444
ç¬¬6858å› 1184
ç¬¬6857å› 3116
ç¬¬6856å› 9991
ç¬¬6855å› 2123
ç¬¬6854å› 3403
ç¬¬6853å› 6727
ç¬¬6852å› 3049
ç¬¬6851å› 2981
ç¬¬6850å› 5282
ç¬¬6849å› 9227
ç¬¬6848å› 9275
ç¬¬6847å› 0137
ç¬¬6846å› 8726
ç¬¬6845å› 4714
ç¬¬6844å› 0017
ç¬¬6843å› 0523
ç¬¬6842å› 4591
ç¬¬6841å› 8612
ç¬¬6840å› 2326
ç¬¬6839å› 8607
ç¬¬6838å› 0100
ç¬¬6837å› 5441
ç¬¬6836å› 4325
ç¬¬6835å› 1350
ç¬¬6834å› 4706
ç¬¬6833å› 6896
ç¬¬6832å› 3148
ç¬¬6831å› 6352
ç¬¬6830å› 0220
ç¬¬6829å› 7717
ç¬¬6828å› 0933
ç¬¬6827å› 2964
ç¬¬6826å› 1916
ç¬¬6825å› 5280
ç¬¬6824å› 7765
ç¬¬6823å› 0012
ç¬¬6822å› 1540
ç¬¬6821å› 7728
ç¬¬6820å› 2477
ç¬¬6819å› 4787
ç¬¬6818å› 5808
ç¬¬6817å› 8721
ç¬¬6816å› 6152
ç¬¬6815å› 7604
ç¬¬6814å› 1314
ç¬¬6813å› 6867
ç¬¬6812å› 8991
ç¬¬6811å› 7961
ç¬¬6810å› 2679
ç¬¬6809å› 5260
ç¬¬6808å› 2841
ç¬¬6807å› 1871
ç¬¬6806å› 3376
ç¬¬6805å› 4598
ç¬¬6804å› 0538
ç¬¬6803å› 0549
ç¬¬6802å› 1929
ç¬¬6801å› 0774
ç¬¬6800å› 6694
ç¬¬6799å› 1624
ç¬¬6798å› 9463
ç¬¬6797å› 9660
ç¬¬6796å› 5806
ç¬¬6795å› 8749
ç¬¬6794å› 9288
ç¬¬6793å› 9959
ç¬¬6792å› 5140
ç¬¬6791å› 6362
ç¬¬6790å› 5541
ç¬¬6789å› 2458
ç¬¬6788å› 6014
ç¬¬6787å› 1365
ç¬¬6786å› 5835
ç¬¬6785å› 4876
ç¬¬6784å› 1027
ç¬¬6783å› 3080
ç¬¬6782å› 3497
ç¬¬6781å› 0536
ç¬¬6780å› 3175
ç¬¬6779å› 1592
ç¬¬6778å› 6710
ç¬¬6777å› 5454
ç¬¬6776å› 7924
ç¬¬6775å› 5493
ç¬¬6774å› 8714
ç¬¬6773å› 7780
ç¬¬6772å› 2460
ç¬¬6771å› 2337
ç¬¬6770å› 2037
ç¬¬6769å› 5552
ç¬¬6768å› 5295
ç¬¬6767å› 0172
ç¬¬6766å› 4790
ç¬¬6765å› 5358
ç¬¬6764å› 2982
ç¬¬6763å› 9181
ç¬¬6762å› 2452
ç¬¬6761å› 1479
ç¬¬6760å› 3099
ç¬¬6759å› 5261
ç¬¬6758å› 6757
ç¬¬6757å› 2940
ç¬¬6756å› 8622
ç¬¬6755å› 8174
ç¬¬6754å› 1351
ç¬¬6753å› 4804
ç¬¬6752å› 7102
ç¬¬6751å› 5354
ç¬¬6750å› 7592
ç¬¬6749å› 0975
ç¬¬6748å› 6326
ç¬¬6747å› 2482
ç¬¬6746å› 7666
ç¬¬6745å› 3176
ç¬¬6744å› 3142
ç¬¬6743å› 5084
ç¬¬6742å› 6563
ç¬¬6741å› 9318
ç¬¬6740å› 5944
ç¬¬6739å› 2370
ç¬¬6738å› 2839
ç¬¬6737å› 7141
ç¬¬6736å› 6779
ç¬¬6735å› 7357
ç¬¬6734å› 3697
ç¬¬6733å› 9115
ç¬¬6732å› 2718
ç¬¬6731å› 9899
ç¬¬6730å› 2762
ç¬¬6729å› 6418
ç¬¬6728å› 9601
ç¬¬6727å› 4116
ç¬¬6726å› 4368
ç¬¬6725å› 1898
ç¬¬6724å› 9565
ç¬¬6723å› 8892
ç¬¬6722å› 1883
ç¬¬6721å› 8156
ç¬¬6720å› 1952
ç¬¬6719å› 0081
ç¬¬6718å› 8391
ç¬¬6717å› 2948
ç¬¬6716å› 8968
ç¬¬6715å› 5323
ç¬¬6714å› 3449
ç¬¬6713å› 1670
ç¬¬6712å› 4071
ç¬¬6711å› 9686
ç¬¬6710å› 7059
ç¬¬6709å› 6697
ç¬¬6708å› 7834
ç¬¬6707å› 4811
ç¬¬6706å› 8842
ç¬¬6705å› 7555
ç¬¬6704å› 2166
ç¬¬6703å› 1820
ç¬¬6702å› 7011
ç¬¬6701å› 7856
ç¬¬6700å› 4013
ç¬¬6699å› 4417
ç¬¬6698å› 2078
ç¬¬6697å› 9721
ç¬¬6696å› 7892
ç¬¬6695å› 1695
ç¬¬6694å› 3671
ç¬¬6693å› 8221
ç¬¬6692å› 6185
ç¬¬6691å› 0745
ç¬¬6690å› 8397
ç¬¬6689å› 2191
ç¬¬6688å› 0488
ç¬¬6687å› 1431
ç¬¬6686å› 8555
ç¬¬6685å› 1087
ç¬¬6684å› 9843
ç¬¬6683å› 7006
ç¬¬6682å› 2853
ç¬¬6681å› 0384
ç¬¬6680å› 9200
ç¬¬6679å› 8261
ç¬¬6678å› 8256
ç¬¬6677å› 0948
ç¬¬6676å› 1781
ç¬¬6675å› 8194
ç¬¬6674å› 6318
ç¬¬6673å› 1170
ç¬¬6672å› 4968
ç¬¬6671å› 3839
ç¬¬6670å› 0664
ç¬¬6669å› 9378
ç¬¬6668å› 3026
ç¬¬6667å› 6398
ç¬¬6666å› 1890
ç¬¬6665å› 9265
ç¬¬6664å› 0385
ç¬¬6663å› 6744
ç¬¬6662å› 3273
ç¬¬6661å› 1946
ç¬¬6660å› 3343
ç¬¬6659å› 8942
ç¬¬6658å› 0859
ç¬¬6657å› 3881
ç¬¬6656å› 0853
ç¬¬6655å› 2317
ç¬¬6654å› 4827
ç¬¬6653å› 0235
ç¬¬6652å› 1596
ç¬¬6651å› 5400
ç¬¬6650å› 9590
ç¬¬6649å› 0893
ç¬¬6648å› 7240
ç¬¬6647å› 2315
ç¬¬6646å› 5420
ç¬¬6645å› 6385
ç¬¬6644å› 8259
ç¬¬6643å› 4409
ç¬¬6642å› 9774
ç¬¬6641å› 2324
ç¬¬6640å› 1366
ç¬¬6639å› 0135
ç¬¬6638å› 8583
ç¬¬6637å› 1599
ç¬¬6636å› 5802
ç¬¬6635å› 1786
ç¬¬6634å› 3754
ç¬¬6633å› 0685
ç¬¬6632å› 9983
ç¬¬6631å› 4386
ç¬¬6630å› 4119
ç¬¬6629å› 0474
ç¬¬6628å› 5231
ç¬¬6627å› 5892
ç¬¬6626å› 0580
ç¬¬6625å› 5214
ç¬¬6624å› 3498
ç¬¬6623å› 0596
ç¬¬6622å› 3424
ç¬¬6621å› 6199
ç¬¬6620å› 9105
ç¬¬6619å› 6217
ç¬¬6618å› 4259
ç¬¬6617å› 2617
ç¬¬6616å› 8939
ç¬¬6615å› 8253
ç¬¬6614å› 0000
ç¬¬6613å› 1978
ç¬¬6612å› 3920
ç¬¬6611å› 3212
ç¬¬6610å› 4640
ç¬¬6609å› 8963
`;

/* ========= æ—¢å­˜ï¼‹å¼·åŒ–ï¼šå…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
const ura = {0:5,5:0,1:6,6:1,2:7,7:2,3:8,8:3,4:9,9:4};
function plus1(n){ return [(n+1)%10, (n+9)%10]; }
function plus2(n){ return [(n+2)%10, (n+8)%10]; }

function digits(str){ return (str || "").match(/\d/g) || []; }
function uniq(arr){ const s=new Set(),o=[]; for(const x of arr){ if(!s.has(x)){ s.add(x); o.push(x);} } return o; }
function normalize4(str){
  const d = digits(str).slice(0,4);
  if(d.length !== 4) return null;
  return d.join("");
}
function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), 1600);
}
function hash32(str){
  let h = 2166136261;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function mulberry32(seed){
  return function(){
    let t = seed += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function pick(pool, rand){ return pool[Math.floor(rand() * pool.length)]; }

/* ========= localStorageï¼ˆ300å›ï¼‰ ========= */
const LS_KEY = "n4_history_300_v1";      // ["3727","...."] newest first
const LS_META = "n4_meta_300_v1";        // misc
const LS_NACCHAN = "n4_nacchan_preset_v1";

function loadHistory(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(arr)) return [];
    return arr.map(x => String(x)).map(normalize4).filter(Boolean);
  }catch(e){ return []; }
}
function saveHistory(arr){
  localStorage.setItem(LS_KEY, JSON.stringify(arr.slice(0,300)));
}
function syncPrevFieldsFromHistory(){
  const hist = loadHistory();
  document.getElementById("prev").value  = hist[0] || "";
  document.getElementById("prev2").value = hist[1] || "";
}

/* ========= å†…è”µãƒ‡ãƒ¼ã‚¿æ³¨å…¥ ========= */
function parseBuiltin(){
  const re = /ç¬¬\s*(\d+)\s*å›[^\d]*(\d{4})/g;
  const out = [];
  let m;
  while((m = re.exec(BUILTIN_RAW)) !== null){
    out.push({ draw: Number(m[1]), num: m[2] });
  }
  // drawé™é †ã§æ•´åˆ—ã€åŒä¸€drawã¯æœ€åˆã‚’æ¡ç”¨
  out.sort((a,b)=>b.draw-a.draw);
  const seen = new Set();
  const clean = [];
  for(const x of out){
    if(seen.has(x.draw)) continue;
    const n = normalize4(x.num);
    if(!n) continue;
    seen.add(x.draw);
    clean.push({ draw:x.draw, num:n });
  }
  return clean;
}

function injectIfNeeded(){
  const hist = loadHistory();
  if(hist.length >= 60) return; // è¶³ã‚Šã¦ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼ˆååˆ†ã«è§£æã§ãã‚‹ï¼‰
  const built = parseBuiltin();
  if(built.length === 0) return;

  // æ—¢å­˜ã¨ãƒãƒ¼ã‚¸ï¼ˆç•ªå·ã¯æ®‹ã™ã€‚æœ€æ–°å„ªå…ˆï¼‰
  const merged = [];
  for(const x of built){ merged.push(x.num); }
  for(const n of hist){ merged.push(n); }

  // é‡è¤‡é™¤å»ï¼ˆä¸Šã‹ã‚‰ï¼æœ€æ–°å´å„ªå…ˆï¼‰
  const seen = new Set();
  const uniqed = [];
  for(const n of merged){
    if(seen.has(n)) continue;
    seen.add(n);
    uniqed.push(n);
  }
  saveHistory(uniqed.slice(0,300));
  syncPrevFieldsFromHistory();
}

function forceInjectBuiltin(){
  const built = parseBuiltin();
  if(built.length === 0){
    toast("å†…è”µãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„");
    return;
  }
  const nums = built.map(x=>x.num);
  saveHistory(nums.slice(0,300));
  syncPrevFieldsFromHistory();
  rebuildNacchanPicker();
  toast("å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚’å†æ³¨å…¥ã—ãŸã‚ˆ");
}

/* ========= ä¿å­˜ï¼ˆæŠ½é¸çµæœï¼‰ ========= */
function saveDraw(){
  injectIfNeeded();
  const win = normalize4(document.getElementById("saveWin").value);
  if(!win){ toast("4æ¡ã§å…¥ã‚Œã¦ã­"); return; }

  let hist = loadHistory();
  if(hist[0] === win){ toast("åŒã˜ç•ªå·ã¯é€£ç¶šä¿å­˜ã—ãªã„ã‚ˆ"); return; }

  hist.unshift(win);
  hist = hist.slice(0,300);
  saveHistory(hist);
  document.getElementById("prev").value  = hist[0] || "";
  document.getElementById("prev2").value = hist[1] || "";
  rebuildNacchanPicker();
  toast(`ä¿å­˜OKï¼šæœ€æ–° ${win}ï¼ˆå±¥æ­´ ${hist.length}ä»¶ï¼‰`);
}

/* ========= çµ±è¨ˆï¼šä½åˆ¥é »åº¦ãƒ»å…¨ä½“é »åº¦ãƒ»å‡ºç¾é–“éš”ãƒ»é·ç§» ========= */
function buildStats(){
  const hist = loadHistory(); // newest first
  const pos = { k:Array(10).fill(0), h:Array(10).fill(0), t:Array(10).fill(0), o:Array(10).fill(0) };
  const all = Array(10).fill(0);

  // å‡ºç¾é–“éš”ï¼ˆæœ€å¾Œã«å‡ºãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰
  const lastSeen = { k:Array(10).fill(null), h:Array(10).fill(null), t:Array(10).fill(null), o:Array(10).fill(null), all:Array(10).fill(null) };

  // é·ç§»ï¼ˆå‰å›â†’æ¬¡å›ã®ä½åˆ¥ï¼‰
  const trans = { k:Array.from({length:10},()=>Array(10).fill(0)),
                  h:Array.from({length:10},()=>Array(10).fill(0)),
                  t:Array.from({length:10},()=>Array(10).fill(0)),
                  o:Array.from({length:10},()=>Array(10).fill(0)) };

  for(let i=0;i<hist.length;i++){
    const n = hist[i];
    let w = 1;
    if(i < 12) w = 3;
    else if(i < 60) w = 2;
    else w = 1;

    const a = n.split("").map(Number);
    pos.k[a[0]] += w; pos.h[a[1]] += w; pos.t[a[2]] += w; pos.o[a[3]] += w;
    all[a[0]] += 1; all[a[1]] += 1; all[a[2]] += 1; all[a[3]] += 1;

    if(lastSeen.k[a[0]] === null) lastSeen.k[a[0]] = i;
    if(lastSeen.h[a[1]] === null) lastSeen.h[a[1]] = i;
    if(lastSeen.t[a[2]] === null) lastSeen.t[a[2]] = i;
    if(lastSeen.o[a[3]] === null) lastSeen.o[a[3]] = i;

    for(const d of a){
      if(lastSeen.all[d] === null) lastSeen.all[d] = i;
    }

    // transition: newer i is current, next is i+1 (older)
    if(i+1 < hist.length){
      const next = hist[i+1].split("").map(Number);
      trans.k[a[0]][next[0]]++;
      trans.h[a[1]][next[1]]++;
      trans.t[a[2]][next[2]]++;
      trans.o[a[3]][next[3]]++;
    }
  }

  return { hist, pos, all, lastSeen, trans };
}

/* ========= ãƒŠãƒ³ã¡ã‚ƒã‚“å¼·åŒ–åŠ ç‚¹ï¼ˆè£ãƒ»Â±1ãƒ»Â±2ã‚’ä½åˆ¥ã‚¹ã‚³ã‚¢ã«åæ˜ ï¼‰ ========= */
function applyNanChanBonus(basePosScores){
  const out = { k: basePosScores.k.slice(), h: basePosScores.h.slice(), t: basePosScores.t.slice(), o: basePosScores.o.slice() };
  for(const key of ["k","h","t","o"]){
    const s = basePosScores[key];
    const idx = [...Array(10)].map((_,d)=>d).sort((a,b)=>s[b]-s[a]);
    const anchors = [idx[0], idx[1]].filter(x=>typeof x==="number");

    for(let d=0; d<=9; d++){
      let add = 0;
      for(const a of anchors){
        if(ura[a] === d) add += 2.0;
        if(plus1(a).includes(d)) add += 1.5;
        if(plus2(a).includes(d)) add += 1.0;
      }
      out[key][d] += add;
    }
  }
  return out;
}

/* ========= ä½åˆ¥ã‚¹ã‚³ã‚¢ï¼ˆæ—¢å­˜ã®èŠ¯ + å‡ºç¾é–“éš” + é·ç§»ï¼‰ ========= */
function buildPositionScores(){
  const { pos, all, lastSeen, trans, hist } = buildStats();

  const base = { k: pos.k.slice(), h: pos.h.slice(), t: pos.t.slice(), o: pos.o.slice() };

  // å…¨ä½“é »åº¦ã‚’è»½ãæ··ãœã‚‹ï¼ˆä¿é™ºï¼‰
  for(const key of ["k","h","t","o"]){
    for(let d=0; d<=9; d++){
      base[key][d] += all[d] * 0.18;
    }
  }

  // å¼•ã£å¼µã‚Šï¼ˆå‰å›/å‰ã€…å›ï¼‰
  const prev = normalize4(document.getElementById("prev").value);
  const prev2 = normalize4(document.getElementById("prev2").value);
  function addPull(arr, ch, w){ const d=Number(ch); if(Number.isFinite(d)) arr[d]+=w; }
  if(prev){
    addPull(base.k, prev[0], 3.2);
    addPull(base.h, prev[1], 3.2);
    addPull(base.t, prev[2], 3.2);
    addPull(base.o, prev[3], 3.2);
  }
  if(prev2){
    addPull(base.k, prev2[0], 2.2);
    addPull(base.h, prev2[1], 2.2);
    addPull(base.t, prev2[2], 2.2);
    addPull(base.o, prev2[3], 2.2);
  }

  // å‡ºç¾é–“éš”ï¼ˆä¹…ã—ã¶ã‚Šã«å‡ºã‚‹æ•°å­—ã«å°‘ã—ã ã‘å¯„ã›ã‚‹ï¼‰
  // lastSeen: index (0=æœ€æ–°)ã€‚nullã¯æœªå‡ºæ‰±ã„â†’åŠ ç‚¹ã€‚
  for(const key of ["k","h","t","o"]){
    for(let d=0; d<=9; d++){
      const ls = lastSeen[key][d];
      if(ls === null) base[key][d] += 1.1; // æœªå‡º
      else{
        // 20å›ä»¥ä¸Šç©ºã„ã¦ãŸã‚‰ã¡ã‚‡ã„åŠ ç‚¹ï¼ˆã‚„ã‚Šã™ããªã„ï¼‰
        if(ls >= 20) base[key][d] += Math.min(2.0, (ls-18)*0.08);
      }
    }
  }

  // é·ç§»ï¼ˆå‰å›ã®å„ä½â†’æ¬¡ã®å„ä½ãŒå‡ºã‚„ã™ã„æ•°å­—ã«åŠ ç‚¹ï¼‰
  if(prev){
    const p = prev.split("").map(Number);
    base.k.forEach((_,d)=>{ base.k[d] += trans.k[p[0]][d] * 0.35; });
    base.h.forEach((_,d)=>{ base.h[d] += trans.h[p[1]][d] * 0.35; });
    base.t.forEach((_,d)=>{ base.t[d] += trans.t[p[2]][d] * 0.35; });
    base.o.forEach((_,d)=>{ base.o[d] += trans.o[p[3]][d] * 0.35; });
  }

  // ãƒŠãƒ³ã¡ã‚ƒã‚“åŠ ç‚¹
  const withNan = applyNanChanBonus(base);

  // ãƒ™ãƒ¼ã‚¹ä¿é™º
  for(const key of ["k","h","t","o"]) for(let d=0; d<=9; d++) withNan[key][d] += 0.2;

  return withNan;
}

function top4FromScores(scoreArr){
  const idx = [...Array(10)].map((_,d)=>d).sort((a,b)=>scoreArr[b]-scoreArr[a]);
  return idx.slice(0,4).map(d=>({d, sc:scoreArr[d]}));
}
function renderPosOut(posScore){
  const map = [
    {key:"k", title:"åƒã®ä½"},
    {key:"h", title:"ç™¾ã®ä½"},
    {key:"t", title:"åã®ä½"},
    {key:"o", title:"ä¸€ã®ä½"}
  ];
  const out = document.getElementById("posOut");
  out.innerHTML = "";
  for(const m of map){
    const top = top4FromScores(posScore[m.key]);
    const card = document.createElement("div");
    card.className = "posCard";
    card.innerHTML = `
      <div class="posTitle">${m.title}</div>
      ${top.map(x=>`
        <div class="posRow">
          <div class="posNum">${x.d}</div>
          <div class="posScore">+${(Math.round(x.sc*10)/10).toFixed(1)}</div>
        </div>
      `).join("")}
    `;
    out.appendChild(card);
  }
}

/* ========= ãƒ’ãƒ³ãƒˆé¸æŠœãƒ»è»¸æ±ºå®šï¼ˆæ—¢å­˜ç¶­æŒï¼‰ ========= */
function pick2FromHint(meStr, sAll, prevStr, prev2Str, otherStr){
  const me = uniq(digits(meStr)).map(Number);
  const other = new Set(uniq(digits(otherStr)).map(Number));
  const pull = new Set( digits((prevStr||"") + (prev2Str||"")).map(Number) );

  const score = (d) => {
    let sc = 0;
    sc += (sAll?.[d] ?? 0) * 6;
    if (pull.has(d)) sc += 18;
    sc += 2;
    if (me.some(x => x !== d && x + d === 9)) sc += 12;
    if (me.some(x => x !== d && Math.abs(x - d) === 1)) sc += 6;
    return sc;
  };

  const commons = me.filter(x => other.has(x));
  if (commons.length >= 2){
    return commons.sort((a,b)=>score(b)-score(a)).slice(0,2).map(String);
  }
  if (commons.length === 1){
    const rest = me.filter(x => x !== commons[0]).sort((a,b)=>score(b)-score(a));
    const second = (rest[0] ?? commons[0]);
    return [String(commons[0]), String(second)];
  }

  if (me.length >= 2) return me.sort((a,b)=>score(b)-score(a)).slice(0,2).map(String);
  if (me.length === 1){
    const candidates = [...Array(10)].map((_,i)=>i).filter(x=>x!==me[0]);
    candidates.sort((a,b)=>score(b)-score(a));
    return [String(me[0]), String(candidates[0] ?? me[0])];
  }
  return ["4","8"];
}

function chooseAxisFromRaw(h1raw, h2raw, sAll){
  const a = uniq(digits(h1raw)).map(Number);
  const b = uniq(digits(h2raw)).map(Number);
  const setB = new Set(b);
  const score = (d) => (sAll?.[d] ?? 0);

  const commons = a.filter(x => setB.has(x));
  if (commons.length >= 2){
    commons.sort((x,y)=>score(y)-score(x));
    return [String(commons[0]), String(commons[1])];
  }
  if (commons.length === 1){
    const all = uniq([...a, ...b].filter(x => x !== commons[0]));
    all.sort((x,y)=>score(y)-score(x));
    const second = all[0] ?? commons[0];
    return [String(commons[0]), String(second)];
  }

  const all = uniq([...a, ...b]);
  all.sort((x,y)=>score(y)-score(x));
  if (all.length >= 2) return [String(all[0]), String(all[1])];
  return ["4","8"];
}

function buildPoolWeighted(h1_2, h2_2, sAll, posScore){
  let p = [];
  p.push(...h1_2, ...h2_2);

  for(const x of [...h1_2, ...h2_2]){
    const n = +x;
    if (ura[n] !== undefined) p.push(String(ura[n]));
  }
  for(const x of [...h1_2, ...h2_2]){
    const n = +x;
    if(n > 0) p.push(String(n-1));
    if(n < 9) p.push(String(n+1));
  }

  for(let d=0; d<=9; d++){
    const w = Math.max(0, Math.round((sAll[d] ?? 0) * 1.2));
    for(let i=0;i<w;i++) p.push(String(d));
  }

  const tops = [];
  for(const key of ["k","h","t","o"]){
    const top = top4FromScores(posScore[key]).slice(0,2).map(x=>String(x.d));
    tops.push(...top);
  }
  p.push(...tops);

  p.push("0","1","2","3","4","5","6","7","8","9");
  return p;
}

/* ========= ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå¼·åŒ–ï¼šãƒ€ãƒ–ãƒ«ã‚’ã¡ã‚ƒã‚“ã¨æ‰±ã†ï¼‰ ========= */
function rank(nums, posScore){
  return nums.map(n=>{
    let sc=0;
    const a = n.split("").map(Number);

    sc += (posScore.k[a[0]] ?? 0);
    sc += (posScore.h[a[1]] ?? 0);
    sc += (posScore.t[a[2]] ?? 0);
    sc += (posScore.o[a[3]] ?? 0);

    // è¶³ã™9ãƒ»é€£ç•ª
    for(let i=0;i<4;i++) for(let j=i+1;j<4;j++){
      if(a[i]+a[j]===9) sc += 2.2;
      if(Math.abs(a[i]-a[j])===1) sc += 1.4;
      if(Math.abs(a[i]-a[j])===2) sc += 0.9;
      // è£æ•°å­—ã®é–¢ä¿‚ã‚‚è»½ãåŠ ç‚¹
      if(ura[a[i]] === a[j]) sc += 1.0;
    }

    // ãƒ€ãƒ–ãƒ«/ãƒˆãƒªãƒ—ãƒ«ã‚’ã€Œã¡ã‚ƒã‚“ã¨ã€è©•ä¾¡
    const counts = Array(10).fill(0);
    a.forEach(x=>counts[x]++);
    const maxc = Math.max(...counts);
    if(maxc===2) sc += 2.0;   // ãƒ€ãƒ–ãƒ«
    if(maxc===3) sc += 3.2;   // ãƒˆãƒªãƒ—ãƒ«
    if(maxc===4) sc += 4.0;   // ã‚¾ãƒ­ç›®

    return { n, sc };
  }).sort((A,B)=>B.sc - A.sc);
}

function tierLabel(score, best){
  if(best <= 0) return { badge:"â˜…", label:"å¼±" };
  const r = score / best;
  if(r >= 0.92) return { badge:"â˜…â˜…â˜…", label:"å¼·" };
  if(r >= 0.86) return { badge:"â˜…â˜…",  label:"ä¸­" };
  return { badge:"â˜…",   label:"å¼±" };
}
function formatRows(rows){
  if(!rows || rows.length === 0) return "ï¼ˆãªã—ï¼‰";
  return rows.map(x => `${x.i}ä½  ${x.badge} [${x.label}]  ${x.num}`).join("\n");
}
function splitRanked(ranked, limit=10){
  if(!ranked || ranked.length === 0) return { main: [], ins: [], rows: [] };
  const best = ranked[0].sc;
  const rows = ranked.slice(0, limit).map((r, idx) => {
    const t = tierLabel(r.sc, best);
    return { i: idx+1, num: r.n, badge: t.badge, label: t.label, sc: r.sc };
  });
  return { rows, main: rows.filter(x=>x.label==="å¼·"), ins: rows.filter(x=>x.label!=="å¼·") };
}
function judgeDayPower(mainCount){
  if(mainCount >= 5) return "ğŸ”¥ ä»Šæ—¥ã¯å¼·ã„æ—¥ï¼ˆé›†ä¸­å‹è² ï¼‰";
  if(mainCount >= 3) return "â— æ™®é€šã®æ—¥ï¼ˆãƒãƒ©ãƒ³ã‚¹ï¼‰";
  return "â–³ åˆ†æ•£ã®æ—¥ï¼ˆç„¡ç†ã—ãªã„ï¼‰";
}

/* ========= ç”Ÿæˆï¼ˆæ—¢å­˜ã®æµã‚Œç¶­æŒï¼‰ ========= */
const STATE = {
  axis: "48",
  topStraightRows: [],
  topSetRows: [],
  straightMain: [],
  straightIns: [],
  setMain: [],
  setIns: [],
  posScore: { k:Array(10).fill(0), h:Array(10).fill(0), t:Array(10).fill(0), o:Array(10).fill(0) }
};

function generate(){
  injectIfNeeded();
  syncPrevFieldsFromHistory();

  const posScore = buildPositionScores();
  STATE.posScore = posScore;
  renderPosOut(posScore);

  const { all } = buildStats();
  const sAll = all.map(x=>x);

  const prevStr  = document.getElementById("prev").value;
  const prev2Str = document.getElementById("prev2").value;
  const h1raw = document.getElementById("hint1").value;
  const h2raw = document.getElementById("hint2").value;

  const h1_2 = pick2FromHint(h1raw, sAll, prevStr, prev2Str, h2raw);
  const h2_2 = pick2FromHint(h2raw, sAll, prevStr, prev2Str, h1raw);

  const axisArr = chooseAxisFromRaw(h1raw, h2raw, sAll);
  const axis = axisArr[0] + axisArr[1];
  STATE.axis = axis;

  const pool = buildPoolWeighted(h1_2, h2_2, sAll, posScore);

  const hist = loadHistory().join(",");
  const seedStr = h1raw + "|" + h2raw + "|" + prevStr + "|" + prev2Str + "|" + hist;
  const rand = mulberry32(hash32(seedStr));

  let list = [];
  while(list.length < 120){
    let n = [axisArr[0], axisArr[1]];
    while(n.length < 4) n.push(pick(pool, rand));
    list.push(n.join(""));
  }

  const uniqueList = uniq(list);
  const ranked = rank(uniqueList, posScore);
  const top10 = ranked.slice(0, 10);

  const sp = splitRanked(top10, 10);
  document.getElementById("dayPower").textContent = judgeDayPower(sp.main.length);
  document.getElementById("straightMain").textContent = formatRows(sp.main);
  document.getElementById("straightIns").textContent  = formatRows(sp.ins);

  // ã‚»ãƒƒãƒˆï¼ˆé †ä¸åŒï¼‰
  function setKey(num){ return num.split("").sort().join(""); }
  const setNums = uniq(top10.map(r => setKey(r.n)));
  const setRanked = setNums.map((x,idx)=>({n:x, sc:0})).map(o=>{
    // setã¯ç°¡æ˜“ï¼šè¶³ã™9/é€£ç•ª/ãƒ€ãƒ–ãƒ«å¯„ã‚Šã§ã‚¹ã‚³ã‚¢
    const a=o.n.split("").map(Number);
    let sc=0;
    for(let i=0;i<4;i++) for(let j=i+1;j<4;j++){
      if(a[i]+a[j]===9) sc += 2.2;
      if(Math.abs(a[i]-a[j])===1) sc += 1.4;
      if(Math.abs(a[i]-a[j])===2) sc += 0.9;
      if(ura[a[i]]===a[j]) sc += 1.0;
    }
    const counts=Array(10).fill(0); a.forEach(x=>counts[x]++);
    const maxc=Math.max(...counts);
    if(maxc===2) sc+=2.0;
    if(maxc===3) sc+=3.2;
    if(maxc===4) sc+=4.0;
    return { n:o.n, sc };
  }).sort((A,B)=>B.sc-A.sc).slice(0,10);

  const setSplit = splitRanked(setRanked, 10);
  document.getElementById("setMain").textContent = formatRows(setSplit.main);
  document.getElementById("setIns").textContent  = formatRows(setSplit.ins);

  STATE.topStraightRows = sp.rows;
  STATE.straightMain = sp.main;
  STATE.straightIns = sp.ins;
  STATE.topSetRows = setSplit.rows;
  STATE.setMain = setSplit.main;
  STATE.setIns = setSplit.ins;

  document.getElementById("judgeOut").innerHTML =
    `<span class="ok">ç”ŸæˆOK</span>ï¼ˆè»¸ <span class="mono">${STATE.axis}</span>ï¼‰  çµæœãŒå‡ºãŸã‚‰å½“é¸ç•ªå·ã‚’å…¥ã‚Œã¦ã€Œåˆ¤å®šã€ã—ã¦ã­ã€‚`;
  toast("è§£æâ†’ç”Ÿæˆ å®Œäº†");
}

/* ========= åˆ¤å®šï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼‹ã‚»ãƒƒãƒˆï¼‰ ========= */
function posMatch(a,b){ let c=0; for(let i=0;i<4;i++) if(a[i]===b[i]) c++; return c; }
function digitMatchCount(a,b){
  const ca=Array(10).fill(0), cb=Array(10).fill(0);
  for(const ch of a) ca[+ch]++; for(const ch of b) cb[+ch]++;
  let sum=0; for(let i=0;i<10;i++) sum += Math.min(ca[i], cb[i]);
  return sum;
}
function inGroup(num, rows){ return rows.find(r=>r.num===num) || null; }
function setKey(num){ return num.split("").sort().join(""); }

function judge(){
  const win = normalize4(document.getElementById("win").value);
  const out = document.getElementById("judgeOut");
  if(!win){ out.innerHTML = `<span class="warn">å½“é¸ç•ªå·ã¯4æ¡ã§å…¥ã‚Œã¦ã­</span>`; return; }
  if(!STATE.topStraightRows || STATE.topStraightRows.length===0){
    out.innerHTML = `<span class="warn">å…ˆã«ã€Œç•ªå·ã‚’ç”Ÿæˆã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ã­</span>`; return;
  }

  const axis = STATE.axis;
  const axisHit = (win.includes(axis[0]) && win.includes(axis[1])) || (win[0]+win[1]===axis);

  const sMainHit = inGroup(win, STATE.straightMain);
  const sInsHit  = inGroup(win, STATE.straightIns);
  const sAnyHit  = inGroup(win, STATE.topStraightRows);

  const winKey = setKey(win);
  const setMainHit = inGroup(winKey, STATE.setMain);
  const setInsHit  = inGroup(winKey, STATE.setIns);
  const setAnyHit  = inGroup(winKey, STATE.topSetRows);

  let bestPos=0, bestDigit=0;
  for(const r of STATE.topStraightRows){
    bestPos = Math.max(bestPos, posMatch(win, r.num));
    bestDigit = Math.max(bestDigit, digitMatchCount(win, r.num));
  }

  let headline="";
  let detail=[];

  if(sMainHit || setMainHit) headline="ğŸ”¥ æ¿€ã‚¢ãƒ„ï¼ˆèª­ã¿ãŒå°„ç¨‹åœï¼‰";
  else if(sInsHit || setInsHit) headline="â— æƒœã—ã„ï¼ˆæµã‚Œã¯åˆã£ã¦ã‚‹ï¼‰";
  else if(sAnyHit || setAnyHit || bestPos>=3) headline="â—‹ æµã‚ŒOKï¼ˆã‚ã¨ä¸€æ­©ï¼‰";
  else if(bestDigit>=2 || axisHit) headline="â–³ åˆ†æ•£ã®æ—¥ï¼ˆç„¡ç†ã—ãªã„ï¼‰";
  else headline="Ã— ã‚ºãƒ¬ï¼ˆä»Šæ—¥ã¯æµã‚Œé•ã„ï¼‰";

  detail.push(`å½“é¸ï¼š<span class="mono">${win}</span>`);
  detail.push(`è»¸ï¼š<span class="mono">${axis}</span>ã€€/ã€€è»¸ä¸€è‡´ï¼š<span class="${axisHit?'ok':'warn'}">${axisHit?'â—‹':'Ã—'}</span>`);

  if(sMainHit) detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼š<span class="ok">æœ¬å‘½ï¼ˆå¼·ï¼‰</span>ã€€${sMainHit.i}ä½`);
  else if(sInsHit) detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼š<span class="ok">ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</span>ã€€${sInsHit.i}ä½`);
  else if(sAnyHit) detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼š<span class="ok">åœå†…</span>ã€€${sAnyHit.i}ä½`);
  else detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼šåœå¤–ï¼ˆè¿‘ã•ï¼šä½ç½®ä¸€è‡´max ${bestPos}/4ã€æ•°å­—ä¸€è‡´max ${bestDigit}/4ï¼‰`);

  if(setMainHit) detail.push(`ã‚»ãƒƒãƒˆï¼š<span class="ok">æœ¬å‘½ï¼ˆå¼·ï¼‰</span>ã€€${setMainHit.i}ä½ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
  else if(setInsHit) detail.push(`ã‚»ãƒƒãƒˆï¼š<span class="ok">ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</span>ã€€${setInsHit.i}ä½ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
  else if(setAnyHit) detail.push(`ã‚»ãƒƒãƒˆï¼š<span class="ok">åœå†…</span>ã€€${setAnyHit.i}ä½ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
  else detail.push(`ã‚»ãƒƒãƒˆï¼šåœå¤–ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);

  out.innerHTML =
    `<div class="mono" style="font-size:18px;font-weight:1000;">${headline}</div>` +
    `<div class="mono" style="margin-top:8px;line-height:1.7">${detail.map(x=>`ãƒ»${x}`).join("<br>")}</div>`;
}

/* ========= ãªã£ã¡ã‚ƒã‚“æ–¹å¼ï¼ˆç”»åƒUIå†ç¾ï¼‰ ========= */
let N_TAB = "zure"; // default
let REH_POLICY_EXCLUDE = true; // æ—¢å®šï¼šé™¤å¤–ONï¼ˆã‚†ã†ã¡ã‚ƒã‚“æ–¹é‡ï¼‰

function openNacchan(){
  injectIfNeeded();
  rebuildNacchanPicker();
  document.getElementById("nBack").classList.add("show");
  setNTab("zure");
  // å…¥åŠ›åˆæœŸå€¤ï¼ˆãƒšãƒ¼ã‚¸ã®ãƒªãƒæ¬„ã‚’ã‚³ãƒ”ãƒ¼ï¼‰
  const r = normalize4(document.getElementById("rehearsal").value);
  document.getElementById("nReh").value = r || "";
  updateRehPolicyPill();
  updateNMeta();
  runNacchan(); // é–‹ã„ãŸã‚‰å³è§£æï¼ˆãƒ‡ãƒ¼ã‚¿ä¸è¶³ã‚’è¦‹ã›ãªã„ï¼‰
}
function closeNacchan(){ document.getElementById("nBack").classList.remove("show"); }

function setNTab(t){
  N_TAB = t;
  document.getElementById("tabBasic").classList.toggle("active", t==="basic");
  document.getElementById("tabZure").classList.toggle("active", t==="zure");
  document.getElementById("paneBasic").style.display = (t==="basic") ? "block":"none";
  document.getElementById("paneZure").style.display  = (t==="zure")  ? "block":"none";
}

function toggleRehPolicy(){
  REH_POLICY_EXCLUDE = !REH_POLICY_EXCLUDE;
  updateRehPolicyPill();
  runNacchan();
}
function updateRehPolicyPill(){
  const el = document.getElementById("rehPolicyPill");
  el.textContent = REH_POLICY_EXCLUDE ? "é™¤å¤–ON" : "é™¤å¤–OFF";
}

function rebuildNacchanPicker(){
  const hist = loadHistory();
  const sel = document.getElementById("nPick");
  sel.innerHTML = "";

  // å›å·ã‚‚å‡ºã—ãŸã„ã‘ã©ã€å±¥æ­´è‡ªä½“ã¯ç•ªå·ã—ã‹ä¿å­˜ã—ã¦ãªã„ã®ã§
  // å†…è”µãƒ‡ãƒ¼ã‚¿ã®å›å·é…åˆ—ï¼ˆå¯èƒ½ãªç¯„å›²ï¼‰ã‚’ä½¿ã£ã¦ã€Œè¦‹ãŸç›®ã ã‘ã€å›å·ã‚’è¡¨ç¤ºã€‚
  const built = parseBuiltin();
  const mapNumToDraw = new Map();
  for(const x of built){
    if(!mapNumToDraw.has(x.num)) mapNumToDraw.set(x.num, x.draw);
  }

  // æœ€æ–°ã‹ã‚‰æœ€å¤§120ä»¶ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ï¼ˆUIç”¨ãƒ»ãƒ‡ãƒ¼ã‚¿ã¯å†…éƒ¨ï¼‰
  const maxShow = Math.min(120, hist.length);
  for(let i=0;i<maxShow;i++){
    const n = hist[i];
    const draw = mapNumToDraw.get(n);
    const label = draw ? `ç¬¬${draw}å›  ${n}` : `å±¥æ­´${i+1}  ${n}`;
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = label;
    sel.appendChild(opt);
  }

  // ä¿å­˜ãƒ—ãƒªã‚»ãƒƒãƒˆãŒã‚ã‚Œã°é¸æŠå¾©å…ƒ
  try{
    const raw = localStorage.getItem(LS_NACCHAN);
    if(raw){
      const p = JSON.parse(raw);
      if(p && Number.isFinite(p.pickIndex)){
        sel.value = String(Math.min(maxShow-1, Math.max(0,p.pickIndex)));
      }
      if(p && typeof p.reh === "string"){
        document.getElementById("nReh").value = p.reh;
      }
      if(p && typeof p.rehExclude === "boolean"){
        REH_POLICY_EXCLUDE = p.rehExclude;
        updateRehPolicyPill();
      }
    }
  }catch(e){}
  sel.onchange = ()=>{ updateNMeta(); runNacchan(); };
}

function saveNacchanPreset(){
  const pickIndex = Number(document.getElementById("nPick").value || "0");
  const reh = normalize4(document.getElementById("nReh").value) || "";
  localStorage.setItem(LS_NACCHAN, JSON.stringify({ pickIndex, reh, rehExclude: REH_POLICY_EXCLUDE }));
  toast("ãªã£ã¡ã‚ƒã‚“æ–¹å¼ï¼šä¿å­˜ã—ãŸã‚ˆ");
}

function updateNMeta(){
  const hist = loadHistory();
  const idx = Number(document.getElementById("nPick").value || "0");
  const prev = hist[idx] || "";
  const prev2 = hist[idx+1] || "";
  document.getElementById("nMeta").textContent = `éå»å±¥æ­´ï¼šå‰å›=${prev || "â€”"} / å‰ã€…å›=${prev2 || "â€”"}ï¼ˆå†…éƒ¨300å›ï¼‰`;
}

function hotDigitByPos(posKey){
  const { pos } = buildStats();
  const arr = pos[posKey].slice();
  const idx = [...Array(10)].map((_,d)=>d).sort((a,b)=>arr[b]-arr[a]);
  return idx[0];
}

function runNacchan(){
  injectIfNeeded();
  const hist = loadHistory();
  if(hist.length < 20){
    // ã“ã“ã¯æœ¬å½“ã«ä¸è¶³ã®æ™‚ã ã‘
    toast("å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã™ãã‚‹â€¦å†æ³¨å…¥ã—ã¦ã­");
    return;
  }

  // é¸æŠã—ãŸå±¥æ­´ã‚’å‰å›æ‰±ã„ï¼ˆç”»åƒã«åˆã‚ã›ã‚‹ï¼‰
  const pickIndex = Number(document.getElementById("nPick").value || "0");
  const prev = hist[pickIndex] || hist[0];
  const prev2 = hist[pickIndex+1] || hist[1];

  // ç”»é¢ä¸Šã® prev/prev2 ã‚‚åŒæœŸï¼ˆæ—¢å­˜å´ã«ã‚‚åŠ¹ã‹ã›ã‚‹ï¼‰
  document.getElementById("prev").value = prev || "";
  document.getElementById("prev2").value = prev2 || "";

  const reh = normalize4(document.getElementById("nReh").value);

  // 18æ™‚ã‚®ãƒªã‚®ãƒªã®ãƒªãƒã¯ä½¿ã‚ãªã„ï¼ˆæ—¢å®šï¼‰
  const useReh = !!reh && !REH_POLICY_EXCLUDE;

  // è¡¨ï¼šæœ€æ–°ãƒªãƒ
  const rehDigits = reh ? reh.split("").map(Number) : [null,null,null,null];
  const keys = ["k","h","t","o"];
  const ids = ["z_k","z_h","z_t","z_o"];
  for(let i=0;i<4;i++){
    document.getElementById(ids[i]).textContent = rehDigits[i]===null ? "â€”" : String(rehDigits[i]);
  }

  // è¡¨ï¼šÂ±1
  const idsPm1 = ["z_k_pm1","z_h_pm1","z_t_pm1","z_o_pm1"];
  for(let i=0;i<4;i++){
    if(rehDigits[i]===null) document.getElementById(idsPm1[i]).textContent = "â€”";
    else{
      const a = plus1(rehDigits[i]).sort((x,y)=>x-y);
      document.getElementById(idsPm1[i]).textContent = `${a[0]},${a[1]}`;
    }
  }

  // è¡¨ï¼šãƒ›ãƒƒãƒˆç•ªï¼ˆä½åˆ¥ï¼‰
  const hot = {
    k: hotDigitByPos("k"),
    h: hotDigitByPos("h"),
    t: hotDigitByPos("t"),
    o: hotDigitByPos("o")
  };
  document.getElementById("z_k_hot").textContent = String(hot.k);
  document.getElementById("z_h_hot").textContent = String(hot.h);
  document.getElementById("z_t_hot").textContent = String(hot.t);
  document.getElementById("z_o_hot").textContent = String(hot.o);

  // ã‚ºãƒ¬è§£æï¼šå€™è£œç”Ÿæˆï¼ˆ10å£ï¼‰
  const posScore = buildPositionScores();
  const { lastSeen, trans } = buildStats();

  // åŸºæœ¬ãƒ—ãƒ¼ãƒ«ï¼šé·ç§»ï¼ˆprevã®å„ä½ã‹ã‚‰å‡ºã‚„ã™ã„ï¼‰ï¼‹ãƒ›ãƒƒãƒˆï¼‹ï¼ˆrehã®ã‚ºãƒ¬/è£/Â±2ï¼‰
  const prevDigits = prev.split("").map(Number);
  const rehSet = { k:new Set(), h:new Set(), t:new Set(), o:new Set() };

  function addToSet(set, d){ if(d===null || d===undefined) return; set.add(Number(d)); }

  // rehç”±æ¥ï¼ˆä½¿ã†å ´åˆã®ã¿ï¼‰
  if(useReh && rehDigits.every(x=>Number.isFinite(x))){
    const R = rehDigits;
    addToSet(rehSet.k, R[0]); addToSet(rehSet.h, R[1]); addToSet(rehSet.t, R[2]); addToSet(rehSet.o, R[3]);
    for(let i=0;i<4;i++){
      const d = R[i];
      const key = keys[i];
      plus1(d).forEach(x=>addToSet(rehSet[key], x));
      plus2(d).forEach(x=>addToSet(rehSet[key], x));
      addToSet(rehSet[key], ura[d]);
    }
  }

  // é·ç§»ä¸Šä½ï¼ˆprevâ†’nextï¼‰ã‚’ä½åˆ¥ã«ä¸Šä½3ã¤
  function topTrans(key, fromDigit, n=3){
    const row = trans[key][fromDigit].slice();
    const idx = [...Array(10)].map((_,d)=>d).sort((a,b)=>row[b]-row[a]);
    return idx.slice(0,n);
  }

  const transTop = {
    k: topTrans("k", prevDigits[0], 3),
    h: topTrans("h", prevDigits[1], 3),
    t: topTrans("t", prevDigits[2], 3),
    o: topTrans("o", prevDigits[3], 3),
  };

  // æœ€çµ‚å€™è£œã‚»ãƒƒãƒˆï¼ˆä½åˆ¥ï¼‰
  const cand = { k:new Set(), h:new Set(), t:new Set(), o:new Set() };
  for(const key of keys){
    // ãƒ›ãƒƒãƒˆ
    addToSet(cand[key], hot[key]);
    // é·ç§»
    transTop[key].forEach(x=>addToSet(cand[key], x));
    // rehã‚ºãƒ¬
    rehSet[key].forEach(x=>addToSet(cand[key], x));
    // ä½åˆ¥ã‚¹ã‚³ã‚¢ä¸Šä½ã‚‚2ã¤
    top4FromScores(posScore[key]).slice(0,2).forEach(x=>addToSet(cand[key], x.d));
  }

  // ã‚¹ã‚³ã‚¢ï¼šä½åˆ¥ã‚¹ã‚³ã‚¢ + é·ç§»ä¸€è‡´ + å‡ºç¾é–“éš” + rehã‚ºãƒ¬ä¸€è‡´ + ãƒ€ãƒ–ãƒ«å‚¾å‘
  function scoreNum(num){
    const a = num.split("").map(Number);
    let sc = 0;

    sc += (posScore.k[a[0]] ?? 0);
    sc += (posScore.h[a[1]] ?? 0);
    sc += (posScore.t[a[2]] ?? 0);
    sc += (posScore.o[a[3]] ?? 0);

    // é·ç§»ä¸€è‡´
    sc += trans.k[prevDigits[0]][a[0]] * 0.8;
    sc += trans.h[prevDigits[1]][a[1]] * 0.8;
    sc += trans.t[prevDigits[2]][a[2]] * 0.8;
    sc += trans.o[prevDigits[3]][a[3]] * 0.8;

    // å‡ºç¾é–“éš”ï¼ˆç©ºã„ã¦ã‚‹ã»ã©å°‘ã—åŠ ç‚¹ï¼‰
    const gap = (key, d) => {
      const ls = lastSeen[key][d];
      if(ls === null) return 1.1;
      if(ls >= 20) return Math.min(1.8, (ls-18)*0.08);
      return 0;
    };
    sc += gap("k",a[0]) + gap("h",a[1]) + gap("t",a[2]) + gap("o",a[3]);

    // rehã‚ºãƒ¬ä¸€è‡´ï¼ˆä½¿ã†å ´åˆï¼‰
    if(useReh && rehDigits[0]!==null){
      if(rehSet.k.has(a[0])) sc += 2.2;
      if(rehSet.h.has(a[1])) sc += 2.2;
      if(rehSet.t.has(a[2])) sc += 2.2;
      if(rehSet.o.has(a[3])) sc += 2.2;
    }

    // è¶³ã™9ãƒ»é€£ç•ªãƒ»è£ãƒ»Â±2
    for(let i=0;i<4;i++) for(let j=i+1;j<4;j++){
      if(a[i]+a[j]===9) sc += 1.8;
      if(Math.abs(a[i]-a[j])===1) sc += 1.1;
      if(Math.abs(a[i]-a[j])===2) sc += 0.8;
      if(ura[a[i]]===a[j]) sc += 0.9;
    }

    // ãƒ€ãƒ–ãƒ«/ãƒˆãƒªãƒ—ãƒ«
    const counts=Array(10).fill(0); a.forEach(x=>counts[x]++);
    const maxc=Math.max(...counts);
    if(maxc===2) sc += 1.8;
    if(maxc===3) sc += 3.0;
    if(maxc===4) sc += 4.0;

    // ã€Œå®Œå…¨åŒä¸€ã€ã¯æŠ¼ã—ä¸Šã’ãªã„ï¼ˆåŒã˜æ•°å­—ãŒç¶šãå¯èƒ½æ€§ã¯ã‚ã‚‹ãŒã€é·ç§»é‡è¦–ã§éå‰°ã«å„ªå…ˆã—ãªã„ï¼‰
    if(num === prev) sc -= 1.0;

    return sc;
  }

  // å…¨çµ„ã¿åˆã‚ã›ã¯å¤šã„ã®ã§ã€å€™è£œã‚»ãƒƒãƒˆã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã—ã¦ä¸Šä½ã‚’æ‹¾ã†
  const seed = hash32(prev + "|" + prev2 + "|" + (reh||"") + "|" + String(useReh));
  const rand = mulberry32(seed);

  const kArr=[...cand.k], hArr=[...cand.h], tArr=[...cand.t], oArr=[...cand.o];
  if(kArr.length===0 || hArr.length===0 || tArr.length===0 || oArr.length===0){
    toast("å€™è£œç”Ÿæˆã«å¤±æ•—â€¦ï¼ˆå†æ³¨å…¥ã—ã¦ã­ï¼‰");
    return;
  }

  const sampled = new Set();
  const list = [];
  const LIMIT = 900; // ååˆ†ã«ä¸Šä½ã‚’æ‹¾ãˆã‚‹
  while(list.length < LIMIT){
    const num = String(pick(kArr,rand))+String(pick(hArr,rand))+String(pick(tArr,rand))+String(pick(oArr,rand));
    if(sampled.has(num)) continue;
    sampled.add(num);
    list.push(num);
  }

  const ranked = list.map(n=>({n, sc: scoreNum(n)})).sort((a,b)=>b.sc-a.sc).slice(0,10);

  // UIï¼š10å£ã‚«ãƒ¼ãƒ‰
  const box = document.getElementById("nTop10");
  box.innerHTML = "";
  ranked.forEach((r,idx)=>{
    const el = document.createElement("div");
    el.className = "cardNum";
    el.innerHTML = `
      <div>
        <div class="rankNo">#${idx+1}</div>
        <div class="numBig mono">${r.n}</div>
      </div>
      <div class="scoreSmall">score<br><span class="mono">${(Math.round(r.sc*10)/10).toFixed(1)}</span></div>
    `;
    box.appendChild(el);
  });

  updateNMeta();
}

/* ========= ç«¯æœ«å†…ãƒ‡ãƒ¼ã‚¿å…¨æ¶ˆå»ï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰ ========= */
function clearAllLocal(){
  localStorage.removeItem(LS_KEY);
  localStorage.removeItem(LS_META);
  localStorage.removeItem(LS_NACCHAN);
  toast("ç«¯æœ«å†…ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ãŸã‚ˆï¼ˆå†æ³¨å…¥ã—ã¦å¾©æ—§OKï¼‰");
  syncPrevFieldsFromHistory();
  rebuildNacchanPicker();
}

/* ========= åˆæœŸåŒ– ========= */
(function init(){
  injectIfNeeded();               // â† ã“ã‚Œã§ã€Œãƒ‡ãƒ¼ã‚¿ä¸è¶³ã€ã«ãªã‚‰ãªã„
  syncPrevFieldsFromHistory();
  rebuildNacchanPicker();

  const hist = loadHistory();
  if(hist.length >= 20){
    const posScore = buildPositionScores();
    STATE.posScore = posScore;
    renderPosOut(posScore);
  }
})();
</script>
</body>
</html>
