<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒŠãƒ³ãƒãƒ¼ã‚º4 å®Œæˆç‰ˆï¼ˆ300å›å†…è”µãƒ»è§£æå¼·åŒ–ï¼‰</title>
  <style>
    body{font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;padding:16px;max-width:860px;margin:auto}
    h1{font-size:34px;margin:10px 0 18px}
    input,button{font-size:16px;padding:12px;width:100%;box-sizing:border-box;margin:8px 0;border-radius:14px;border:1px solid #e5e5e5}
    button{background:#111;color:#fff;border:none;border-radius:999px;padding:16px;font-weight:900}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap}
    .btnRow button{width:auto;flex:1;min-width:200px}
    .box{background:#fafafa;border:1px solid #eee;border-radius:16px;padding:14px;margin-top:12px}
    .label{font-weight:900;margin-top:6px}
    pre{white-space:pre-wrap;background:#f7f7f7;border-radius:14px;padding:12px;border:1px solid #eee}
    .day{font-weight:900;margin:8px 0 0}
    .note{color:#666;font-size:12px;margin-top:6px;line-height:1.5}
    h2{margin-top:22px}
    h3{margin:12px 0 6px}
    .resultBox{background:#fff;border:1px solid #eee;border-radius:16px;padding:14px;margin-top:12px}
    .big{font-size:18px;font-weight:900}
    .ok{color:#0a7;font-weight:900}
    .warn{color:#b00020;font-weight:900}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}

    /* ä½åˆ¥ãƒ‘ãƒãƒ« */
    .posGrid{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .posCard{
      border:3px solid #111;
      border-radius:18px;
      padding:12px;
      background:#fff;
      flex:1;
      min-width:170px;
    }
    .posTitle{
      font-weight:1000;
      font-size:18px;
      margin-bottom:8px;
    }
    .posRow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      padding:10px 0;
      border-bottom:1px solid #eee;
    }
    .posRow:last-child{border-bottom:none}
    .posNum{
      font-size:42px;
      font-weight:1000;
      line-height:1;
    }
    .posScore{
      color:#666;
      font-weight:900;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#111;
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease;
      z-index:9999;
      max-width:92vw;
      text-align:center;
    }
    .toast.show{opacity:0.95}
  </style>
</head>
<body>

  <h1>ãƒŠãƒ³ãƒãƒ¼ã‚º4 å®Œæˆç‰ˆï¼ˆ300å›å†…è”µãƒ»è§£æå¼·åŒ–ï¼‰</h1>

  <!-- ä¿å­˜ï¼†ç”Ÿæˆ -->
  <div class="box">
    <div class="label">ãƒ’ãƒ³ãƒˆ1ï¼ˆä¾‹ï¼š168 / 1ãƒ»6ãƒ»8ï¼‰</div>
    <input id="hint1" inputmode="numeric" placeholder="ãƒ’ãƒ³ãƒˆ1 ä¾‹ï¼š168">

    <div class="label">ãƒ’ãƒ³ãƒˆ2ï¼ˆä¾‹ï¼š3920 / 3ãƒ»9ãƒ»2ãƒ»0ï¼‰</div>
    <input id="hint2" inputmode="numeric" placeholder="ãƒ’ãƒ³ãƒˆ2 ä¾‹ï¼š3920">

    <div class="label">å‰å›ï¼ˆè‡ªå‹•ï¼‰</div>
    <input id="prev" inputmode="numeric" placeholder="å‰å› ä¾‹ï¼š5105" maxlength="4">

    <div class="label">å‰ã€…å›ï¼ˆè‡ªå‹•ï¼‰</div>
    <input id="prev2" inputmode="numeric" placeholder="å‰ã€…å› ä¾‹ï¼š4588" maxlength="4">

    <div class="label">ä»Šå›ã®æŠ½é¸çµæœï¼ˆä¿å­˜ç”¨ãƒ»4æ¡ï¼‰</div>
    <input id="saveWin" inputmode="numeric" placeholder="ä¾‹ï¼š9827" maxlength="4">

    <div class="note">
      âœ… ã€Œç›´è¿‘10å›ã€å…¥åŠ›æ¬„ã¯å»ƒæ­¢ï¼ˆå†…éƒ¨300å›ï¼‹ä¿å­˜å±¥æ­´ã ã‘ã§è§£æï¼‰<br>
      âœ… <strong>ä¿å­˜ãƒœã‚¿ãƒ³</strong>ã§ã€Œä»Šå›â†’å‰å›ã€ã€Œå‰å›â†’å‰ã€…å›ã€ã‚’è‡ªå‹•æ›´æ–°ï¼ˆå…¥åŠ›ã®æ‰‹é–“ã‚¼ãƒ­ï¼‰<br>
      âœ… åˆå›èµ·å‹•æ™‚ã¯ã€<strong>ç¬¬6909å›ã€œç¬¬6609å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å†…è”µ</strong>ï¼ˆè¡¨ã«ã¯ä¸€åˆ‡å‡ºã•ãªã„ï¼‰<br>
      âœ… ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«å†…ï¼ˆlocalStorageï¼‰ã«æœ€å¤§<strong>300å›</strong>ä¿æŒï¼ˆè¦‹ãˆãªã„ï¼‰<br>
      â€»18æ™‚ã‚®ãƒªã‚®ãƒªã®ãƒªãƒãƒ¼ã‚µãƒ«æ•°å­—ã¯å…¥ã‚Œãªã„ï¼ˆã‚†ã†ã¡ã‚ƒã‚“æ–¹é‡ï¼‰
    </div>

    <div class="btnRow">
      <button type="button" onclick="saveDraw()">ğŸ“© æŠ½é¸çµæœã‚’ä¿å­˜</button>
      <button type="button" onclick="generate()">ğŸ”® è§£æã—ã¦ç•ªå·ã‚’ç”Ÿæˆ</button>
    </div>
  </div>

  <!-- ä½åˆ¥ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆè§£æ -->
  <div class="resultBox">
    <div class="label">ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆäºˆæƒ³ï¼ˆä½åˆ¥4å€™è£œ / å†…éƒ¨300å›ï¼‹é·ç§»ï¼‹å‡ºç¾é–“éš”ï¼‹ãƒŠãƒ³ã¡ã‚ƒã‚“åŠ ç‚¹ï¼‰</div>
    <div class="note">
      ãƒ»åƒ/ç™¾/å/ä¸€ã§ã€Œåˆ¥ã®ã‚¹ã‚³ã‚¢ã€ã‚’ä½œã‚‹ï¼ˆå…¨ä½åŒã˜ä¸¦ã³ã«ã¯ã—ãªã„ï¼‰<br>
      ãƒ»å†…è”µ300å›ï¼‹ä¿å­˜å±¥æ­´ã‹ã‚‰ã€<strong>ä½åˆ¥é »åº¦ãƒ»ç›´è¿‘é‡ã¿ãƒ»å‡ºç¾é–“éš”ãƒ»é·ç§»ï¼ˆæ¬¡ã«æ¥ã‚„ã™ã„ï¼‰</strong>ã‚’åˆæˆ<br>
      ãƒ»<strong>ãƒŠãƒ³ã¡ã‚ƒã‚“æ³•å‰‡</strong>ã¯è©•ä¾¡åŠ ç‚¹ã¨ã—ã¦å¸¸æ™‚ONï¼ˆè£/Â±1/Â±2/è¶³ã™9/é€£ç•ª/é¢¨è»Šï¼‰<br>
      ãƒ»å‰å›/å‰ã€…å›ã¯ã€Œå¼•ã£å¼µã‚Šã€ã¨ã—ã¦ã€é·ç§»ã¨ä½åˆ¥ã«åŠ ç‚¹
    </div>
    <div id="posOut" class="posGrid"></div>
  </div>

  <!-- åˆ¤å®š -->
  <div class="resultBox">
    <div class="label">å½“é¸ç•ªå·ï¼ˆçµæœãŒå‡ºãŸã‚‰ã“ã“ã«4æ¡ï¼‰</div>
    <input id="win" inputmode="numeric" placeholder="ä¾‹ï¼š7263" maxlength="4">
    <button type="button" onclick="judge()">çµæœã‚’åˆ¤å®šã™ã‚‹</button>

    <div id="judgeOut" class="mono" style="margin-top:10px;"></div>
    <div class="note">â€»åˆ¤å®šã¯ã€Œã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼‹ã‚»ãƒƒãƒˆã€ä¸¡æ–¹ã‚’è¦‹ã‚‹ï¼ˆã‚†ã†ã¡ã‚ƒã‚“æŒ‡å®šï¼‰</div>
  </div>

  <h2>ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</h2>
  <div id="dayPower" class="day"></div>

  <h3>æœ¬å‘½ï¼ˆå¼·ï¼‰</h3>
  <pre id="straightMain">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>

  <h3>ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</h3>
  <pre id="straightIns">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>

  <h2>ã‚»ãƒƒãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</h2>

  <h3>æœ¬å‘½ï¼ˆå¼·ï¼‰</h3>
  <pre id="setMain">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>

  <h3>ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</h3>
  <pre id="setIns">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>

  <div id="toast" class="toast"></div>

<script>
/***************************************************************
 * âœ… å›ºå®šä»•æ§˜ï¼ˆã‚†ã†ã¡ã‚ƒã‚“ï¼‰
 * - ãƒã‚§ãƒƒã‚¯é …ç›®ãªã—ï¼ˆå…¨éƒ¨å¸¸æ™‚ONï¼‰
 * - 56æœ¬å±•é–‹ãªã—ï¼ˆãƒœã‚¿ãƒ³ã‚‚æ©Ÿèƒ½ã‚‚ç„¡ã—ï¼‰
 * - ç›´è¿‘10å›å…¥åŠ›æ¬„ãªã—ï¼ˆå†…éƒ¨300å›ï¼‹ä¿å­˜ã§è§£æï¼‰
 * - ä¿å­˜ãƒœã‚¿ãƒ³ã§ prev/prev2 è‡ªå‹•æ›´æ–°
 * - ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼†ã‚»ãƒƒãƒˆï¼šãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå¼·/ä¸­/å¼± + â˜…ï¼‰
 * - åˆ¤å®šï¼šã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼‹ã‚»ãƒƒãƒˆä¸¡æ–¹
 * - è§£æï¼šè£æ•°å­—/è¶³ã™9/é€£ç•ª(Â±1,Â±2)/å¼•ã£å¼µã‚Š/ãƒ€ãƒ–ãƒ«ç³»/é¢¨è»Š/å‡ºç¾é–“éš”/é·ç§»/å¹³é‡å¼ï¼ˆç°¡æ˜“ï¼‰
 ***************************************************************/

  // ===== è£æ•°å­—ï¼ˆã‚†ã†ã¡ã‚ƒã‚“å®šç¾©ï¼‰=====
  const ura = {0:5,5:0,1:6,6:1,2:7,7:2,3:8,8:3,4:9,9:4};

  // ===== ãƒŠãƒ³ã¡ã‚ƒã‚“è£œåŠ©ï¼ˆÂ±1, Â±2ï¼‰=====
  const plus1 = (n)=>[(n+1)%10,(n+9)%10];
  const plus2 = (n)=>[(n+2)%10,(n+8)%10];

  // ===== localStorage keys =====
  const LS_KEY = "n4_history_300_v3"; // max 300, newest first, objects or strings

  // ===== çŠ¶æ…‹ä¿æŒï¼ˆåˆ¤å®šã§ä½¿ã†ï¼‰=====
  const STATE = {
    axis: "48",
    topStraightRows: [],
    topSetRows: [],
    straightMain: [],
    straightIns: [],
    setMain: [],
    setIns: [],
    posScore: { k:Array(10).fill(0), h:Array(10).fill(0), t:Array(10).fill(0), o:Array(10).fill(0) }
  };

  // ===== å†…è”µ300å›ï¼ˆè¡¨ã«å‡ºã•ãªã„ï¼‰=====
  // â€»æ›œæ—¥ãƒ»é‡‘é¡ã¯ç„¡è¦–ï¼ˆæŠ½å‡ºæ™‚ã«4æ¡ã ã‘æ‹¾ã†ï¼‰
  const BUILTIN_RAW = `
ç¬¬6909å›
9827
ç¬¬6908å›
6120
ç¬¬6907å›
4588
ç¬¬6906å›
ç«æ›œæ—¥
7964
764,500å††
ç¬¬6905å›
æœˆæ›œæ—¥
0176
758,400å††
ç¬¬6904å›
é‡‘æ›œæ—¥
0515
383,000å††
ç¬¬6903å›
æœ¨æ›œæ—¥
6022
356,500å††
ç¬¬6902å›
æ°´æ›œæ—¥
0615
502,100å††
ç¬¬6901å›
ç«æ›œæ—¥
9534
388,500å††
ç¬¬6900å›
æœˆæ›œæ—¥
8174
1,248,200å††
ç¬¬6899å›
é‡‘æ›œæ—¥
6436
1,194,200å††
ç¬¬6898å›
æœ¨æ›œæ—¥
8060
1,571,800å††
ç¬¬6897å›
æ°´æ›œæ—¥
2404
1,289,000å††
ç¬¬6896å›
ç«æ›œæ—¥
2699
1,040,700å††
ç¬¬6895å›
æœˆæ›œæ—¥
2827
870,900å††
ç¬¬6894å›
é‡‘æ›œæ—¥
6551
321,800å††
ç¬¬6893å›
æœ¨æ›œæ—¥
1632
693,500å††
ç¬¬6892å›
æ°´æ›œæ—¥
7263
280,800å††
ç¬¬6891å›
ç«æ›œæ—¥
2300
917,700å††
ç¬¬6890å›
æœˆæ›œæ—¥
7526
1,042,200å††
ç¬¬6889å›
ç«æ›œæ—¥
7202
442,000å††
ç¬¬6888å›
æœˆæ›œæ—¥
2121
182,000å††
ç¬¬6887å›
é‡‘æ›œæ—¥
4141
921,300å††
ç¬¬6886å›
æœ¨æ›œæ—¥
6333
434,000å††
ç¬¬6885å›
æ°´æ›œæ—¥
3984
795,000å††
ç¬¬6884å›
ç«æ›œæ—¥
3278
781,000å††
ç¬¬6883å›
æœˆæ›œæ—¥
9785
857,400å††
ç¬¬6882å›
é‡‘æ›œæ—¥
4944
796,700å††
ç¬¬6881å›
æœ¨æ›œæ—¥
5879
299,300å††
ç¬¬6880å›
æ°´æ›œæ—¥
0497
470,400å††
ç¬¬6879å›
ç«æ›œæ—¥
2310
691,400å††
ç¬¬6878å›
æœˆæ›œæ—¥
7221
749,100å††
ç¬¬6877å›
é‡‘æ›œæ—¥
2528
706,200å††
ç¬¬6876å›
æœ¨æ›œæ—¥
2208
1,040,900å††
ç¬¬6875å›
æ°´æ›œæ—¥
5272
494,500å††
ç¬¬6874å›
ç«æ›œæ—¥
3123
918,000å††
ç¬¬6873å›
æœˆæ›œæ—¥
3493
298,300å††
ç¬¬6872å›
é‡‘æ›œæ—¥
4784
820,100å††
ç¬¬6871å›
æœ¨æ›œæ—¥
5571
1,112,300å††
ç¬¬6870å›
æ°´æ›œæ—¥
7263
763,400å††
ç¬¬6869å›
ç«æ›œæ—¥
6936
839,700å††
ç¬¬6868å›
æœˆæ›œæ—¥
5396
940,800å††
ç¬¬6867å›
é‡‘æ›œæ—¥
3076
1,163,800å††
ç¬¬6866å›
æœ¨æ›œæ—¥
2803
854,200å††
ç¬¬6865å›
æ°´æ›œæ—¥
3324
992,500å††
ç¬¬6864å›
ç«æ›œæ—¥
5445
965,000å††
ç¬¬6863å›
æœˆæ›œæ—¥
1258
626,000å††
ç¬¬6862å›
é‡‘æ›œæ—¥
9741
968,500å††
ç¬¬6861å›
æœ¨æ›œæ—¥
4693
879,700å††
ç¬¬6860å›
æ°´æ›œæ—¥
5186
694,000å††
ç¬¬6859å›
ç«æ›œæ—¥
6444
1,646,800å††
ç¬¬6858å›
æœˆæ›œæ—¥
1184
969,400å††
ç¬¬6857å›
é‡‘æ›œæ—¥
3116
886,500å††
ç¬¬6856å›
æœ¨æ›œæ—¥
9991
411,600å††
ç¬¬6855å›
æ°´æ›œæ—¥
2123
670,800å††
ç¬¬6854å›
ç«æ›œæ—¥
3403
1,433,400å††
ç¬¬6853å›
æœˆæ›œæ—¥
6727
1,235,200å††
ç¬¬6852å›
é‡‘æ›œæ—¥
3049
926,900å††
ç¬¬6851å›
æœ¨æ›œæ—¥
2981
422,800å††
ç¬¬6850å›
æ°´æ›œæ—¥
5282
1,091,000å††
ç¬¬6849å›
ç«æ›œæ—¥
9227
1,303,300å††
ç¬¬6848å›
æœˆæ›œæ—¥
9275
943,500å††
ç¬¬6847å›
é‡‘æ›œæ—¥
0137
594,100å††
ç¬¬6846å›
æœ¨æ›œæ—¥
8726
927,400å††
ç¬¬6845å›
æ°´æ›œæ—¥
4714
388,700å††
ç¬¬6844å›
ç«æ›œæ—¥
0017
543,100å††
ç¬¬6843å›
æœˆæ›œæ—¥
0523
455,300å††
ç¬¬6842å›
é‡‘æ›œæ—¥
4591
762,200å††
ç¬¬6841å›
æœ¨æ›œæ—¥
8612
858,900å††
ç¬¬6840å›
æ°´æ›œæ—¥
2326
930,500å††
ç¬¬6839å›
ç«æ›œæ—¥
8607
766,400å††
ç¬¬6838å›
æœˆæ›œæ—¥
0100
736,200å††
ç¬¬6837å›
é‡‘æ›œæ—¥
5441
1,135,700å††
ç¬¬6836å›
æœ¨æ›œæ—¥
4325
1,081,700å††
ç¬¬6835å›
æ°´æ›œæ—¥
1350
760,000å††
ç¬¬6834å›
ç«æ›œæ—¥
4706
257,200å††
ç¬¬6833å›
æœˆæ›œæ—¥
6896
1,191,900å††
ç¬¬6832å›
é‡‘æ›œæ—¥
3148
834,100å††
ç¬¬6831å›
æœ¨æ›œæ—¥
6352
719,500å††
ç¬¬6830å›
æ°´æ›œæ—¥
0220
560,100å††
ç¬¬6829å›
ç«æ›œæ—¥
7717
1,025,500å††
ç¬¬6828å›
æœˆæ›œæ—¥
0933
1,154,500å††
ç¬¬6827å›
é‡‘æ›œæ—¥
2964
938,300å††
ç¬¬6826å›
æœ¨æ›œæ—¥
1916
652,700å††
ç¬¬6825å›
æ°´æ›œæ—¥
5280
317,700å††
ç¬¬6824å›
ç«æ›œæ—¥
7765
1,170,900å††
ç¬¬6823å›
æœˆæ›œæ—¥
0012
1,051,800å††
ç¬¬6822å›
é‡‘æ›œæ—¥
1540
511,200å††
ç¬¬6821å›
æœ¨æ›œæ—¥
7728
930,500å††
ç¬¬6820å›
æ°´æ›œæ—¥
2477
727,300å††
ç¬¬6819å›
ç«æ›œæ—¥
4787
1,117,600å††
ç¬¬6818å›
æœˆæ›œæ—¥
5808
1,371,100å††
ç¬¬6817å›
é‡‘æ›œæ—¥
8721
494,500å††
ç¬¬6816å›
æœ¨æ›œæ—¥
6152
853,700å††
ç¬¬6815å›
æ°´æ›œæ—¥
7604
1,393,200å††
ç¬¬6814å›
ç«æ›œæ—¥
1314
686,700å††
ç¬¬6813å›
æœˆæ›œæ—¥
6867
1,364,800å††
ç¬¬6812å›
é‡‘æ›œæ—¥
8991
813,500å††
ç¬¬6811å›
æœ¨æ›œæ—¥
7961
587,400å††
ç¬¬6810å›
æ°´æ›œæ—¥
2679
900,600å††
ç¬¬6809å›
ç«æ›œæ—¥
5260
762,700å††
ç¬¬6808å›
æœˆæ›œæ—¥
2841
847,700å††
ç¬¬6807å›
é‡‘æ›œæ—¥
1871
1,050,100å††
ç¬¬6806å›
æœ¨æ›œæ—¥
3376
366,600å††
ç¬¬6805å›
æ°´æ›œæ—¥
4598
868,700å††
ç¬¬6804å›
ç«æ›œæ—¥
0538
782,500å††
ç¬¬6803å›
æœˆæ›œæ—¥
0549
1,246,400å††
ç¬¬6802å›
é‡‘æ›œæ—¥
1929
854,300å††
ç¬¬6801å›
æœ¨æ›œæ—¥
0774
425,500å††
ç¬¬6800å›
æ°´æ›œæ—¥
6694
1,004,600å††
ç¬¬6799å›
ç«æ›œæ—¥
1624
756,300å††
ç¬¬6798å›
æœˆæ›œæ—¥
9463
1,166,900å††
ç¬¬6797å›
é‡‘æ›œæ—¥
9660
1,117,400å††
ç¬¬6796å›
æœ¨æ›œæ—¥
5806
1,105,500å††
ç¬¬6795å›
æ°´æ›œæ—¥
8749
1,119,300å††
ç¬¬6794å›
ç«æ›œæ—¥
9288
675,800å††
ç¬¬6793å›
æœˆæ›œæ—¥
9959
1,257,300å††
ç¬¬6792å›
é‡‘æ›œæ—¥
5140
989,600å††
ç¬¬6791å›
æœ¨æ›œæ—¥
6362
1,147,800å††
ç¬¬6790å›
æ°´æ›œæ—¥
5541
1,152,400å††
ç¬¬6789å›
ç«æ›œæ—¥
2458
652,900å††
ç¬¬6788å›
æœˆæ›œæ—¥
6014
908,200å††
ç¬¬6787å›
é‡‘æ›œæ—¥
1365
894,200å††
ç¬¬6786å›
æœ¨æ›œæ—¥
5835
991,200å††
ç¬¬6785å›
æ°´æ›œæ—¥
4876
624,600å††
ç¬¬6784å›
ç«æ›œæ—¥
1027
314,200å††
ç¬¬6783å›
æœˆæ›œæ—¥
3080
1,018,900å††
ç¬¬6782å›
é‡‘æ›œæ—¥
3497
1,034,500å††
ç¬¬6781å›
æœ¨æ›œæ—¥
0536
1,117,100å††
ç¬¬6780å›
æ°´æ›œæ—¥
3175
711,900å††
ç¬¬6779å›
ç«æ›œæ—¥
1592
881,400å††
ç¬¬6778å›
æœˆæ›œæ—¥
6710
1,217,500å††
ç¬¬6777å›
é‡‘æ›œæ—¥
5454
1,284,900å††
ç¬¬6776å›
æœ¨æ›œæ—¥
7924
785,700å††
ç¬¬6775å›
æ°´æ›œæ—¥
5493
1,274,100å††
ç¬¬6774å›
ç«æ›œæ—¥
8714
518,700å††
ç¬¬6773å›
æœˆæ›œæ—¥
7780
1,235,500å††
ç¬¬6772å›
é‡‘æ›œæ—¥
2460
818,400å††
ç¬¬6771å›
æœ¨æ›œæ—¥
2337
348,900å††
ç¬¬6770å›
æ°´æ›œæ—¥
2037
1,114,500å††
ç¬¬6769å›
ç«æ›œæ—¥
5552
776,900å††
ç¬¬6768å›
æœˆæ›œæ—¥
5295
1,068,100å††
ç¬¬6767å›
é‡‘æ›œæ—¥
0172
580,600å††
ç¬¬6766å›
æœ¨æ›œæ—¥
4790
858,200å††
ç¬¬6765å›
æ°´æ›œæ—¥
5358
789,600å††
ç¬¬6764å›
ç«æ›œæ—¥
2982
804,800å††
ç¬¬6763å›
æœˆæ›œæ—¥
9181
866,900å††
ç¬¬6762å›
é‡‘æ›œæ—¥
2452
1,060,400å††
ç¬¬6761å›
æœ¨æ›œæ—¥
1479
682,700å††
ç¬¬6760å›
æ°´æ›œæ—¥
3099
974,100å††
ç¬¬6759å›
ç«æ›œæ—¥
5261
1,013,100å††
ç¬¬6758å›
æœˆæ›œæ—¥
6757
1,367,400å††
ç¬¬6757å›
é‡‘æ›œæ—¥
2940
621,300å††
ç¬¬6756å›
æœ¨æ›œæ—¥
8622
741,700å††
ç¬¬6755å›
æ°´æ›œæ—¥
8174
1,074,000å††
ç¬¬6754å›
ç«æ›œæ—¥
1351
1,090,700å††
ç¬¬6753å›
æœˆæ›œæ—¥
4804
1,127,700å††
ç¬¬6752å›
é‡‘æ›œæ—¥
7102
849,000å††
ç¬¬6751å›
æœ¨æ›œæ—¥
5354
1,148,700å††
ç¬¬6750å›
æ°´æ›œæ—¥
7592
926,600å††
ç¬¬6749å›
ç«æ›œæ—¥
0975
1,475,200å††
ç¬¬6748å›
æœˆæ›œæ—¥
6326
613,300å††
ç¬¬6747å›
é‡‘æ›œæ—¥
2482
997,500å††
ç¬¬6746å›
æœ¨æ›œæ—¥
7666
1,277,300å††
ç¬¬6745å›
æ°´æ›œæ—¥
3176
951,000å††
ç¬¬6744å›
ç«æ›œæ—¥
3142
1,105,000å††
ç¬¬6743å›
æœˆæ›œæ—¥
5084
743,500å††
ç¬¬6742å›
é‡‘æ›œæ—¥
6563
666,600å††
ç¬¬6741å›
æœ¨æ›œæ—¥
9318
816,000å††
ç¬¬6740å›
æ°´æ›œæ—¥
5944
1,036,600å††
ç¬¬6739å›
ç«æ›œæ—¥
2370
1,077,900å††
ç¬¬6738å›
æœˆæ›œæ—¥
2839
805,100å††
ç¬¬6737å›
é‡‘æ›œæ—¥
7141
1,138,400å††
ç¬¬6736å›
æœ¨æ›œæ—¥
6779
1,101,500å††
ç¬¬6735å›
æ°´æ›œæ—¥
7357
737,600å††
ç¬¬6734å›
ç«æ›œæ—¥
3697
1,046,800å††
ç¬¬6733å›
æœˆæ›œæ—¥
9115
1,440,800å††
ç¬¬6732å›
é‡‘æ›œæ—¥
2718
597,800å††
ç¬¬6731å›
æœ¨æ›œæ—¥
9899
924,500å††
ç¬¬6730å›
æ°´æ›œæ—¥
2762
1,401,400å††
ç¬¬6729å›
ç«æ›œæ—¥
6418
719,700å††
ç¬¬6728å›
æœˆæ›œæ—¥
9601
859,400å††
ç¬¬6727å›
é‡‘æ›œæ—¥
4116
1,125,600å††
ç¬¬6726å›
æœ¨æ›œæ—¥
4368
510,000å††
ç¬¬6725å›
æ°´æ›œæ—¥
1898
733,200å††
ç¬¬6724å›
ç«æ›œæ—¥
9565
992,900å††
ç¬¬6723å›
æœˆæ›œæ—¥
8892
1,059,300å††
ç¬¬6722å›
é‡‘æ›œæ—¥
1883
877,100å††
ç¬¬6721å›
æœ¨æ›œæ—¥
8156
841,000å††
ç¬¬6720å›
æ°´æ›œæ—¥
1952
455,300å††
ç¬¬6719å›
ç«æ›œæ—¥
0081
935,000å††
ç¬¬6718å›
æœˆæ›œæ—¥
8391
868,200å††
ç¬¬6717å›
é‡‘æ›œæ—¥
2948
781,600å††
ç¬¬6716å›
æœ¨æ›œæ—¥
8968
946,100å††
ç¬¬6715å›
æ°´æ›œæ—¥
5323
810,900å††
ç¬¬6714å›
ç«æ›œæ—¥
3449
1,624,700å††
ç¬¬6713å›
æœˆæ›œæ—¥
1670
880,100å††
ç¬¬6712å›
é‡‘æ›œæ—¥
4071
1,053,000å††
ç¬¬6711å›
æœ¨æ›œæ—¥
9686
1,222,800å††
ç¬¬6710å›
æ°´æ›œæ—¥
7059
1,120,300å††
ç¬¬6709å›
ç«æ›œæ—¥
6697
1,511,400å††
ç¬¬6708å›
æœˆæ›œæ—¥
7834
952,600å††
ç¬¬6707å›
é‡‘æ›œæ—¥
4811
780,000å††
ç¬¬6706å›
æœ¨æ›œæ—¥
8842
999,500å††
ç¬¬6705å›
æ°´æ›œæ—¥
7555
1,241,300å††
ç¬¬6704å›
ç«æ›œæ—¥
2166
1,283,500å††
ç¬¬6703å›
æœˆæ›œæ—¥
1820
697,400å††
ç¬¬6702å›
é‡‘æ›œæ—¥
7011
576,300å††
ç¬¬6701å›
æœ¨æ›œæ—¥
7856
1,007,800å††
ç¬¬6700å›
æ°´æ›œæ—¥
4013
610,600å††
ç¬¬6699å›
ç«æ›œæ—¥
4417
700,900å††
ç¬¬6698å›
æœˆæ›œæ—¥
2078
870,700å††
ç¬¬6697å›
é‡‘æ›œæ—¥
9721
1,099,800å††
ç¬¬6696å›
æœ¨æ›œæ—¥
7892
1,370,300å††
ç¬¬6695å›
æ°´æ›œæ—¥
1695
1,162,400å††
ç¬¬6694å›
ç«æ›œæ—¥
3671
1,071,800å††
ç¬¬6693å›
æœˆæ›œæ—¥
8221
879,300å††
ç¬¬6692å›
é‡‘æ›œæ—¥
6185
770,900å††
ç¬¬6691å›
æœ¨æ›œæ—¥
0745
1,171,200å††
ç¬¬6690å›
æ°´æ›œæ—¥
8397
1,083,500å††
ç¬¬6689å›
ç«æ›œæ—¥
2191
383,200å††
ç¬¬6688å›
æœˆæ›œæ—¥
0488
1,386,200å††
ç¬¬6687å›
é‡‘æ›œæ—¥
1431
1,123,900å††
ç¬¬6686å›
æœ¨æ›œæ—¥
8555
829,700å††
ç¬¬6685å›
æ°´æ›œæ—¥
1087
838,400å††
ç¬¬6684å›
ç«æ›œæ—¥
9843
564,200å††
ç¬¬6683å›
æœˆæ›œæ—¥
7006
1,657,400å††
ç¬¬6682å›
é‡‘æ›œæ—¥
2853
709,600å††
ç¬¬6681å›
æœ¨æ›œæ—¥
0384
891,500å††
ç¬¬6680å›
æ°´æ›œæ—¥
9200
1,067,700å††
ç¬¬6679å›
ç«æ›œæ—¥
8261
1,030,900å††
ç¬¬6678å›
æœˆæ›œæ—¥
8256
863,300å††
ç¬¬6677å›
é‡‘æ›œæ—¥
0948
834,200å††
ç¬¬6676å›
æœ¨æ›œæ—¥
1781
818,500å††
ç¬¬6675å›
æ°´æ›œæ—¥
8194
917,500å††
ç¬¬6674å›
ç«æ›œæ—¥
6318
694,700å††
ç¬¬6673å›
æœˆæ›œæ—¥
1170
942,300å††
ç¬¬6672å›
é‡‘æ›œæ—¥
4968
807,400å††
ç¬¬6671å›
æœ¨æ›œæ—¥
3839
802,600å††
ç¬¬6670å›
æ°´æ›œæ—¥
0664
966,000å††
ç¬¬6669å›
ç«æ›œæ—¥
9378
1,106,400å††
ç¬¬6668å›
æœˆæ›œæ—¥
3026
865,900å††
ç¬¬6667å›
é‡‘æ›œæ—¥
6398
1,015,900å††
ç¬¬6666å›
æœ¨æ›œæ—¥
1890
818,800å††
ç¬¬6665å›
æ°´æ›œæ—¥
9265
1,018,000å††
ç¬¬6664å›
ç«æ›œæ—¥
0385
527,200å††
ç¬¬6663å›
æœˆæ›œæ—¥
6744
1,134,500å††
ç¬¬6662å›
é‡‘æ›œæ—¥
3273
1,069,800å††
ç¬¬6661å›
æœ¨æ›œæ—¥
1946
699,000å††
ç¬¬6660å›
æ°´æ›œæ—¥
3343
1,212,100å††
ç¬¬6659å›
ç«æ›œæ—¥
8942
1,273,400å††
ç¬¬6658å›
æœˆæ›œæ—¥
0859
1,502,000å††
ç¬¬6657å›
é‡‘æ›œæ—¥
3881
885,200å††
ç¬¬6656å›
æœ¨æ›œæ—¥
0853
654,100å††
ç¬¬6655å›
æ°´æ›œæ—¥
2317
630,000å††
ç¬¬6654å›
ç«æ›œæ—¥
4827
931,600å††
ç¬¬6653å›
æœˆæ›œæ—¥
0235
892,300å††
ç¬¬6652å›
é‡‘æ›œæ—¥
1596
872,400å††
ç¬¬6651å›
æœ¨æ›œæ—¥
5400
453,400å††
ç¬¬6650å›
æ°´æ›œæ—¥
9590
1,179,600å††
ç¬¬6649å›
ç«æ›œæ—¥
0893
297,600å††
ç¬¬6648å›
æœˆæ›œæ—¥
7240
323,600å††
ç¬¬6647å›
é‡‘æ›œæ—¥
2315
463,100å††
ç¬¬6646å›
æœ¨æ›œæ—¥
5420
969,900å††
ç¬¬6645å›
æ°´æ›œæ—¥
6385
701,000å††
ç¬¬6644å›
ç«æ›œæ—¥
8259
271,900å††
ç¬¬6643å›
æœˆæ›œæ—¥
4409
1,090,300å††
ç¬¬6642å›
é‡‘æ›œæ—¥
9774
345,800å††
ç¬¬6641å›
æœ¨æ›œæ—¥
2324
742,200å††
ç¬¬6640å›
æ°´æ›œæ—¥
1366
1,318,600å††
ç¬¬6639å›
ç«æ›œæ—¥
0135
933,900å††
ç¬¬6638å›
æœˆæ›œæ—¥
8583
587,700å††
ç¬¬6637å›
é‡‘æ›œæ—¥
1599
939,200å††
ç¬¬6636å›
æœ¨æ›œæ—¥
5802
316,000å††
ç¬¬6635å›
æ°´æ›œæ—¥
1786
566,800å††
ç¬¬6634å›
ç«æ›œæ—¥
3754
230,200å††
ç¬¬6633å›
æœˆæ›œæ—¥
0685
837,000å††
ç¬¬6632å›
æœˆæ›œæ—¥
9983
276,700å††
ç¬¬6631å›
é‡‘æ›œæ—¥
4386
983,800å††
ç¬¬6630å›
æœ¨æ›œæ—¥
4119
858,500å††
ç¬¬6629å›
æ°´æ›œæ—¥
0474
1,430,900å††
ç¬¬6628å›
ç«æ›œæ—¥
5231
927,600å††
ç¬¬6627å›
æœˆæ›œæ—¥
5892
439,000å††
ç¬¬6626å›
é‡‘æ›œæ—¥
0580
514,100å††
ç¬¬6625å›
æœ¨æ›œæ—¥
5214
921,300å††
ç¬¬6624å›
æ°´æ›œæ—¥
3498
999,000å††
ç¬¬6623å›
ç«æ›œæ—¥
0596
1,145,500å††
ç¬¬6622å›
æœˆæ›œæ—¥
3424
909,200å††
ç¬¬6621å›
é‡‘æ›œæ—¥
6199
887,900å††
ç¬¬6620å›
æœ¨æ›œæ—¥
9105
250,300å††
ç¬¬6619å›
æ°´æ›œæ—¥
6217
988,900å††
ç¬¬6618å›
ç«æ›œæ—¥
4259
1,031,900å††
ç¬¬6617å›
æœˆæ›œæ—¥
2617
564,900å††
ç¬¬6616å›
é‡‘æ›œæ—¥
8939
542,800å††
ç¬¬6615å›
æœ¨æ›œæ—¥
8253
919,900å††
ç¬¬6614å›
æ°´æ›œæ—¥
0000
211,400å††
ç¬¬6613å›
ç«æ›œæ—¥
1978
289,700å††
ç¬¬6612å›
æœˆæ›œæ—¥
3920
1,186,800å††
ç¬¬6611å›
é‡‘æ›œæ—¥
3212
465,900å††
ç¬¬6610å›
æœ¨æ›œæ—¥
4640
1,107,000å††
ç¬¬6609å›
æ°´æ›œæ—¥
8963
813,000å††
`;

  // ===== utils =====
  function digits(str){ return (str || "").match(/\d/g) || []; }
  function normalize4(str){
    const d = digits(str).slice(0,4);
    if(d.length !== 4) return null;
    return d.join("");
  }
  function toast(msg){
    const el = document.getElementById("toast");
    el.textContent = msg;
    el.classList.add("show");
    setTimeout(()=>el.classList.remove("show"), 1600);
  }
  function uniq(arr){
    const s = new Set(), out=[];
    for(const x of arr){ if(!s.has(x)){ s.add(x); out.push(x); } }
    return out;
  }

  // å›ºå®šä¹±æ•°ï¼ˆåŒå…¥åŠ›ã§ãƒ–ãƒ¬ãªã„ï¼‰
  function hash32(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }
  function mulberry32(seed){
    return function(){
      let t = seed += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }

  // ===== å†…è”µãƒ‡ãƒ¼ã‚¿æŠ½å‡ºï¼ˆå›å·â†’4æ¡ã€æ›œæ—¥/é‡‘é¡ã¯ç„¡è¦–ï¼‰=====
  function parseBuiltin(raw){
    const map = new Map(); // draw -> num
    const re = /ç¬¬(\d+)å›([\s\S]*?)(?=ç¬¬\d+å›|$)/g;
    let m;
    while((m = re.exec(raw))){
      const draw = Number(m[1]);
      const block = m[2] || "";
      // ãƒ–ãƒ­ãƒƒã‚¯å†…ã®ã€Œæœ€åˆã®4æ¡ã€ã‚’å½“é¸æ•°å­—ã¨ã—ã¦æ¡ç”¨
      const n = (block.match(/\b\d{4}\b/) || [])[0];
      const num = normalize4(n || "");
      if(num){
        // åŒã˜å›ãŒé‡è¤‡ã—ã¦ãŸã‚‰æœ€åˆã®ã‚„ã¤å„ªå…ˆï¼ˆä»Šå›ã®å…¥åŠ›ã¯ãã‚Œã§OKï¼‰
        if(!map.has(draw)) map.set(draw, num);
      }
    }
    // æœ€æ–°â†’å¤ã„
    const draws = [...map.keys()].sort((a,b)=>b-a);
    const out = draws.map(d => ({draw:d, num: map.get(d)}));
    return out;
  }

  const BUILTIN = parseBuiltin(BUILTIN_RAW);

  // ===== å±¥æ­´ãƒ­ãƒ¼ãƒ‰/ã‚»ãƒ¼ãƒ–ï¼ˆ300ä»¶ã€è¡¨ã«å‡ºã•ãªã„ï¼‰=====
  function loadHistory(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      const arr = raw ? JSON.parse(raw) : null;

      // åˆå›ï¼šå†…è”µãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
      if(!arr || !Array.isArray(arr) || arr.length === 0){
        const seeded = BUILTIN.slice(0); // æœ€æ–°â†’å¤ã„
        // é‡è¤‡ã‚’å‰Šã£ã¦300ä»¶ã«ä¸¸ã‚ã‚‹ï¼ˆå›å·é‡è¤‡ã®æ•‘æ¸ˆï¼‰
        const seenDraw = new Set();
        const seenNumSeq = [];
        const cleaned = [];
        for(const it of seeded){
          if(seenDraw.has(it.draw)) continue;
          seenDraw.add(it.draw);
          cleaned.push({draw: it.draw, num: it.num});
          if(cleaned.length >= 300) break;
        }
        localStorage.setItem(LS_KEY, JSON.stringify(cleaned));
        return cleaned;
      }

      // æ—¢å­˜ã‚ã‚Šï¼šæ—§å½¢å¼(æ–‡å­—åˆ—é…åˆ—)ã‚‚æ•‘æ¸ˆ
      const normalized = [];
      for(const it of arr){
        if(typeof it === "string"){
          const n = normalize4(it);
          if(n) normalized.push({draw:null, num:n});
        }else if(it && typeof it === "object"){
          const n = normalize4(it.num || "");
          if(n) normalized.push({draw: Number.isFinite(+it.draw) ? +it.draw : null, num:n});
        }
      }
      return normalized.slice(0,300);
    }catch(e){
      // å£Šã‚Œã¦ãŸã‚‰å†…è”µã§å¾©æ—§
      const cleaned = BUILTIN.slice(0,300).map(x=>({draw:x.draw,num:x.num}));
      localStorage.setItem(LS_KEY, JSON.stringify(cleaned));
      return cleaned;
    }
  }

  function saveHistory(arr){
    localStorage.setItem(LS_KEY, JSON.stringify(arr.slice(0,300)));
  }

  // prev/prev2 ã‚’å±¥æ­´ã‹ã‚‰åæ˜ 
  function syncPrevFieldsFromHistory(){
    const hist = loadHistory();
    document.getElementById("prev").value  = (hist[0]?.num || "");
    document.getElementById("prev2").value = (hist[1]?.num || "");
  }

  // ä¿å­˜ï¼šä»Šå›ã‚’å…ˆé ­ã«å…¥ã‚Œã¦ prev/prev2 è‡ªå‹•æ›´æ–°
  function saveDraw(){
    const win = normalize4(document.getElementById("saveWin").value);
    if(!win){ toast("4æ¡ã§å…¥ã‚Œã¦ã­"); return; }

    let hist = loadHistory();

    // ç›´è¿‘ã¨åŒã˜ã¯å¼¾ã
    if(hist[0]?.num === win){
      toast("åŒã˜ç•ªå·ã¯é€£ç¶šä¿å­˜ã—ãªã„ã‚ˆ");
      return;
    }

    // å…ˆé ­ã«è¿½åŠ ï¼ˆdrawç•ªå·ã¯ä¸æ˜ãªã®ã§nullï¼‰
    hist.unshift({draw:null, num:win});

    // 300è¶…ãˆã¯å‰Šã‚‹
    hist = hist.slice(0,300);
    saveHistory(hist);

    // prev/prev2 æ›´æ–°
    document.getElementById("prev").value  = hist[0]?.num || "";
    document.getElementById("prev2").value = hist[1]?.num || "";

    toast(`ä¿å­˜OKï¼šæœ€æ–° ${win}ï¼ˆå±¥æ­´ ${hist.length}ä»¶ï¼‰`);
  }

  // ===== è§£æã‚³ã‚¢ï¼šé‡ã¿ï¼ˆæœ€æ–°å„ªå…ˆï¼‰=====
  function recencyWeight(i){
    // i=0ãŒæœ€æ–°
    if(i < 10) return 3.2;
    if(i < 40) return 2.0;
    if(i < 120) return 1.3;
    return 1.0;
  }

  // ===== å¹³é‡å¼ï¼ˆç°¡æ˜“ãƒ»å¸¸æ™‚ONï¼‰ï¼šæ•°å­—å€™è£œ(0-9) =====
  function hiranoDigitCandidates(prev, prev2){
    // è¡¨/è£/åˆç®—(åŒä½ç½®)/åˆã‚ã›(è¡¨+è£)
    const out = new Set();
    if(!prev) return out;

    const A = prev.split("").map(x=>+x);
    const B = prev2 ? prev2.split("").map(x=>+x) : null;

    // è¡¨
    A.forEach(x=>out.add(x));
    // è£
    A.forEach(x=>out.add(ura[x]));
    // åˆç®—ï¼ˆåŒä½ç½®ï¼‰
    if(B){
      for(let i=0;i<4;i++) out.add((A[i]+B[i])%10);
    }else{
      out.add((A[0]+A[1]+A[2]+A[3])%10);
    }
    // åˆã‚ã›ï¼ˆè¡¨+è£ï¼‰
    for(const x of A) out.add((x + ura[x])%10);

    return out;
  }

  // ===== å‡ºç¾é–“éš”ï¼ˆã‚®ãƒ£ãƒƒãƒ—ï¼‰=====
  function buildGaps(hist){
    // å„ä½ã®ã€Œæœ€å¾Œã«å‡ºãŸ indexã€ã‚’æ¢ã—ã¦ã‚®ãƒ£ãƒƒãƒ—å€¤ã«ã™ã‚‹
    const lastIdx = {
      k:Array(10).fill(Infinity),
      h:Array(10).fill(Infinity),
      t:Array(10).fill(Infinity),
      o:Array(10).fill(Infinity)
    };

    for(let i=0;i<hist.length;i++){
      const n = hist[i].num;
      if(!n) continue;
      const a = n.split("").map(Number);
      if(lastIdx.k[a[0]] === Infinity) lastIdx.k[a[0]] = i;
      if(lastIdx.h[a[1]] === Infinity) lastIdx.h[a[1]] = i;
      if(lastIdx.t[a[2]] === Infinity) lastIdx.t[a[2]] = i;
      if(lastIdx.o[a[3]] === Infinity) lastIdx.o[a[3]] = i;
    }

    // ã‚®ãƒ£ãƒƒãƒ—ãŒå¤§ãã„ã»ã©å°‘ã—åŠ ç‚¹ï¼ˆå‡ºç¾é–“éš”ç†è«–ï¼‰
    // ãŸã ã—â€œå‡ºéãâ€æŠ‘åˆ¶ã®ãŸã‚ä¸Šé™ã‚ã‚Š
    const gapScore = {k:Array(10).fill(0),h:Array(10).fill(0),t:Array(10).fill(0),o:Array(10).fill(0)};
    for(const key of ["k","h","t","o"]){
      for(let d=0; d<=9; d++){
        const g = lastIdx[key][d];
        if(!Number.isFinite(g)) { gapScore[key][d] = 0.6; continue; }
        // 0..299 â†’ 0..ç´„1.6
        gapScore[key][d] = Math.min(1.6, Math.log(1+g)/2.2);
      }
    }
    return gapScore;
  }

  // ===== é·ç§»ï¼ˆæ¬¡ã«æ¥ã‚„ã™ã„ï¼‰=====
  function buildTransitions(hist){
    // pos-wise Markov: trans[pos][from][to]
    const initMat = ()=>Array.from({length:10},()=>Array(10).fill(0));
    const trans = {k:initMat(), h:initMat(), t:initMat(), o:initMat()};
    const keys = ["k","h","t","o"];

    // hist[0]=æœ€æ–°, hist[1]=å‰å›... ãªã®ã§
    // ã€Œã‚ã‚‹å›ã®æ¬¡(æœªæ¥)ã€ã¯ indexãŒå°ã•ã„æ–¹å‘ã€‚
    // ã“ã“ã§ã¯ã€Œprev(=hist[i+1]) -> next(=hist[i])ã€ã¨ã—ã¦å­¦ç¿’ã™ã‚‹ã€‚
    for(let i=1;i<hist.length;i++){
      const newer = hist[i-1]?.num;
      const older = hist[i]?.num;
      if(!newer || !older) continue;

      // older -> newer ã®é·ç§»
      const o = older.split("").map(Number);
      const n = newer.split("").map(Number);

      // å­¦ç¿’é‡ã¿ï¼šé·ç§»ã¯ç›´è¿‘ã»ã©å¼·ã„
      const w = recencyWeight(i-1);

      for(let p=0;p<4;p++){
        const from = o[p], to = n[p];
        trans[keys[p]][from][to] += w;
      }
    }
    return trans;
  }

  // ===== åŸºç¤é »åº¦ï¼ˆä½åˆ¥ï¼†å…¨ä½“ï¼‰=====
  function buildFrequencies(hist){
    const pos = { k:Array(10).fill(0), h:Array(10).fill(0), t:Array(10).fill(0), o:Array(10).fill(0) };
    const all = Array(10).fill(0);

    for(let i=0;i<hist.length;i++){
      const n = hist[i].num;
      if(!n) continue;

      const w = recencyWeight(i);
      const a = n.split("").map(Number);

      pos.k[a[0]] += w; pos.h[a[1]] += w; pos.t[a[2]] += w; pos.o[a[3]] += w;
      all[a[0]] += 1; all[a[1]] += 1; all[a[2]] += 1; all[a[3]] += 1;
    }
    return {pos, all};
  }

  // ===== ãƒŠãƒ³ã¡ã‚ƒã‚“æ³•å‰‡ï¼šåŠ ç‚¹ï¼ˆè£/Â±1/Â±2ï¼‰ã‚’â€œä½åˆ¥â€ã¸ =====
  function applyNanChanPosBonus(posScore){
    const out = {k:posScore.k.slice(),h:posScore.h.slice(),t:posScore.t.slice(),o:posScore.o.slice()};
    for(const key of ["k","h","t","o"]){
      const s = posScore[key];
      const idx = [...Array(10)].map((_,d)=>d).sort((a,b)=>s[b]-s[a]);

      // ä½åˆ¥ãƒˆãƒƒãƒ—2ã‚’ã‚¢ãƒ³ã‚«ãƒ¼ã«ã™ã‚‹ï¼ˆåã‚Šã™ãé˜²æ­¢ï¼‰
      const anchors = [idx[0], idx[1]].filter(x=>Number.isFinite(x));

      for(let d=0; d<=9; d++){
        let add = 0;
        for(const a of anchors){
          if(ura[a] === d) add += 2.0;           // è£
          if(plus1(a).includes(d)) add += 1.4;   // Â±1
          if(plus2(a).includes(d)) add += 0.9;   // Â±2
        }
        out[key][d] += add;
      }
    }
    return out;
  }

  // ===== é¢¨è»Šç•ªï¼ˆç°¡æ˜“ï¼‰=====
  // ã€Œè£ãƒšã‚¢(0-5,1-6,2-7,3-8,4-9)ãŒ2çµ„ãã‚ã£ã¦ã‚‹ã€â†’é¢¨è»Šã£ã½ã„ã¨ã¿ãªã—ã¦åŠ ç‚¹
  function windmillBonus(numStr){
    const s = new Set(numStr.split("").map(Number));
    const pairs = [[0,5],[1,6],[2,7],[3,8],[4,9]];
    let cnt = 0;
    for(const [a,b] of pairs){
      if(s.has(a) && s.has(b)) cnt++;
    }
    if(cnt >= 2) return 1.3;
    if(cnt === 1) return 0.4;
    return 0;
  }

  // ===== è¶³ã™9 / é€£ç•ª(Â±1/Â±2) =====
  function sum9Bonus(digs){
    let sc = 0;
    for(let i=0;i<4;i++) for(let j=i+1;j<4;j++){
      if(digs[i]+digs[j]===9) sc += 1.7;
    }
    return sc;
  }
  function consecutiveBonus(digs){
    let sc = 0;
    for(let i=0;i<4;i++) for(let j=i+1;j<4;j++){
      const diff = Math.abs(digs[i]-digs[j]);
      if(diff===1) sc += 1.1;
      if(diff===2) sc += 0.7;
    }
    return sc;
  }
  function doubleTripleBonus(digs){
    const c = Array(10).fill(0);
    digs.forEach(x=>c[x]++);
    const maxc = Math.max(...c);
    let sc = 0;
    if(maxc>=2) sc += 0.9;
    if(maxc>=3) sc += 0.9;
    if(maxc===4) sc += 1.1;
    return sc;
  }

  // ===== ä½åˆ¥ã‚¹ã‚³ã‚¢ï¼ˆæœ¬ä¸¸ï¼‰=====
  function buildPositionScores(){
    const hist = loadHistory();
    const {pos, all} = buildFrequencies(hist);
    const gap = buildGaps(hist);
    const trans = buildTransitions(hist);

    // ãƒ™ãƒ¼ã‚¹ï¼ˆä½åˆ¥é »åº¦ï¼‰
    const base = {k:pos.k.slice(),h:pos.h.slice(),t:pos.t.slice(),o:pos.o.slice()};

    // å…¨ä½“é »åº¦ã‚’ä¿é™ºã§æ··ãœã‚‹ï¼ˆä½åˆ¥ã®ä¸»å¼µã‚’å£Šã•ãªã„ç¨‹åº¦ï¼‰
    for(const key of ["k","h","t","o"]){
      for(let d=0; d<=9; d++){
        base[key][d] += all[d] * 0.10;
      }
    }

    // å‡ºç¾é–“éš”ï¼ˆã‚®ãƒ£ãƒƒãƒ—ï¼‰åŠ ç‚¹
    for(const key of ["k","h","t","o"]){
      for(let d=0; d<=9; d++){
        base[key][d] += gap[key][d] * 1.4;
      }
    }

    // å¼•ã£å¼µã‚Šï¼ˆåŒä¸€ä½ï¼‰
    const prev = normalize4(document.getElementById("prev").value);
    const prev2 = normalize4(document.getElementById("prev2").value);
    if(prev){
      base.k[+prev[0]] += 2.6; base.h[+prev[1]] += 2.6; base.t[+prev[2]] += 2.6; base.o[+prev[3]] += 2.6;
    }
    if(prev2){
      base.k[+prev2[0]] += 1.7; base.h[+prev2[1]] += 1.7; base.t[+prev2[2]] += 1.7; base.o[+prev2[3]] += 1.7;
    }

    // é·ç§»ï¼ˆæ¬¡ã«æ¥ã‚„ã™ã„ï¼‰
    // prev/prev2 ã®ã€Œæ¬¡ã€ã«å¤šã„æ•°å­—ã‚’åŠ ç‚¹
    function addTransitionBonus(posKey, fromDigitChar, w){
      if(!fromDigitChar) return;
      const from = +fromDigitChar;
      if(!Number.isFinite(from)) return;
      const row = trans[posKey][from];
      // ä¸Šä½2ã«å¼·ã‚ã«å¯„ã›ã‚‹
      const idx = [...Array(10)].map((_,d)=>d).sort((a,b)=>row[b]-row[a]);
      if(row[idx[0]]>0) base[posKey][idx[0]] += 1.8*w;
      if(row[idx[1]]>0) base[posKey][idx[1]] += 1.1*w;
    }
    if(prev){
      addTransitionBonus("k", prev[0], 1.0);
      addTransitionBonus("h", prev[1], 1.0);
      addTransitionBonus("t", prev[2], 1.0);
      addTransitionBonus("o", prev[3], 1.0);
    }
    if(prev2){
      addTransitionBonus("k", prev2[0], 0.7);
      addTransitionBonus("h", prev2[1], 0.7);
      addTransitionBonus("t", prev2[2], 0.7);
      addTransitionBonus("o", prev2[3], 0.7);
    }

    // å¹³é‡å¼å€™è£œï¼ˆæ•°å­—ãƒ—ãƒ¼ãƒ«åŠ ç‚¹ï¼‰
    const hset = hiranoDigitCandidates(prev, prev2);
    for(const key of ["k","h","t","o"]){
      for(const d of hset){
        base[key][d] += 0.8;
      }
    }

    // ãƒŠãƒ³ã¡ã‚ƒã‚“ï¼ˆè£/Â±1/Â±2ï¼‰å¼·åŒ–
    const withNan = applyNanChanPosBonus(base);

    // æœ€ä½ä¿éšœ
    for(const key of ["k","h","t","o"]) for(let d=0; d<=9; d++) withNan[key][d] += 0.25;

    return withNan;
  }

  // ä½åˆ¥ãƒˆãƒƒãƒ—4ï¼ˆè¡¨ç¤ºç”¨ï¼‰
  function top4FromScores(scoreArr){
    const idx = [...Array(10)].map((_,d)=>d).sort((a,b)=>scoreArr[b]-scoreArr[a]);
    return idx.slice(0,4).map(d => ({ d, sc: scoreArr[d] }));
  }
  function renderPosOut(posScore){
    const map = [
      {key:"k", title:"åƒã®ä½"},
      {key:"h", title:"ç™¾ã®ä½"},
      {key:"t", title:"åã®ä½"},
      {key:"o", title:"ä¸€ã®ä½"}
    ];
    const out = document.getElementById("posOut");
    out.innerHTML = "";
    for(const m of map){
      const top = top4FromScores(posScore[m.key]);
      const card = document.createElement("div");
      card.className = "posCard";
      card.innerHTML = `
        <div class="posTitle">${m.title}</div>
        ${top.map(x => `
          <div class="posRow">
            <div class="posNum">${x.d}</div>
            <div class="posScore">+${(Math.round(x.sc*10)/10).toFixed(1)}</div>
          </div>
        `).join("")}
      `;
      out.appendChild(card);
    }
  }

  // ===== ãƒ’ãƒ³ãƒˆã¯ã€Œå¿…ãš2ã¤ã ã‘ã€ï¼ˆå…±é€šæœ€å„ªå…ˆï¼‰=====
  function pick2FromHint(meStr, otherStr, posScore, prevStr, prev2Str){
    const me = uniq(digits(meStr)).map(Number);
    const other = new Set(uniq(digits(otherStr)).map(Number));

    // å¼•ã£å¼µã‚Šé›†åˆï¼ˆæ•°å­—å…¨ä½“ã¨ã—ã¦ã‚‚å°‘ã—åŠ¹ã‹ã›ã‚‹ï¼‰
    const pull = new Set(digits((prevStr||"") + (prev2Str||"")).map(Number));

    const score = (d) => {
      let sc = 0;
      // ä½åˆ¥ã‚¹ã‚³ã‚¢ã®å¹³å‡ã‚’ä½¿ã†ï¼ˆãƒ’ãƒ³ãƒˆã¯ä½ä¸æ˜ãªã®ã§å¹³å‡ã§ï¼‰
      sc += (posScore.k[d] + posScore.h[d] + posScore.t[d] + posScore.o[d]) * 0.35;
      if(pull.has(d)) sc += 2.0;
      // è¶³ã™9/é€£ç•ªï¼ˆãƒ’ãƒ³ãƒˆå†…ã®é–¢ä¿‚æ€§ï¼‰
      if(me.some(x => x !== d && x + d === 9)) sc += 1.2;
      if(me.some(x => x !== d && Math.abs(x - d) === 1)) sc += 0.7;
      if(me.some(x => x !== d && Math.abs(x - d) === 2)) sc += 0.4;
      // è£æ•°å­—
      if(ura[d] !== undefined) sc += 0.2;
      return sc;
    };

    const commons = me.filter(x => other.has(x));
    if(commons.length >= 2){
      return commons.sort((a,b)=>score(b)-score(a)).slice(0,2).map(String);
    }
    if(commons.length === 1){
      const rest = me.filter(x => x !== commons[0]).sort((a,b)=>score(b)-score(a));
      const second = (rest[0] ?? commons[0]);
      return [String(commons[0]), String(second)];
    }

    if(me.length >= 2){
      return me.sort((a,b)=>score(b)-score(a)).slice(0,2).map(String);
    }
    if(me.length === 1){
      const candidates = [...Array(10)].map((_,i)=>i).filter(x=>x!==me[0]).sort((a,b)=>score(b)-score(a));
      return [String(me[0]), String(candidates[0] ?? me[0])];
    }
    // ç©ºã®ä¿é™º
    return ["4","8"];
  }

  // ===== è»¸2æ¡ï¼šé–“å¼•ãå‰ã®å…±é€šæœ€å„ªå…ˆï¼ˆrawã§è¦‹ã‚‹ï¼‰=====
  function chooseAxisFromRaw(h1raw, h2raw, posScore){
    const a = uniq(digits(h1raw)).map(Number);
    const b = uniq(digits(h2raw)).map(Number);
    const setB = new Set(b);

    const avgScore = (d)=> (posScore.k[d]+posScore.h[d]+posScore.t[d]+posScore.o[d]) / 4;

    const commons = a.filter(x => setB.has(x));
    if(commons.length >= 2){
      commons.sort((x,y)=>avgScore(y)-avgScore(x));
      return [String(commons[0]), String(commons[1])];
    }
    if(commons.length === 1){
      const all = uniq([...a, ...b].filter(x => x !== commons[0]));
      all.sort((x,y)=>avgScore(y)-avgScore(x));
      const second = all[0] ?? commons[0];
      return [String(commons[0]), String(second)];
    }

    const all = uniq([...a, ...b]);
    all.sort((x,y)=>avgScore(y)-avgScore(x));
    if(all.length >= 2) return [String(all[0]), String(all[1])];

    // ãƒ’ãƒ³ãƒˆãŒç©ºã§ã‚‚å›ã™ãŸã‚ã®ä¿é™ºï¼šä½åˆ¥ãƒˆãƒƒãƒ—ã‹ã‚‰æ‹¾ã†
    const kTop = [...Array(10)].map((_,d)=>d).sort((x,y)=>posScore.k[y]-posScore.k[x]);
    return [String(kTop[0] ?? 4), String(kTop[1] ?? 8)];
  }

  // ===== ç”Ÿæˆãƒ—ãƒ¼ãƒ«ï¼ˆé‡ã¿ä»˜ãï¼‰=====
  function buildPoolWeighted(h1_2, h2_2, posScore){
    let p = [];

    // ãƒ’ãƒ³ãƒˆï¼ˆå¿…ãš2+2ï¼‰ã‚’ãƒ™ãƒ¼ã‚¹ã«
    p.push(...h1_2, ...h2_2);

    // è£
    for(const x of [...h1_2, ...h2_2]){
      const n = +x;
      p.push(String(ura[n]));
    }

    // é€£ç•ªÂ±1Â±2
    for(const x of [...h1_2, ...h2_2]){
      const n = +x;
      for(const d of plus1(n)) p.push(String(d));
      for(const d of plus2(n)) p.push(String(d));
    }

    // ä½åˆ¥ãƒˆãƒƒãƒ—ã‚’å¾®é‡æ··ãœã‚‹ï¼ˆåã‚Šã‚’ä½œã‚‹ï¼‰
    const tops = [];
    for(const key of ["k","h","t","o"]){
      tops.push(...top4FromScores(posScore[key]).slice(0,2).map(x=>String(x.d)));
    }
    p.push(...tops);

    // å¹³é‡å¼å€™è£œã‚‚å°‘ã—æ··ãœã‚‹
    const prev = normalize4(document.getElementById("prev").value);
    const prev2 = normalize4(document.getElementById("prev2").value);
    const hset = hiranoDigitCandidates(prev, prev2);
    for(const d of hset) p.push(String(d));

    // æœ€ä½é™ï¼š0-9
    p.push("0","1","2","3","4","5","6","7","8","9");

    return p;
  }

  function pick(pool, rand){
    return pool[Math.floor(rand() * pool.length)];
  }

  // ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå€™è£œ4æ¡ã«ç‚¹ã‚’ä»˜ã‘ã‚‹ï¼‰=====
  function rankStraight(nums, posScore){
    return nums.map(n=>{
      const a = n.split("").map(Number);
      let sc = 0;

      // ä½åˆ¥ã‚¹ã‚³ã‚¢ï¼ˆèŠ¯ï¼‰
      sc += posScore.k[a[0]] + posScore.h[a[1]] + posScore.t[a[2]] + posScore.o[a[3]];

      // è¶³ã™9 / é€£ç•ªï¼ˆÂ±1Â±2ï¼‰
      sc += sum9Bonus(a);
      sc += consecutiveBonus(a);

      // ãƒ€ãƒ–ãƒ«/ãƒˆãƒªãƒ—ãƒ«
      sc += doubleTripleBonus(a);

      // é¢¨è»Š
      sc += windmillBonus(n);

      // â€œå¼•ã£å¼µã‚Šâ€ã¨ã—ã¦ã€prev/prev2 ã®åŒä¸€æ¡ä¸€è‡´ã‚’è¿½åŠ ã§å°‘ã—
      const prev = normalize4(document.getElementById("prev").value);
      const prev2 = normalize4(document.getElementById("prev2").value);
      if(prev){
        if(n[0]===prev[0]) sc += 0.8;
        if(n[1]===prev[1]) sc += 0.8;
        if(n[2]===prev[2]) sc += 0.8;
        if(n[3]===prev[3]) sc += 0.8;
      }
      if(prev2){
        if(n[0]===prev2[0]) sc += 0.5;
        if(n[1]===prev2[1]) sc += 0.5;
        if(n[2]===prev2[2]) sc += 0.5;
        if(n[3]===prev2[3]) sc += 0.5;
      }

      return { n, sc };
    }).sort((A,B)=>B.sc - A.sc);
  }

  // ã‚»ãƒƒãƒˆã¯ã€Œä¸¦ã³ã‚­ãƒ¼ã€ã§ã€è¶³ã™9/é€£ç•ª/é¢¨è»Š/ãƒ€ãƒ–ãƒ«ä¸­å¿ƒã§ç‚¹ã‚’ä»˜ã‘ã‚‹
  function rankSetKeys(keys){
    return keys.map(k=>{
      const a = k.split("").map(Number);
      let sc = 0;
      sc += sum9Bonus(a)*0.9;
      sc += consecutiveBonus(a)*0.9;
      sc += doubleTripleBonus(a)*1.0;
      sc += windmillBonus(k)*0.9;
      return { n:k, sc };
    }).sort((A,B)=>B.sc - A.sc);
  }

  function tierLabel(score, best){
    if(best <= 0) return { badge:"â˜…", label:"å¼±" };
    const r = score / best;
    if(r >= 0.92) return { badge:"â˜…â˜…â˜…", label:"å¼·" };
    if(r >= 0.86) return { badge:"â˜…â˜…",  label:"ä¸­" };
    return { badge:"â˜…",   label:"å¼±" };
  }

  function splitRanked(ranked, limit=10){
    if(!ranked || ranked.length === 0) return { main: [], ins: [], rows: [] };
    const best = ranked[0].sc;
    const rows = ranked.slice(0, limit).map((r, idx) => {
      const t = tierLabel(r.sc, best);
      return { i: idx+1, num: r.n, badge: t.badge, label: t.label, sc: r.sc };
    });
    return {
      rows,
      main: rows.filter(x => x.label === "å¼·"),
      ins : rows.filter(x => x.label !== "å¼·")
    };
  }

  function formatRows(rows){
    if(!rows || rows.length === 0) return "ï¼ˆãªã—ï¼‰";
    return rows.map(x => `${x.i}ä½  ${x.badge} [${x.label}]  ${x.num}`).join("\n");
  }

  function judgeDayPower(mainCount){
    if(mainCount >= 5) return "ğŸ”¥ ä»Šæ—¥ã¯å¼·ã„æ—¥ï¼ˆé›†ä¸­å‹è² ï¼‰";
    if(mainCount >= 3) return "â— æ™®é€šã®æ—¥ï¼ˆãƒãƒ©ãƒ³ã‚¹ï¼‰";
    return "â–³ åˆ†æ•£ã®æ—¥ï¼ˆç„¡ç†ã—ãªã„ï¼‰";
  }

  function setKey(num){
    return num.split("").sort().join("");
  }

  // ===== ç”Ÿæˆæœ¬ä½“ =====
  function generate(){
    // prev/prev2 ã¯å±¥æ­´ã‹ã‚‰åŒæœŸï¼ˆé‹ç”¨ä¸Šã®å›ºå®šï¼‰
    syncPrevFieldsFromHistory();

    // ä½åˆ¥ã‚¹ã‚³ã‚¢ä½œæˆï¼ˆè§£æã®èŠ¯ï¼‰
    const posScore = buildPositionScores();
    STATE.posScore = posScore;

    // ä½åˆ¥ãƒˆãƒƒãƒ—4è¡¨ç¤º
    renderPosOut(posScore);

    // ãƒ’ãƒ³ãƒˆ2ã¤ãšã¤
    const h1raw = document.getElementById("hint1").value;
    const h2raw = document.getElementById("hint2").value;
    const prevStr  = document.getElementById("prev").value;
    const prev2Str = document.getElementById("prev2").value;

    const h1_2 = pick2FromHint(h1raw, h2raw, posScore, prevStr, prev2Str);
    const h2_2 = pick2FromHint(h2raw, h1raw, posScore, prevStr, prev2Str);

    // è»¸ï¼šrawå…±é€šæœ€å„ªå…ˆ
    const axisArr = chooseAxisFromRaw(h1raw, h2raw, posScore);
    const axis = axisArr[0] + axisArr[1];
    STATE.axis = axis;

    // ãƒ—ãƒ¼ãƒ«ä½œæˆ
    const pool = buildPoolWeighted(h1_2, h2_2, posScore);

    // ã‚·ãƒ¼ãƒ‰å›ºå®šï¼šãƒ’ãƒ³ãƒˆ + å±¥æ­´ï¼ˆä¸­èº«ã¯è¡¨ã«å‡ºã•ãªã„ï¼‰
    const hist = loadHistory().map(x=>x.num).join(",");
    const seedStr = `${h1raw}|${h2raw}|${prevStr}|${prev2Str}|${hist}`;
    const rand = mulberry32(hash32(seedStr));

    // å€™è£œç”Ÿæˆï¼šè»¸å›ºå®šï¼‹æ®‹ã‚Š2æ¡ï¼ˆé‡è¤‡OKã§â€œåã‚Šâ€ã‚’è¨±å®¹ã€ãŸã ã—å¤šæ§˜æ€§ã‚‚ç¢ºä¿ï¼‰
    const list = [];
    const seen = new Set();
    let guard = 0;

    while(list.length < 160 && guard < 9000){
      guard++;
      const d2 = pick(pool, rand);
      const d3 = pick(pool, rand);
      const n = `${axisArr[0]}${axisArr[1]}${d2}${d3}`;
      if(seen.has(n)) continue;
      seen.add(n);
      list.push(n);
    }

    // ãƒ©ãƒ³ã‚¯ä»˜ã‘
    const ranked = rankStraight(list, posScore);
    const top10 = ranked.slice(0, 10);
    const sp = splitRanked(top10, 10);

    document.getElementById("dayPower").textContent = judgeDayPower(sp.main.length);
    document.getElementById("straightMain").textContent = formatRows(sp.main);
    document.getElementById("straightIns").textContent  = formatRows(sp.ins);

    // ã‚»ãƒƒãƒˆï¼štop10ã‚’ã‚­ãƒ¼åŒ–â†’ãƒ©ãƒ³ã‚¯
    const setKeys = uniq(top10.map(r => setKey(r.n)));
    const setRanked = rankSetKeys(setKeys).slice(0,10);
    const setSplit = splitRanked(setRanked, 10);

    document.getElementById("setMain").textContent = formatRows(setSplit.main);
    document.getElementById("setIns").textContent  = formatRows(setSplit.ins);

    // STATEä¿å­˜ï¼ˆåˆ¤å®šç”¨ï¼‰
    STATE.topStraightRows = sp.rows;
    STATE.straightMain = sp.main;
    STATE.straightIns = sp.ins;

    STATE.topSetRows = setSplit.rows;
    STATE.setMain = setSplit.main;
    STATE.setIns = setSplit.ins;

    document.getElementById("judgeOut").innerHTML =
      `<span class="ok">ç”ŸæˆOK</span>ï¼ˆè»¸ <span class="mono">${STATE.axis}</span>ï¼‰ çµæœãŒå‡ºãŸã‚‰å½“é¸ç•ªå·ã‚’å…¥ã‚Œã¦ã€Œåˆ¤å®šã€ã—ã¦ã­ã€‚`;

    toast("è§£æâ†’ç”Ÿæˆ å®Œäº†");
  }

  // ===== åˆ¤å®šç”¨ =====
  function posMatch(a,b){
    let c=0;
    for(let i=0;i<4;i++) if(a[i]===b[i]) c++;
    return c;
  }
  function digitMatchCount(a,b){
    const ca = Array(10).fill(0);
    const cb = Array(10).fill(0);
    for(const ch of a) ca[+ch]++;
    for(const ch of b) cb[+ch]++;
    let sum=0;
    for(let i=0;i<10;i++) sum += Math.min(ca[i], cb[i]);
    return sum;
  }
  function inGroup(num, groupRows){
    return groupRows.find(r => r.num === num) || null;
  }

  // ===== çµæœåˆ¤å®šï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼‹ã‚»ãƒƒãƒˆä¸¡æ–¹ï¼‰=====
  function judge(){
    const win = normalize4(document.getElementById("win").value);
    const out = document.getElementById("judgeOut");

    if(!win){
      out.innerHTML = `<span class="warn">å½“é¸ç•ªå·ã¯4æ¡ã§å…¥ã‚Œã¦ã­</span>`;
      return;
    }
    if(!STATE.topStraightRows || STATE.topStraightRows.length === 0){
      out.innerHTML = `<span class="warn">å…ˆã«ã€Œè§£æã—ã¦ç•ªå·ã‚’ç”Ÿæˆã€ã‚’æŠ¼ã—ã¦ã­</span>`;
      return;
    }

    const axis = STATE.axis;
    const axisHit = (win.includes(axis[0]) && win.includes(axis[1])) || (win[0]+win[1]===axis);

    // ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼šæœ¬å‘½/ä¿é™º/åœå†…
    const sMainHit = inGroup(win, STATE.straightMain);
    const sInsHit  = inGroup(win, STATE.straightIns);
    const sAnyHit  = inGroup(win, STATE.topStraightRows);

    // ã‚»ãƒƒãƒˆï¼šã‚­ãƒ¼ä¸€è‡´
    const winKey = setKey(win);
    const setMainHit = inGroup(winKey, STATE.setMain);
    const setInsHit  = inGroup(winKey, STATE.setIns);
    const setAnyHit  = inGroup(winKey, STATE.topSetRows);

    // è¿‘ã•
    let bestPos = 0;
    let bestDigit = 0;
    for(const r of STATE.topStraightRows){
      bestPos = Math.max(bestPos, posMatch(win, r.num));
      bestDigit = Math.max(bestDigit, digitMatchCount(win, r.num));
    }

    let headline = "";
    const detail = [];

    if(sMainHit || setMainHit){
      headline = "ğŸ”¥ æ¿€ã‚¢ãƒ„ï¼ˆèª­ã¿ãŒå°„ç¨‹åœï¼‰";
    } else if(sInsHit || setInsHit){
      headline = "â— æƒœã—ã„ï¼ˆæµã‚Œã¯åˆã£ã¦ã‚‹ï¼‰";
    } else if(sAnyHit || setAnyHit || bestPos >= 3){
      headline = "â—‹ æµã‚ŒOKï¼ˆã‚ã¨ä¸€æ­©ï¼‰";
    } else if(bestDigit >= 2 || axisHit){
      headline = "â–³ åˆ†æ•£ã®æ—¥ï¼ˆç„¡ç†ã—ãªã„ï¼‰";
    } else {
      headline = "Ã— ã‚ºãƒ¬ï¼ˆä»Šæ—¥ã¯æµã‚Œé•ã„ï¼‰";
    }

    detail.push(`å½“é¸ï¼š<span class="mono">${win}</span>`);
    detail.push(`è»¸ï¼š<span class="mono">${axis}</span>ã€€/ã€€è»¸ä¸€è‡´ï¼š<span class="${axisHit?'ok':'warn'}">${axisHit?'â—‹':'Ã—'}</span>`);

    if(sMainHit){
      detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼š<span class="ok">æœ¬å‘½ï¼ˆå¼·ï¼‰</span>ã€€${sMainHit.i}ä½`);
    } else if(sInsHit){
      detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼š<span class="ok">ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</span>ã€€${sInsHit.i}ä½`);
    } else if(sAnyHit){
      detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼š<span class="ok">åœå†…</span>ã€€${sAnyHit.i}ä½`);
    } else {
      detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼šåœå¤–ï¼ˆè¿‘ã•ï¼šä½ç½®ä¸€è‡´max ${bestPos}/4ã€æ•°å­—ä¸€è‡´max ${bestDigit}/4ï¼‰`);
    }

    if(setMainHit){
      detail.push(`ã‚»ãƒƒãƒˆï¼š<span class="ok">æœ¬å‘½ï¼ˆå¼·ï¼‰</span>ã€€${setMainHit.i}ä½ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
    } else if(setInsHit){
      detail.push(`ã‚»ãƒƒãƒˆï¼š<span class="ok">ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</span>ã€€${setInsHit.i}ä½ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
    } else if(setAnyHit){
      detail.push(`ã‚»ãƒƒãƒˆï¼š<span class="ok">åœå†…</span>ã€€${setAnyHit.i}ä½ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
    } else {
      detail.push(`ã‚»ãƒƒãƒˆï¼šåœå¤–ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
    }

    out.innerHTML =
      `<div class="big">${headline}</div>` +
      `<div style="margin-top:8px;line-height:1.7">${detail.map(x=>`ãƒ»${x}`).join("<br>")}</div>`;
  }

  // ===== åˆæœŸåŒ– =====
  (function init(){
    // å±¥æ­´ãŒç©ºãªã‚‰å†…è”µã‚’æµã—è¾¼ã‚€ï¼ˆloadHistoryãŒã‚„ã‚‹ï¼‰
    loadHistory();
    // prev/prev2 åæ˜ 
    syncPrevFieldsFromHistory();

    // é›°å›²æ°—ã§ä½åˆ¥å€™è£œã ã‘å…ˆã«å‡ºã—ã¦ãŠãï¼ˆãƒ’ãƒ³ãƒˆç„¡ã—ã§ã‚‚â€œè§£æã—ã¦ã‚‹æ„Ÿâ€ã¯è¦‹ãˆã‚‹ï¼‰
    const hist = loadHistory();
    if(hist.length >= 20){
      const posScore = buildPositionScores();
      STATE.posScore = posScore;
      renderPosOut(posScore);
      document.getElementById("judgeOut").innerHTML =
        `<span class="ok">æº–å‚™OK</span>ï¼ˆå†…éƒ¨ãƒ‡ãƒ¼ã‚¿ ${hist.length}ä»¶ï¼‰ ãƒ’ãƒ³ãƒˆå…¥ã‚Œã¦ã€Œè§£æã—ã¦ç•ªå·ã‚’ç”Ÿæˆã€ã—ã¦ã­ã€‚`;
    }else{
      document.getElementById("judgeOut").innerHTML =
        `<span class="ok">æº–å‚™OK</span> ã¾ãšã¯ã€ŒæŠ½é¸çµæœã‚’ä¿å­˜ã€ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’è‚²ã¦ã¦ã­ã€‚`;
    }
  })();
</script>

</body>
</html>
