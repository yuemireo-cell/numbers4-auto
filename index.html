<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒŠãƒ³ãƒãƒ¼ã‚º4 å®Œæˆç‰ˆ</title>
  <style>
    body{font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;padding:16px;max-width:860px;margin:auto}
    h1{font-size:34px;margin:10px 0 18px}
    input,textarea,button{font-size:16px;padding:12px;width:100%;box-sizing:border-box;margin:8px 0;border-radius:14px;border:1px solid #e5e5e5}
    textarea{min-height:90px;resize:vertical}
    button{background:#111;color:#fff;border:none;border-radius:999px;padding:16px;font-weight:900}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap}
    .btnRow button{width:auto;flex:1;min-width:200px}
    .box{background:#fafafa;border:1px solid #eee;border-radius:16px;padding:14px;margin-top:12px}
    .label{font-weight:900;margin-top:6px}
    pre{white-space:pre-wrap;background:#f7f7f7;border-radius:14px;padding:12px;border:1px solid #eee}
    .day{font-weight:900;margin:8px 0 0}
    .note{color:#666;font-size:12px;margin-top:6px;line-height:1.5}
    h2{margin-top:22px}
    h3{margin:12px 0 6px}
    .resultBox{background:#fff;border:1px solid #eee;border-radius:16px;padding:14px;margin-top:12px}
    .big{font-size:18px;font-weight:900}
    .ok{color:#0a7;font-weight:900}
    .warn{color:#b00020;font-weight:900}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}

    /* ä½åˆ¥ãƒ‘ãƒãƒ« */
    .posGrid{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .posCard{
      border:3px solid #111;
      border-radius:18px;
      padding:12px;
      background:#fff;
      flex:1;
      min-width:170px;
    }
    .posTitle{
      font-weight:1000;
      font-size:18px;
      margin-bottom:8px;
    }
    .posRow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      padding:10px 0;
      border-bottom:1px solid #eee;
    }
    .posRow:last-child{border-bottom:none}
    .posNum{
      font-size:42px;
      font-weight:1000;
      line-height:1;
    }
    .posScore{
      color:#666;
      font-weight:900;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#111;
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease;
      z-index:9999;
      max-width:92vw;
      text-align:center;
    }
    .toast.show{opacity:0.95}
  </style>
</head>
<body>

  <h1>ãƒŠãƒ³ãƒãƒ¼ã‚º4 å®Œæˆç‰ˆ</h1>

  <!-- ä¿å­˜ï¼†ç”Ÿæˆ -->
  <div class="box">
    <div class="label">ãƒ’ãƒ³ãƒˆ1ï¼ˆä¾‹ï¼š168 / 1ãƒ»6ãƒ»8ï¼‰</div>
    <input id="hint1" inputmode="numeric" placeholder="ãƒ’ãƒ³ãƒˆ1 ä¾‹ï¼š168">

    <div class="label">ãƒ’ãƒ³ãƒˆ2ï¼ˆä¾‹ï¼š3920 / 3ãƒ»9ãƒ»2ãƒ»0ï¼‰</div>
    <input id="hint2" inputmode="numeric" placeholder="ãƒ’ãƒ³ãƒˆ2 ä¾‹ï¼š3920">

    <div class="label">å‰å›ï¼ˆè‡ªå‹•ï¼‰</div>
    <input id="prev" inputmode="numeric" placeholder="å‰å› ä¾‹ï¼š5105" maxlength="4">

    <div class="label">å‰ã€…å›ï¼ˆè‡ªå‹•ï¼‰</div>
    <input id="prev2" inputmode="numeric" placeholder="å‰ã€…å› ä¾‹ï¼š4588" maxlength="4">

    <div class="label">ä»Šå›ã®æŠ½é¸çµæœï¼ˆä¿å­˜ç”¨ãƒ»4æ¡ï¼‰</div>
    <input id="saveWin" inputmode="numeric" placeholder="ä¾‹ï¼š9827" maxlength="4">

    <div class="note">
      âœ… ã€Œç›´è¿‘10å›ã€å…¥åŠ›æ¬„ã¯å»ƒæ­¢ã€‚<br>
      âœ… <strong>ä¿å­˜ãƒœã‚¿ãƒ³</strong>ã§ã€Œä»Šå›â†’å‰å›ã€ã€Œå‰å›â†’å‰ã€…å›ã€ã‚’è‡ªå‹•æ›´æ–°ï¼ˆå…¥åŠ›ã®æ‰‹é–“ã‚¼ãƒ­ï¼‰ã€‚<br>
      âœ… ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã¯è¡¨ã«å‡ºã•ãšã€ç«¯æœ«å†…ï¼ˆlocalStorageï¼‰ã«æœ€å¤§<strong>100å›</strong>ã ã‘ä¿æŒã€‚<br>
      â€»18æ™‚ã‚®ãƒªã‚®ãƒªã®ãƒªãƒãƒ¼ã‚µãƒ«æ•°å­—ã¯å…¥ã‚Œãªã„ï¼ˆã‚†ã†ã¡ã‚ƒã‚“æ–¹é‡ï¼‰
    </div>

    <div class="btnRow">
      <button type="button" onclick="saveDraw()">ğŸ“© æŠ½é¸çµæœã‚’ä¿å­˜</button>
      <button type="button" onclick="generate()">ğŸ”® ç•ªå·ã‚’ç”Ÿæˆã™ã‚‹</button>
    </div>
  </div>

  <!-- ä½åˆ¥ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆè§£æ -->
  <div class="resultBox">
    <div class="label">ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆäºˆæƒ³ï¼ˆä½åˆ¥4å€™è£œ / ä¿å­˜100å›ï¼‹åŠ ç‚¹è§£æï¼‰</div>
    <div class="note">
      ã“ã“ã¯ã€Œå‰å›ã®æ•°å­—ã‚’ãã®ã¾ã¾å‡ºã™ã€ã¿ãŸã„ãªèŒ¶ç•ªã¯ã—ãªã„ã€‚<br>
      <strong>ä¿å­˜100å›ã®â€œä½åˆ¥é »åº¦â€</strong>ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€<strong>ãƒŠãƒ³ã¡ã‚ƒã‚“åŠ ç‚¹ï¼ˆè£æ•°å­—ãƒ»Â±1ãƒ»Â±2ï¼‰</strong>ã¨ã€å‰å›/å‰ã€…å›ã®å¼•ã£å¼µã‚Šã‚’æ··ãœã¦ã‚¹ã‚³ã‚¢åŒ–ã—ã¦ã‚‹ã€‚
    </div>
    <div id="posOut" class="posGrid"></div>
  </div>

  <!-- åˆ¤å®š -->
  <div class="resultBox">
    <div class="label">å½“é¸ç•ªå·ï¼ˆçµæœãŒå‡ºãŸã‚‰ã“ã“ã«4æ¡ï¼‰</div>
    <input id="win" inputmode="numeric" placeholder="ä¾‹ï¼š7263" maxlength="4">
    <button type="button" onclick="judge()">çµæœã‚’åˆ¤å®šã™ã‚‹</button>

    <div id="judgeOut" class="mono" style="margin-top:10px;"></div>
    <div class="note">â€»åˆ¤å®šã¯ã€Œã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼‹ã‚»ãƒƒãƒˆã€ä¸¡æ–¹ã‚’è¦‹ã‚‹ï¼ˆã‚†ã†ã¡ã‚ƒã‚“æŒ‡å®šï¼‰</div>
  </div>

  <h2>ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</h2>
  <div id="dayPower" class="day"></div>

  <h3>æœ¬å‘½ï¼ˆå¼·ï¼‰</h3>
  <pre id="straightMain">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>

  <h3>ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</h3>
  <pre id="straightIns">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>

  <h2>ã‚»ãƒƒãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</h2>

  <h3>æœ¬å‘½ï¼ˆå¼·ï¼‰</h3>
  <pre id="setMain">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>

  <h3>ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</h3>
  <pre id="setIns">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>

  <div id="toast" class="toast"></div>

<script>
  /***************************************************************
   *  âœ… æ–¹é‡
   *  - æ—¢å­˜æ©Ÿèƒ½ã¯å‰Šé™¤ã—ãªã„ï¼ˆã‚†ã†ã¡ã‚ƒã‚“æ–¹é‡ï¼‰
   *  - ç›´è¿‘10å›å…¥åŠ›æ¬„ã¯å»ƒæ­¢ â†’ ä¿å­˜100å›ã‚’å†…è”µï¼ˆlocalStorageï¼‰
   *  - ä¿å­˜ãƒœã‚¿ãƒ³ã§ prev / prev2 ã‚’è‡ªå‹•æ›´æ–°
   *  - ä½åˆ¥è§£æã¯ã€Œä½ã”ã¨ã«åˆ¥ã®ã‚¹ã‚³ã‚¢ã€ã‚’å¿…ãšä½œã‚‹ï¼ˆå…¨ä½åŒã˜ã«ãªã‚‰ãªã„ï¼‰
   *  - ãƒŠãƒ³ã¡ã‚ƒã‚“æ³•å‰‡ã¯ã€Œå¼·åŒ–åŠ ç‚¹ã€ã¨ã—ã¦è©•ä¾¡ã«æ··ãœã‚‹
   ***************************************************************/

  // ===== è£æ•°å­—ï¼ˆã‚†ã†ã¡ã‚ƒã‚“å®šç¾©ï¼‰=====
  const ura = {0:5,5:0,1:6,6:1,2:7,7:2,3:8,8:3,4:9,9:4};

  // ===== ãƒŠãƒ³ã¡ã‚ƒã‚“åŠ ç‚¹ç”¨ï¼šã‚ºãƒ¬ï¼ˆÂ±1, Â±2ï¼‰=====
  function plus1(n){ return [(n+1)%10, (n+9)%10]; } // +1, -1
  function plus2(n){ return [(n+2)%10, (n+8)%10]; } // +2, -2

  // ===== localStorage keys =====
  const LS_KEY = "n4_history_100_v2"; // max 100, newest first
  const LS_META = "n4_meta_v2";

  // ===== çŠ¶æ…‹ä¿æŒï¼ˆç”Ÿæˆçµæœã‚’åˆ¤å®šã«ä½¿ã†ï¼‰=====
  const STATE = {
    axis: "48",
    topStraightRows: [], // [{i,num,badge,label,sc}]
    topSetRows: [],      // åŒä¸Šï¼ˆnumã¯ã‚»ãƒƒãƒˆã‚­ãƒ¼ï¼ä¸¦ã¹æ›¿ãˆï¼‰
    straightMain: [],
    straightIns: [],
    setMain: [],
    setIns: [],
    posTop4: { k:[], h:[], t:[], o:[] }, // ä½åˆ¥ä¸Šä½4ï¼ˆè¡¨ç¤ºç”¨ï¼‰
    posScore: { k: Array(10).fill(0), h: Array(10).fill(0), t: Array(10).fill(0), o: Array(10).fill(0) } // ä½åˆ¥ã‚¹ã‚³ã‚¢
  };

  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  function digits(str){ return (str || "").match(/\d/g) || []; }
  function uniq(arr){
    const s = new Set(), out=[];
    for(const x of arr){ if(!s.has(x)){ s.add(x); out.push(x); } }
    return out;
  }
  function normalize4(str){
    const d = digits(str).slice(0,4);
    if(d.length !== 4) return null;
    return d.join("");
  }
  function toast(msg){
    const el = document.getElementById("toast");
    el.textContent = msg;
    el.classList.add("show");
    setTimeout(()=>el.classList.remove("show"), 1600);
  }

  // åŒã˜å…¥åŠ›ãªã‚‰åŒã˜ä¹±æ•°åˆ—ï¼ˆå›ºå®šï¼‰
  function hash32(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }
  function mulberry32(seed){
    return function(){
      let t = seed += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }
  function pick(pool, rand){
    return pool[Math.floor(rand() * pool.length)];
  }

  // ===== ä¿å­˜100å›ã®ç®¡ç† =====
  function loadHistory(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      if(!Array.isArray(arr)) return [];
      return arr.map(x => String(x)).map(normalize4).filter(Boolean);
    }catch(e){
      return [];
    }
  }
  function saveHistory(arr){
    localStorage.setItem(LS_KEY, JSON.stringify(arr.slice(0,100)));
  }

  // prev/prev2 ã‚’ã€Œä¿å­˜100å›ã€ã‹ã‚‰è‡ªå‹•åæ˜ ï¼ˆåˆæœŸåŒ–ï¼‰
  function syncPrevFieldsFromHistory(){
    const hist = loadHistory();
    const p  = hist[0] || "";
    const p2 = hist[1] || "";
    document.getElementById("prev").value  = p;
    document.getElementById("prev2").value = p2;
  }

  // ä¿å­˜ãƒœã‚¿ãƒ³ï¼šä»Šå›ã‚’ä¿å­˜ â†’ prev/prev2 ã‚’è‡ªå‹•æ›´æ–°
  function saveDraw(){
    const win = normalize4(document.getElementById("saveWin").value);
    if(!win){
      toast("4æ¡ã§å…¥ã‚Œã¦ã­");
      return;
    }

    let hist = loadHistory();

    // ç›´è¿‘ã¨åŒã˜ãªã‚‰äºŒé‡ä¿å­˜ã—ãªã„ï¼ˆæŠ¼ã—é–“é•ã„å¯¾ç­–ï¼‰
    if(hist[0] === win){
      toast("åŒã˜ç•ªå·ã¯é€£ç¶šä¿å­˜ã—ãªã„ã‚ˆ");
      return;
    }

    // å…ˆé ­ã«è¿½åŠ ï¼ˆæœ€æ–°â†’å¤ã„ï¼‰
    hist.unshift(win);

    // 100ã‚’è¶…ãˆãŸã‚‰æœ«å°¾ã‹ã‚‰å‰Šã‚‹
    hist = hist.slice(0,100);
    saveHistory(hist);

    // prev/prev2 è‡ªå‹•æ›´æ–°
    document.getElementById("prev").value  = hist[0] || "";
    document.getElementById("prev2").value = hist[1] || "";

    // åˆ¤å®šç”¨å…¥åŠ›ã‚‚åŒæœŸã—ãŸã„ãªã‚‰ã“ã“ï¼ˆä¾¿åˆ©ï¼‰
    // document.getElementById("win").value = win;

    toast(`ä¿å­˜OKï¼šæœ€æ–° ${win}ï¼ˆå±¥æ­´ ${hist.length}ä»¶ï¼‰`);
  }

  // ===== 100å›ãƒ‡ãƒ¼ã‚¿ã‚’ã©ã†è©•ä¾¡ã«æ··ãœã‚‹ã‹ï¼ˆè¨­è¨ˆå›³ â†’ å®Ÿè£…ï¼‰=====
  /**
   * 1) ä¿å­˜100å›ã‹ã‚‰ã€Œä½åˆ¥é »åº¦ã€(k/h/t/o) ã‚’ä½œã‚‹
   *    - æ–°ã—ã„å›ã»ã©å¼·ã‚ã«ã™ã‚‹ï¼ˆé‡ã¿ä»˜ã‘ï¼‰
   *      ä¾‹ï¼šæœ€æ–°10å›=3ç‚¹ã€æ¬¡30å›=2ç‚¹ã€æ®‹ã‚Š=1ç‚¹
   * 2) ã•ã‚‰ã«ã€Œå…¨ä½“é »åº¦ã€ã‚‚ä½œã£ã¦ã€ä½åˆ¥ã«åã‚Šã™ããªã„ä¿é™ºã‚’ã‹ã‘ã‚‹
   * 3) prev / prev2 ã¯ â€œå¼•ã£å¼µã‚Šâ€ã¨ã—ã¦åŠ ç‚¹ï¼ˆåŒã˜ä½ã«æ¥ãŸã‚‰å¼·ã„ï¼‰
   * 4) ãƒŠãƒ³ã¡ã‚ƒã‚“åŠ ç‚¹ï¼ˆè£æ•°å­—ã€Â±1ã€Â±2ï¼‰ã‚’ â€œå¼·åŒ–åŠ ç‚¹â€ ã¨ã—ã¦åŠ ãˆã‚‹
   */

  function buildHistoryStats(){
    const hist = loadHistory(); // newest first
    const pos = { k:Array(10).fill(0), h:Array(10).fill(0), t:Array(10).fill(0), o:Array(10).fill(0) };
    const all = Array(10).fill(0);

    for(let i=0;i<hist.length;i++){
      const n = hist[i];
      // é‡ã¿ï¼šæ–°ã—ã„ã»ã©å¼·ã„ï¼ˆè§£æã£ã½ã•ã˜ã‚ƒãªãå®Ÿç”¨ã®ãŸã‚ï¼‰
      let w = 1;
      if(i < 10) w = 3;
      else if(i < 40) w = 2;
      else w = 1;

      const a = n.split("").map(Number); // [k,h,t,o]
      pos.k[a[0]] += w; pos.h[a[1]] += w; pos.t[a[2]] += w; pos.o[a[3]] += w;
      all[a[0]] += 1; all[a[1]] += 1; all[a[2]] += 1; all[a[3]] += 1;
    }
    return { hist, pos, all };
  }

  // ===== ãƒŠãƒ³ã¡ã‚ƒã‚“æ³•å‰‡ã‚’æ•°å€¤åŒ–ï¼ˆæ¡ˆ â†’ å®Ÿè£…ï¼‰=====
  /**
   * ã€Œä½åˆ¥ã§å¼·ã„æ•°å­—ï¼ˆä¸Šä½ï¼‰ã€ã‚’åŸºæº–ã«ã—ã¦
   *  - è£æ•°å­—ï¼š +2
   *  - Â±1ã‚ºãƒ¬ï¼š +1.5
   *  - Â±2ã‚ºãƒ¬ï¼š +1.0
   * ã‚’ä»˜ä¸ï¼ˆå¼·åŒ–åŠ ç‚¹ï¼‰
   *
   * â€»â€œå‰å›æ•°å­—ã ã‘â€ã«åã‚‰ãªã„ã‚ˆã†ã€åŸºæº–ã¯ã€Œä¿å­˜100å›ã®ä½åˆ¥ä¸Šä½ã€ã€‚
   */
  function applyNanChanBonus(basePosScores){
    // basePosScores: {k:[10],h:[10],t:[10],o:[10]}
    const out = {
      k: basePosScores.k.slice(),
      h: basePosScores.h.slice(),
      t: basePosScores.t.slice(),
      o: basePosScores.o.slice()
    };

    const keys = ["k","h","t","o"];
    for(const key of keys){
      const s = basePosScores[key];
      // ä½åˆ¥ãƒˆãƒƒãƒ—2ã‚’åŸºæº–ã«ã™ã‚‹ï¼ˆåã‚Šã‚’æŠ‘ãˆã¤ã¤â€œæµã‚Œâ€ã‚’æ‹¾ã†ï¼‰
      const idx = [...Array(10)].map((_,d)=>d).sort((a,b)=>s[b]-s[a]);
      const topA = idx[0];
      const topB = idx[1];

      const anchors = [topA, topB].filter(x => typeof x === "number");

      for(let d=0; d<=9; d++){
        let add = 0;

        for(const a of anchors){
          // è£æ•°å­—
          if(ura[a] === d) add += 2.0;

          // Â±1
          if(plus1(a).includes(d)) add += 1.5;

          // Â±2
          if(plus2(a).includes(d)) add += 1.0;
        }

        out[key][d] += add;
      }
    }
    return out;
  }

  // ===== ä½åˆ¥ã‚¹ã‚³ã‚¢ã‚’ä½œã‚‹ï¼ˆã¡ã‚ƒã‚“ã¨è§£æã™ã‚‹æœ¬ä¸¸ï¼‰=====
  function buildPositionScores(){
    const { pos, all } = buildHistoryStats();

    // 1) ä¿å­˜100å›ã®ä½åˆ¥é »åº¦ãŒãƒ™ãƒ¼ã‚¹
    const base = {
      k: pos.k.slice(),
      h: pos.h.slice(),
      t: pos.t.slice(),
      o: pos.o.slice()
    };

    // 2) å…¨ä½“é »åº¦ã‚’â€œä¿é™ºâ€ã¨ã—ã¦æ··ãœã‚‹ï¼ˆä½åˆ¥ãŒè–„ã„æ™‚ã«åŠ¹ãï¼‰
    //    ä¿‚æ•°ã¯å°ã•ã‚ï¼ˆä½åˆ¥ãŒä¸»å½¹ï¼‰
    for(const key of ["k","h","t","o"]){
      for(let d=0; d<=9; d++){
        base[key][d] += all[d] * 0.15; // å…¨ä½“ã®å‡ºã‚„ã™ã•
      }
    }

    // 3) prev / prev2 ã®â€œåŒä¸€ä½å¼•ã£å¼µã‚Šâ€åŠ ç‚¹
    const prev = normalize4(document.getElementById("prev").value);
    const prev2 = normalize4(document.getElementById("prev2").value);

    function addPull(scoreArr, digitChar, w){
      const d = Number(digitChar);
      if(Number.isFinite(d)) scoreArr[d] += w;
    }

    if(prev){
      addPull(base.k, prev[0], 3.0);
      addPull(base.h, prev[1], 3.0);
      addPull(base.t, prev[2], 3.0);
      addPull(base.o, prev[3], 3.0);
    }
    if(prev2){
      addPull(base.k, prev2[0], 2.0);
      addPull(base.h, prev2[1], 2.0);
      addPull(base.t, prev2[2], 2.0);
      addPull(base.o, prev2[3], 2.0);
    }

    // 4) ãƒŠãƒ³ã¡ã‚ƒã‚“å¼·åŒ–åŠ ç‚¹ï¼ˆè£ãƒ»Â±1ãƒ»Â±2ï¼‰
    const withNan = applyNanChanBonus(base);

    // 5) æœ€ä½é™ã®ãƒ™ãƒ¼ã‚¹ï¼ˆå…¨éƒ¨0ã«ãªã‚‰ãªã„ä¿é™ºï¼‰
    for(const key of ["k","h","t","o"]){
      for(let d=0; d<=9; d++){
        withNan[key][d] += 0.2;
      }
    }

    return withNan; // {k:[10],h:[10],t:[10],o:[10]}
  }

  // ä½åˆ¥ãƒˆãƒƒãƒ—4ã‚’å–ã‚Šå‡ºã™
  function top4FromScores(scoreArr){
    const idx = [...Array(10)].map((_,d)=>d).sort((a,b)=>scoreArr[b]-scoreArr[a]);
    const top4 = idx.slice(0,4);
    return top4.map(d => ({ d, sc: scoreArr[d] }));
  }

  function renderPosOut(posScore){
    const map = [
      {key:"k", title:"åƒã®ä½"},
      {key:"h", title:"ç™¾ã®ä½"},
      {key:"t", title:"åã®ä½"},
      {key:"o", title:"ä¸€ã®ä½"}
    ];

    const out = document.getElementById("posOut");
    out.innerHTML = "";

    for(const m of map){
      const top = top4FromScores(posScore[m.key]);
      const card = document.createElement("div");
      card.className = "posCard";
      card.innerHTML = `
        <div class="posTitle">${m.title}</div>
        ${top.map(x => `
          <div class="posRow">
            <div class="posNum">${x.d}</div>
            <div class="posScore">+${(Math.round(x.sc*10)/10).toFixed(1)}</div>
          </div>
        `).join("")}
      `;
      out.appendChild(card);
    }
  }

  // ===== ã€Œå¿…ãš2ã¤ã ã‘ã€ãƒ’ãƒ³ãƒˆé¸æŠœï¼ˆå…±é€šæœ€å„ªå…ˆï¼‰=====
  function pick2FromHint(meStr, sAll, prevStr, prev2Str, otherStr){
    const me = uniq(digits(meStr)).map(Number);
    const other = new Set(uniq(digits(otherStr)).map(Number));

    // å¼•ã£å¼µã‚Šé›†åˆ
    const pull = new Set( digits((prevStr||"") + (prev2Str||"")).map(Number) );

    const score = (d) => {
      let sc = 0;
      sc += (sAll?.[d] ?? 0) * 6;      // å…¨ä½“æ¿ƒã•ï¼ˆè»½ã‚ï¼‰
      if (pull.has(d)) sc += 18;       // å¼•ã£å¼µã‚Š
      sc += 2;                         // åŸºç¤ç‚¹
      if (me.some(x => x !== d && x + d === 9)) sc += 12; // è¶³ã™9
      if (me.some(x => x !== d && Math.abs(x - d) === 1)) sc += 6; // é€£ç•ª
      return sc;
    };

    const commons = me.filter(x => other.has(x));
    if (commons.length >= 2){
      return commons.sort((a,b)=>score(b)-score(a)).slice(0,2).map(String);
    }
    if (commons.length === 1){
      const rest = me.filter(x => x !== commons[0]).sort((a,b)=>score(b)-score(a));
      const second = (rest[0] ?? commons[0]);
      return [String(commons[0]), String(second)];
    }

    if (me.length >= 2){
      return me.sort((a,b)=>score(b)-score(a)).slice(0,2).map(String);
    }
    if (me.length === 1){
      const candidates = [...Array(10)].map((_,i)=>i).filter(x=>x!==me[0]);
      candidates.sort((a,b)=>score(b)-score(a));
      return [String(me[0]), String(candidates[0] ?? me[0])];
    }
    return ["4","8"];
  }

  // ===== è»¸2æ¡æ±ºå®šï¼šé–“å¼•ãå‰ã®ã€Œå…±é€šã€ã‚’æœ€å„ªå…ˆ =====
  function chooseAxisFromRaw(h1raw, h2raw, sAll){
    const a = uniq(digits(h1raw)).map(Number);
    const b = uniq(digits(h2raw)).map(Number);
    const setB = new Set(b);
    const score = (d) => (sAll?.[d] ?? 0);

    const commons = a.filter(x => setB.has(x));
    if (commons.length >= 2){
      commons.sort((x,y)=>score(y)-score(x));
      return [String(commons[0]), String(commons[1])];
    }
    if (commons.length === 1){
      const all = uniq([...a, ...b].filter(x => x !== commons[0]));
      all.sort((x,y)=>score(y)-score(x));
      const second = all[0] ?? commons[0];
      return [String(commons[0]), String(second)];
    }

    const all = uniq([...a, ...b]);
    all.sort((x,y)=>score(y)-score(x));
    if (all.length >= 2) return [String(all[0]), String(all[1])];
    return ["4","8"];
  }

  // ===== ãƒ—ãƒ¼ãƒ«ä½œæˆï¼ˆé‡ã¿ä»˜ãï¼šé‡è¤‡ã‚’æ®‹ã™ï¼‰=====
  function buildPoolWeighted(h1_2, h2_2, sAll, posScore){
    let p = [];
    p.push(...h1_2, ...h2_2);

    // è£æ•°å­—ï¼ˆãƒ’ãƒ³ãƒˆç”±æ¥ï¼‰
    for(const x of [...h1_2, ...h2_2]){
      const n = +x;
      if (ura[n] !== undefined) p.push(String(ura[n]));
    }

    // é€£ç•ªï¼ˆÂ±1ï¼‰
    for(const x of [...h1_2, ...h2_2]){
      const n = +x;
      if(n > 0) p.push(String(n-1));
      if(n < 9) p.push(String(n+1));
    }

    // å…¨ä½“ã‚¹ã‚³ã‚¢é‡ã¿ï¼ˆä¿å­˜100å›ã®å…¨ä½“å‚¾å‘ï¼‰
    for(let d=0; d<=9; d++){
      const w = Math.max(0, Math.round((sAll[d] ?? 0) * 1.2));
      for(let i=0;i<w;i++) p.push(String(d));
    }

    // ä½åˆ¥ã‚¹ã‚³ã‚¢ã®ãƒˆãƒƒãƒ—ã‚’å°‘ã—æ··ãœã‚‹ï¼ˆè§£æã®ä¸­èº«ï¼‰
    // â€»ä½åˆ¥ã¯æœ¬æ¥â€œå€™è£œã®çµã‚Šâ€ã«å¼·ã„ã®ã§ã€ãƒ—ãƒ¼ãƒ«ã«ã‚‚å¾®é‡å…¥ã‚Œã¦åã‚Šã‚’å‡ºã™
    const tops = [];
    for(const key of ["k","h","t","o"]){
      const top = top4FromScores(posScore[key]).slice(0,2).map(x=>String(x.d));
      tops.push(...top);
    }
    p.push(...tops);

    // ä¿é™ºï¼ˆæœ€ä½é™ï¼‰
    p.push("0","1","2","3","4","5","6","7","8","9");
    return p;
  }

  // ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆè¶³ã™9 / é€£ç•ªï¼‰ + ä½åˆ¥ã‚¹ã‚³ã‚¢åŠ ç‚¹ =====
  function rank(nums, posScore){
    return nums.map(n=>{
      let sc=0;
      const a = n.split("").map(Number);

      // ä½åˆ¥ã‚¹ã‚³ã‚¢ï¼ˆã¡ã‚ƒã‚“ã¨è§£æã®èŠ¯ï¼‰
      sc += (posScore.k[a[0]] ?? 0);
      sc += (posScore.h[a[1]] ?? 0);
      sc += (posScore.t[a[2]] ?? 0);
      sc += (posScore.o[a[3]] ?? 0);

      // æ—¢å­˜ï¼šè¶³ã™9 / é€£ç•ªï¼ˆãŠã¾ã‘ã¨ã—ã¦ç¶­æŒï¼‰
      for(let i=0;i<4;i++) for(let j=i+1;j<4;j++){
        if(a[i]+a[j]===9) sc += 2.2;
        if(Math.abs(a[i]-a[j])===1) sc += 1.4;
      }

      // ãƒ€ãƒ–ãƒ«/ã‚¾ãƒ­ç›®ï¼ˆè»½ã‚ï¼‰
      const counts = Array(10).fill(0);
      a.forEach(x=>counts[x]++);
      const maxc = Math.max(...counts);
      if(maxc>=2) sc += 1.2;
      if(maxc>=3) sc += 1.0;

      return { n, sc };
    }).sort((A,B)=>B.sc - A.sc);
  }

  // å¼·ã•ãƒ©ãƒ™ãƒ«ï¼ˆbestæ¯”ï¼‰
  function tierLabel(score, best){
    if(best <= 0) return { badge:"â˜…", label:"å¼±" };
    const r = score / best;
    if(r >= 0.92) return { badge:"â˜…â˜…â˜…", label:"å¼·" };
    if(r >= 0.86) return { badge:"â˜…â˜…",  label:"ä¸­" };
    return { badge:"â˜…",   label:"å¼±" };
  }

  function formatRows(rows){
    if(!rows || rows.length === 0) return "ï¼ˆãªã—ï¼‰";
    return rows.map(x => `${x.i}ä½  ${x.badge} [${x.label}]  ${x.num}`).join("\n");
  }

  function splitRanked(ranked, limit=10){
    if(!ranked || ranked.length === 0) return { main: [], ins: [], rows: [] };
    const best = ranked[0].sc;

    const rows = ranked.slice(0, limit).map((r, idx) => {
      const t = tierLabel(r.sc, best);
      return { i: idx+1, num: r.n, badge: t.badge, label: t.label, sc: r.sc };
    });

    return {
      rows,
      main: rows.filter(x => x.label === "å¼·"),
      ins : rows.filter(x => x.label !== "å¼·")
    };
  }

  // ã€Œä»Šæ—¥ã¯å¼·ã„æ—¥ã€ï¼šæœ¬å‘½ä»¶æ•°ã§åˆ¤å®š
  function judgeDayPower(mainCount){
    if(mainCount >= 5) return "ğŸ”¥ ä»Šæ—¥ã¯å¼·ã„æ—¥ï¼ˆé›†ä¸­å‹è² ï¼‰";
    if(mainCount >= 3) return "â— æ™®é€šã®æ—¥ï¼ˆãƒãƒ©ãƒ³ã‚¹ï¼‰";
    return "â–³ åˆ†æ•£ã®æ—¥ï¼ˆç„¡ç†ã—ãªã„ï¼‰";
  }

  // ===== åˆ¤å®šç”¨ =====
  function posMatch(a,b){
    let c=0;
    for(let i=0;i<4;i++) if(a[i]===b[i]) c++;
    return c;
  }
  function digitMatchCount(a,b){
    const ca = Array(10).fill(0);
    const cb = Array(10).fill(0);
    for(const ch of a) ca[+ch]++;
    for(const ch of b) cb[+ch]++;
    let sum=0;
    for(let i=0;i<10;i++) sum += Math.min(ca[i], cb[i]);
    return sum;
  }
  function inGroup(num, groupRows){
    return groupRows.find(r => r.num === num) || null;
  }
  function setKey(num){
    return num.split("").sort().join("");
  }

  // ===== ç”Ÿæˆæœ¬ä½“ =====
  function generate(){
    // ã¾ãš prev/prev2 ã‚’å±¥æ­´ã‹ã‚‰åŒæœŸï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¿å­˜ã—ã¦ã‚‹å‰æã®é‹ç”¨ï¼‰
    syncPrevFieldsFromHistory();

    // ä¿å­˜100å›ã‹ã‚‰ä½åˆ¥ã‚¹ã‚³ã‚¢ã‚’ä½œã‚‹ï¼ˆè§£æã®èŠ¯ï¼‰
    const posScore = buildPositionScores();
    STATE.posScore = posScore;

    // ä½åˆ¥ãƒˆãƒƒãƒ—4è¡¨ç¤º
    renderPosOut(posScore);

    // ä¿å­˜100å›ã®ã€Œå…¨ä½“é »åº¦ã€ã‚‚ç”¨æ„ï¼ˆãƒ’ãƒ³ãƒˆé¸æŠœãƒ»è»¸ã«ä½¿ã†ï¼‰
    const { all } = buildHistoryStats();
    const sAll = all.map(x => x); // 0..9

    const prevStr  = document.getElementById("prev").value;
    const prev2Str = document.getElementById("prev2").value;

    const h1raw = document.getElementById("hint1").value;
    const h2raw = document.getElementById("hint2").value;

    // ãƒ’ãƒ³ãƒˆã¯å¿…ãš2ã¤ã«çŸ¯æ­£ï¼ˆå…±é€šå„ªå…ˆï¼‰
    const h1_2 = pick2FromHint(h1raw, sAll, prevStr, prev2Str, h2raw);
    const h2_2 = pick2FromHint(h2raw, sAll, prevStr, prev2Str, h1raw);

    // è»¸ã¯ã€Œé–“å¼•ãå‰ã®å…±é€šã€ã‚’æœ€å„ªå…ˆ
    const axisArr = chooseAxisFromRaw(h1raw, h2raw, sAll);
    const axis = axisArr[0] + axisArr[1];
    STATE.axis = axis;

    // ãƒ—ãƒ¼ãƒ«ï¼ˆé‡ã¿ä»˜ãï¼‰
    const pool = buildPoolWeighted(h1_2, h2_2, sAll, posScore);

    // å…¥åŠ›ã‹ã‚‰ã‚·ãƒ¼ãƒ‰å›ºå®šï¼ˆåŒã˜å…¥åŠ›â†’åŒã˜çµæœï¼‰
    const hist = loadHistory().join(",");
    const seedStr =
      h1raw + "|" + h2raw + "|" +
      prevStr + "|" + prev2Str + "|" +
      hist;

    const rand = mulberry32(hash32(seedStr));

    // å€™è£œ100æœ¬ï¼ˆåŒã˜å…¥åŠ›ãªã‚‰åŒã˜100æœ¬ï¼‰
    let list = [];
    while(list.length < 100){
      let n = [axisArr[0], axisArr[1]];
      while(n.length < 4) n.push(pick(pool, rand));
      list.push(n.join(""));
    }

    // ãƒ¦ãƒ‹ãƒ¼ã‚¯â†’ãƒ©ãƒ³ã‚¯ï¼ˆä½åˆ¥ã‚¹ã‚³ã‚¢ã‚’åæ˜ ï¼‰
    const ranked = rank(uniq(list), posScore);
    const top10 = ranked.slice(0, 10);
    const sp = splitRanked(top10, 10);

    document.getElementById("dayPower").textContent = judgeDayPower(sp.main.length);
    document.getElementById("straightMain").textContent = formatRows(sp.main);
    document.getElementById("straightIns").textContent  = formatRows(sp.ins);

    // ã‚»ãƒƒãƒˆï¼štop10ã‚’ã‚»ãƒƒãƒˆã‚­ãƒ¼ã«ã—ã¦ãƒ©ãƒ³ã‚¯
    const setNums = uniq(top10.map(r => setKey(r.n)));
    const setRanked = rank(setNums.map(x => x), {k:Array(10).fill(0),h:Array(10).fill(0),t:Array(10).fill(0),o:Array(10).fill(0)}).slice(0,10);
    // â†‘ ã‚»ãƒƒãƒˆã¯é †ä¸åŒã‚­ãƒ¼ãªã®ã§ä½åˆ¥ã‚¹ã‚³ã‚¢ã¯ä½¿ã‚ãšã€æ—¢å­˜ã®è¶³ã™9/é€£ç•ª(è»½ã‚)ã ã‘ã§ç¶­æŒ
    const setSplit = splitRanked(setRanked, 10);

    document.getElementById("setMain").textContent = formatRows(setSplit.main);
    document.getElementById("setIns").textContent  = formatRows(setSplit.ins);

    // STATEä¿å­˜ï¼ˆåˆ¤å®šã§ä½¿ã†ï¼‰
    STATE.topStraightRows = sp.rows;
    STATE.straightMain = sp.main;
    STATE.straightIns = sp.ins;

    STATE.topSetRows = setSplit.rows;
    STATE.setMain = setSplit.main;
    STATE.setIns = setSplit.ins;

    // ç”Ÿæˆç›´å¾Œã¯åˆ¤å®šè¡¨ç¤ºã‚’è»½ããƒªã‚»ãƒƒãƒˆ
    document.getElementById("judgeOut").innerHTML =
      `<span class="ok">ç”ŸæˆOK</span>ï¼ˆè»¸ <span class="mono">${STATE.axis}</span>ï¼‰  çµæœãŒå‡ºãŸã‚‰å½“é¸ç•ªå·ã‚’å…¥ã‚Œã¦ã€Œåˆ¤å®šã€ã—ã¦ã­ã€‚`;

    toast("è§£æâ†’ç”Ÿæˆ å®Œäº†");
  }

  // ===== çµæœåˆ¤å®šï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼‹ã‚»ãƒƒãƒˆä¸¡æ–¹ï¼‰=====
  function judge(){
    const win = normalize4(document.getElementById("win").value);
    const out = document.getElementById("judgeOut");

    if(!win){
      out.innerHTML = `<span class="warn">å½“é¸ç•ªå·ã¯4æ¡ã§å…¥ã‚Œã¦ã­</span>`;
      return;
    }

    if(!STATE.topStraightRows || STATE.topStraightRows.length === 0){
      out.innerHTML = `<span class="warn">å…ˆã«ã€Œç•ªå·ã‚’ç”Ÿæˆã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ã­</span>`;
      return;
    }

    const axis = STATE.axis;
    const axisHit = (win.includes(axis[0]) && win.includes(axis[1])) || (win[0]+win[1]===axis);

    const sMainHit = inGroup(win, STATE.straightMain);
    const sInsHit  = inGroup(win, STATE.straightIns);
    const sAnyHit  = inGroup(win, STATE.topStraightRows);

    const winKey = setKey(win);
    const setMainHit = inGroup(winKey, STATE.setMain);
    const setInsHit  = inGroup(winKey, STATE.setIns);
    const setAnyHit  = inGroup(winKey, STATE.topSetRows);

    let bestPos = 0;
    let bestDigit = 0;
    for(const r of STATE.topStraightRows){
      bestPos = Math.max(bestPos, posMatch(win, r.num));
      bestDigit = Math.max(bestDigit, digitMatchCount(win, r.num));
    }

    let headline = "";
    let detail = [];

    if(sMainHit || setMainHit){
      headline = "ğŸ”¥ æ¿€ã‚¢ãƒ„ï¼ˆèª­ã¿ãŒå°„ç¨‹åœï¼‰";
    } else if(sInsHit || setInsHit){
      headline = "â— æƒœã—ã„ï¼ˆæµã‚Œã¯åˆã£ã¦ã‚‹ï¼‰";
    } else if(sAnyHit || setAnyHit || bestPos >= 3){
      headline = "â—‹ æµã‚ŒOKï¼ˆã‚ã¨ä¸€æ­©ï¼‰";
    } else if(bestDigit >= 2 || axisHit){
      headline = "â–³ åˆ†æ•£ã®æ—¥ï¼ˆç„¡ç†ã—ãªã„ï¼‰";
    } else {
      headline = "Ã— ã‚ºãƒ¬ï¼ˆä»Šæ—¥ã¯æµã‚Œé•ã„ï¼‰";
    }

    detail.push(`å½“é¸ï¼š<span class="mono">${win}</span>`);
    detail.push(`è»¸ï¼š<span class="mono">${axis}</span>ã€€/ã€€è»¸ä¸€è‡´ï¼š<span class="${axisHit?'ok':'warn'}">${axisHit?'â—‹':'Ã—'}</span>`);

    if(sMainHit){
      detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼š<span class="ok">æœ¬å‘½ï¼ˆå¼·ï¼‰</span>ã€€${sMainHit.i}ä½`);
    } else if(sInsHit){
      detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼š<span class="ok">ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</span>ã€€${sInsHit.i}ä½`);
    } else if(sAnyHit){
      detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼š<span class="ok">åœå†…</span>ã€€${sAnyHit.i}ä½`);
    } else {
      detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼šåœå¤–ï¼ˆè¿‘ã•ï¼šä½ç½®ä¸€è‡´max ${bestPos}/4ã€æ•°å­—ä¸€è‡´max ${bestDigit}/4ï¼‰`);
    }

    if(setMainHit){
      detail.push(`ã‚»ãƒƒãƒˆï¼š<span class="ok">æœ¬å‘½ï¼ˆå¼·ï¼‰</span>ã€€${setMainHit.i}ä½ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
    } else if(setInsHit){
      detail.push(`ã‚»ãƒƒãƒˆï¼š<span class="ok">ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</span>ã€€${setInsHit.i}ä½ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
    } else if(setAnyHit){
      detail.push(`ã‚»ãƒƒãƒˆï¼š<span class="ok">åœå†…</span>ã€€${setAnyHit.i}ä½ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
    } else {
      detail.push(`ã‚»ãƒƒãƒˆï¼šåœå¤–ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
    }

    out.innerHTML =
      `<div class="big">${headline}</div>` +
      `<div style="margin-top:8px;line-height:1.7">${detail.map(x=>`ãƒ»${x}`).join("<br>")}</div>`;
  }

  // åˆæœŸåŒ–ï¼šå±¥æ­´ãŒã‚ã‚Œã° prev/prev2 ã‚’è‡ªå‹•åæ˜ 
  (function init(){
    syncPrevFieldsFromHistory();
    // æœ€åˆã¯ä½åˆ¥ã‚‚ç©ºè¡¨ç¤ºã«ã—ãªã„ï¼ˆé›°å›²æ°—ï¼‰
    const hist = loadHistory();
    if(hist.length >= 5){
      // ãƒ’ãƒ³ãƒˆæœªå…¥åŠ›ã§ã‚‚ä½åˆ¥è§£æã ã‘ã¯è¦‹ã‚‰ã‚Œã‚‹ï¼ˆè§£æã®èŠ¯ãŒä¿å­˜ã ã‹ã‚‰ï¼‰
      const posScore = buildPositionScores();
      STATE.posScore = posScore;
      renderPosOut(posScore);
    }
  })();
</script>

</body>
</html>
