<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒŠãƒ³ãƒãƒ¼ã‚º4 å®Œæˆç‰ˆ</title>
  <style>
    body{font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;padding:16px;max-width:920px;margin:auto}
    h1{font-size:34px;margin:10px 0 18px}
    input,button{font-size:16px;padding:12px;width:100%;box-sizing:border-box;margin:8px 0;border-radius:14px;border:1px solid #e5e5e5}
    button{background:#111;color:#fff;border:none;border-radius:999px;padding:16px;font-weight:900}
    button.ghost{background:#fff;color:#111;border:1px solid #e5e5e5}
    .box{background:#fafafa;border:1px solid #eee;border-radius:16px;padding:14px;margin-top:12px}
    .label{font-weight:900;margin-top:6px}
    pre{white-space:pre-wrap;background:#f7f7f7;border-radius:14px;padding:12px;border:1px solid #eee}
    .day{font-weight:900;margin:8px 0 0}
    .note{color:#666;font-size:12px;margin-top:6px;line-height:1.55}
    h2{margin-top:22px}
    h3{margin:12px 0 6px}
    .resultBox{background:#fff;border:1px solid #eee;border-radius:16px;padding:14px;margin-top:12px}
    .big{font-size:18px;font-weight:900}
    .ok{color:#0a7;font-weight:900}
    .warn{color:#b00020;font-weight:900}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1 1 220px}
    .tiny{font-size:12px;color:#666}
    .pill{display:inline-block;border:1px solid #eee;background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;color:#333}
    .divider{height:1px;background:#eee;margin:10px 0}
    /* ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆäºˆæƒ³ï¼ˆåƒç™¾åä¸€ï¼‰ */
    .posGrid{
      display:grid;
      grid-template-columns: repeat(4, minmax(160px, 1fr));
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 760px){
      .posGrid{grid-template-columns: repeat(2, minmax(160px, 1fr));}
    }
    @media (max-width: 420px){
      .posGrid{grid-template-columns: 1fr;}
    }
    .posCard{
      background:#fff;
      border:2px solid #111;
      border-radius:18px;
      padding:12px 12px 10px;
    }
    .posTitle{font-weight:900;font-size:18px;margin:2px 0 10px}
    .cand{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .candRow{
      display:flex;
      align-items:baseline;
      justify-content:center;
      flex-direction:column;
      gap:2px;
      padding:8px 0;
      border-top:1px solid #eee;
    }
    .candRow:first-child{border-top:none}
    .candNum{font-size:34px;font-weight:900;line-height:1}
    .candScore{font-size:14px;color:#666}
    .btnStack{display:flex;gap:10px;flex-wrap:wrap}
    .btnStack button{flex:1 1 220px}
  </style>
</head>
<body>

  <h1>ãƒŠãƒ³ãƒãƒ¼ã‚º4 å®Œæˆç‰ˆ</h1>

  <div class="box">
    <div class="label">ãƒ’ãƒ³ãƒˆ1ï¼ˆä¾‹ï¼š168 / 1ãƒ»6ãƒ»8ï¼‰</div>
    <input id="hint1" inputmode="numeric" placeholder="ãƒ’ãƒ³ãƒˆ1 ä¾‹ï¼š168">

    <div class="label">ãƒ’ãƒ³ãƒˆ2ï¼ˆä¾‹ï¼š3920 / 3ãƒ»9ãƒ»2ãƒ»0ï¼‰</div>
    <input id="hint2" inputmode="numeric" placeholder="ãƒ’ãƒ³ãƒˆ2 ä¾‹ï¼š3920">

    <div class="label">å‰å›ï¼ˆä»»æ„ï¼‰</div>
    <input id="prev" inputmode="numeric" placeholder="å‰å› ä¾‹ï¼š5105" maxlength="4">

    <div class="label">å‰ã€…å›ï¼ˆä»»æ„ï¼‰</div>
    <input id="prev2" inputmode="numeric" placeholder="å‰ã€…å› ä¾‹ï¼š4588" maxlength="4">

    <div class="note">
      â€»ã€Œç›´è¿‘10å›ã€æ¬„ã¯å»ƒæ­¢ã€‚<strong>ä¿å­˜ã—ãŸéå»100å›</strong>ã‚’å†…è‡“ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è§£æã«ä½¿ã†ã€‚<br>
      â€»åŒã˜å…¥åŠ›ï¼‹åŒã˜ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãªã‚‰ä½•å›æŠ¼ã—ã¦ã‚‚åŒã˜çµæœï¼ˆãƒ–ãƒ¬ãªã„ï¼‰<br>
      â€»18æ™‚ã‚®ãƒªã‚®ãƒªã®ãƒªãƒãƒ¼ã‚µãƒ«æ•°å­—ã¯ä¿å­˜ã—ãªã„ï¼ˆã‚†ã†ã¡ã‚ƒã‚“æ–¹é‡ï¼‰
    </div>

    <div class="btnStack">
      <button type="button" onclick="generateAll()">ğŸ”® äºˆæƒ³ã‚’ç”Ÿæˆã™ã‚‹</button>
      <button type="button" class="ghost" onclick="openStorageTools()">ğŸ§  ä¿å­˜ãƒ‡ãƒ¼ã‚¿ï¼ˆå†…è‡“ï¼‰ãƒ„ãƒ¼ãƒ«</button>
    </div>

    <div id="storageHint" class="tiny" style="margin-top:6px;"></div>
  </div>

  <div class="resultBox">
    <div class="label">å½“é¸ç•ªå·ï¼ˆçµæœãŒå‡ºãŸã‚‰ã“ã“ã«4æ¡ï¼‰</div>
    <input id="win" inputmode="numeric" placeholder="ä¾‹ï¼š7263" maxlength="4">

    <div class="btnStack">
      <button type="button" onclick="saveDraw()">ğŸ“¥ æŠ½é¸çµæœã‚’ä¿å­˜ï¼ˆæœ€æ–°100å›ã«è¿½è¨˜ï¼‰</button>
      <button type="button" class="ghost" onclick="judge()">âœ… çµæœã‚’åˆ¤å®šã™ã‚‹</button>
    </div>

    <div id="judgeOut" class="mono" style="margin-top:10px;"></div>
    <div class="note">â€»åˆ¤å®šã¯ã€Œã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼‹ã‚»ãƒƒãƒˆã€ä¸¡æ–¹ã‚’è¦‹ã‚‹ï¼ˆã‚†ã†ã¡ã‚ƒã‚“æŒ‡å®šï¼‰</div>

    <div id="storageTools" style="display:none;margin-top:12px;">
      <div class="divider"></div>
      <div class="label">ä¿å­˜ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼ˆè¡¨ã«ã¯å‡ºã•ãªã„ / å†…è‡“ï¼‰</div>
      <div class="note">
        ãƒ»ä¿å­˜ã¯ç«¯æœ«å†…ï¼ˆlocalStorageï¼‰<br>
        ãƒ»æœ€å¤§100å›ã‚’ã‚­ãƒ¼ãƒ—ï¼š101å›ç›®ã‹ã‚‰å¤ã„1ä»¶ã‚’è‡ªå‹•ã§å‰Šé™¤
      </div>

      <div class="row">
        <button type="button" class="ghost" onclick="exportHistory()">ğŸ“¤ 100å›ã‚’ãƒ†ã‚­ã‚¹ãƒˆã§æ›¸ãå‡ºã—ï¼ˆã‚³ãƒ”ãƒ¼ç”¨ï¼‰</button>
        <button type="button" class="ghost" onclick="importHistory()">ğŸ“¥ ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ä¸€æ‹¬å–ã‚Šè¾¼ã¿</button>
      </div>

      <div class="label">å–ã‚Šè¾¼ã¿ç”¨ï¼ˆè²¼ã‚Šä»˜ã‘æ¬„ï¼‰</div>
      <input id="bulk" placeholder="ä¾‹ï¼š9827â†’6120â†’4588â†’7964 ...ï¼ˆæ•°å­—ã ã‘æ‹¾ã†ï¼‰" />

      <div class="row">
        <button type="button" class="ghost" onclick="clearHistory()">ğŸ—‘ ä¿å­˜100å›ã‚’å…¨æ¶ˆã—</button>
        <button type="button" class="ghost" onclick="closeStorageTools()">é–‰ã˜ã‚‹</button>
      </div>

      <pre id="historyOut" class="mono" style="display:none;margin-top:10px;"></pre>
    </div>
  </div>

  <h2>ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆäºˆæƒ³ï¼ˆåƒ/ç™¾/å/ä¸€ï¼‰</h2>
  <div class="note">
    ã“ã“ã¯ã€Œå‰å›ã‚’å†™ã™ã ã‘ã€ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã€<strong>ä¿å­˜100å›</strong>ã®ä½ç½®åˆ¥é »åº¦ï¼‹ç›´è¿‘é‡ã¿ï¼‹è£æ•°å­—ï¼‹ã‚ºãƒ¬ï¼ˆãƒŠãƒ³ã¡ã‚ƒã‚“åŠ ç‚¹ï¼‰ã§ã‚¹ã‚³ã‚¢åŒ–ã—ã¦ã€å„æ¡ã®å€™è£œã‚’4ã¤å‡ºã™ã€‚
  </div>

  <div class="posGrid">
    <div class="posCard">
      <div class="posTitle">åƒã®ä½</div>
      <div id="pos1000" class="cand"></div>
    </div>
    <div class="posCard">
      <div class="posTitle">ç™¾ã®ä½</div>
      <div id="pos100" class="cand"></div>
    </div>
    <div class="posCard">
      <div class="posTitle">åã®ä½</div>
      <div id="pos10" class="cand"></div>
    </div>
    <div class="posCard">
      <div class="posTitle">ä¸€ã®ä½</div>
      <div id="pos1" class="cand"></div>
    </div>
  </div>

  <h2>ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</h2>
  <div id="dayPower" class="day"></div>

  <h3>æœ¬å‘½ï¼ˆå¼·ï¼‰</h3>
  <pre id="straightMain">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>

  <h3>ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</h3>
  <pre id="straightIns">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>

  <h2>ã‚»ãƒƒãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</h2>

  <h3>æœ¬å‘½ï¼ˆå¼·ï¼‰</h3>
  <pre id="setMain">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>

  <h3>ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</h3>
  <pre id="setIns">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>

<script>
  // =========================
  // 0) å†…è‡“ä¿å­˜ï¼ˆéå»100å›ï¼‰
  // =========================
  const STORAGE_KEY = "n4_history_v1"; // 4æ¡æ–‡å­—åˆ—ã®é…åˆ—ï¼ˆæœ€æ–°â†’å¤ã„ï¼‰
  function digits(str){ return (str || "").match(/\d/g) || []; }

  function normalize4(str){
    const d = digits(str).slice(0,4);
    if(d.length !== 4) return null;
    return d.join("");
  }

  function loadHistory(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      if(!Array.isArray(arr)) return [];
      return arr.map(x=>normalize4(String(x))).filter(Boolean).slice(0,100);
    }catch(e){
      return [];
    }
  }
  function saveHistory(arr){
    const clean = (arr||[]).map(x=>normalize4(String(x))).filter(Boolean).slice(0,100);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(clean));
    updateStorageHint();
  }
  function pushHistory(num4){
    const cur = loadHistory();
    const n = normalize4(num4);
    if(!n) return false;
    cur.unshift(n);
    const next = cur.slice(0,100);
    saveHistory(next);
    return true;
  }

  function updateStorageHint(){
    const n = loadHistory().length;
    const el = document.getElementById("storageHint");
    el.innerHTML = `<span class="pill">å†…è‡“ä¿å­˜ï¼š${n}ä»¶ / 100ä»¶</span>`;
  }

  function openStorageTools(){
    document.getElementById("storageTools").style.display = "block";
    document.getElementById("historyOut").style.display = "none";
  }
  function closeStorageTools(){
    document.getElementById("storageTools").style.display = "none";
  }

  function exportHistory(){
    const h = loadHistory();
    const pre = document.getElementById("historyOut");
    pre.style.display = "block";
    pre.textContent = h.join("â†’");
  }

  function importHistory(){
    const raw = document.getElementById("bulk").value || "";
    const list = [];
    const only = digits(raw).join("");
    for(let i=0;i+3<only.length;i+=4){
      const n = only.slice(i,i+4);
      if(n.length===4) list.push(n);
    }
    if(list.length===0){
      alert("å–ã‚Šè¾¼ã¿å¤±æ•—ï¼š4æ¡ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚ˆ");
      return;
    }
    saveHistory(list.slice(0,100));
    alert(`å–ã‚Šè¾¼ã¿OKï¼š${Math.min(list.length,100)}ä»¶ ä¿å­˜ã—ãŸ`);
  }

  function clearHistory(){
    if(confirm("ä¿å­˜100å›ã‚’å…¨éƒ¨æ¶ˆã™ï¼Ÿï¼ˆå…ƒã«æˆ»ã›ãªã„ï¼‰")){
      localStorage.removeItem(STORAGE_KEY);
      updateStorageHint();
      alert("æ¶ˆã—ãŸã‚ˆ");
    }
  }

  // âœ… è¿½åŠ ï¼šä¿å­˜ãƒœã‚¿ãƒ³ã§ prev/prev2 ã‚’è‡ªå‹•æ›´æ–°ï¼ˆæ‰‹é–“ã‚¼ãƒ­ï¼‰
  function autoUpdatePrevFields(savedWin){
    const prevEl = document.getElementById("prev");
    const prev2El = document.getElementById("prev2");

    const currentPrev = normalize4(prevEl.value); // å…ƒã®å‰å›ï¼ˆç©ºã§ã‚‚OKï¼‰
    // å‰ã€…å› â† å‰å›ã€å‰å› â† ä»Šå›ä¿å­˜
    if(currentPrev){
      prev2El.value = currentPrev;
    }
    prevEl.value = savedWin;
  }

  function saveDraw(){
    const win = normalize4(document.getElementById("win").value);
    if(!win){
      alert("å½“é¸ç•ªå·ã¯4æ¡ã§å…¥ã‚Œã¦ã­");
      return;
    }

    // 1) å†…è‡“100å›ã«è¿½è¨˜
    pushHistory(win);

    // 2) å‰å›/å‰ã€…å›ã‚’è‡ªå‹•æ›´æ–°ï¼ˆã“ã“ãŒè¿½åŠ ï¼‰
    autoUpdatePrevFields(win);

    // 3) ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const out = document.getElementById("judgeOut");
    out.innerHTML =
      `<span class="ok">ä¿å­˜OK</span>ï¼š<span class="mono">${win}</span> ã‚’å†…è‡“ãƒ‡ãƒ¼ã‚¿ã«è¿½è¨˜ã€‚` +
      `ã•ã‚‰ã« <span class="mono">å‰å›</span> ã‚’è‡ªå‹•æ›´æ–°ã—ãŸã‚ˆã€‚` +
      `å¿…è¦ãªã‚‰ã€Œäºˆæƒ³ã‚’ç”Ÿæˆã™ã‚‹ã€ã§æœ€æ–°åæ˜ ã—ã¦ã­ã€‚`;
  }

  // =========================
  // 1) è£æ•°å­—ï¼ˆã‚†ã†ã¡ã‚ƒã‚“å®šç¾©ï¼‰
  // =========================
  const ura = {0:5,5:0,1:6,6:1,2:7,7:2,3:8,8:3,4:9,9:4};

  // ãƒŠãƒ³ã¡ã‚ƒã‚“åŠ ç‚¹ï¼šã‚ºãƒ¬
  function zure1(d){ return [((d+1)%10), ((d+9)%10)]; } // Â±1
  function zure2(d){ return [((d+2)%10), ((d+8)%10)]; } // Â±2

  // =========================
  // 2) çŠ¶æ…‹ä¿æŒï¼ˆåˆ¤å®šã«ä½¿ã†ï¼‰
  // =========================
  const STATE = {
    axis: "48",
    topStraightRows: [],
    topSetRows: [],
    straightMain: [],
    straightIns: [],
    setMain: [],
    setIns: [],
  };

  // =========================
  // 3) å®‰å®šä¹±æ•°ï¼ˆåŒå…¥åŠ›ï¼‹åŒä¿å­˜ï¼åŒçµæœï¼‰
  // =========================
  function hash32(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }
  function mulberry32(seed){
    return function(){
      let t = seed += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }
  function pick(pool, rand){
    return pool[Math.floor(rand() * pool.length)];
  }
  function uniq(arr){
    const s = new Set(), out=[];
    for(const x of arr){ if(!s.has(x)){ s.add(x); out.push(x); } }
    return out;
  }

  // =========================
  // 4) ä¿å­˜100å› â†’ è§£æã‚³ã‚¢
  // =========================
  function argmax(arr){
    if(!arr || arr.length===0) return null;
    let best = -Infinity, bi = 0;
    for(let i=0;i<arr.length;i++){
      if(arr[i] > best){ best = arr[i]; bi = i; }
    }
    return bi;
  }

  // ä½ç½®åˆ¥ï¼ˆåƒ/ç™¾/å/ä¸€ï¼‰
  function buildPositionScores(){
    const hist = loadHistory(); // æœ€æ–°â†’å¤ã„
    const scores = [
      Array(10).fill(0), // åƒ
      Array(10).fill(0), // ç™¾
      Array(10).fill(0), // å
      Array(10).fill(0), // ä¸€
    ];

    const recentN = Math.min(20, hist.length);

    for(let idx=0; idx<hist.length; idx++){
      const n = hist[idx];
      const w = (idx < recentN) ? 2 : 1;
      for(let pos=0; pos<4; pos++){
        const d = +n[pos];
        scores[pos][d] += w;
      }
    }

    // ãƒŠãƒ³ã¡ã‚ƒã‚“åŠ ç‚¹ï¼ˆä½ç½®åˆ¥ï¼‰
    for(let pos=0; pos<4; pos++){
      const arr = scores[pos];
      const topDigit = argmax(arr);
      if(topDigit !== null){
        const u = ura[topDigit];
        if(u !== undefined) arr[u] += 2;           // è£
        zure1(topDigit).forEach(x=>arr[x]+=2);     // 1ã‚ºãƒ¬
        zure2(topDigit).forEach(x=>arr[x]+=1);     // 2ã‚ºãƒ¬ï¼ˆå¼±ã‚ï¼‰
      }
    }

    return scores;
  }

  // å…¨ä½“ï¼ˆ0-9ï¼‰
  function scoreDigitsFromHistory(){
    const hist = loadHistory();
    const s = Array(10).fill(0);
    const recentN = Math.min(20, hist.length);

    for(let idx=0; idx<hist.length; idx++){
      const n = hist[idx];
      const w = (idx < recentN) ? 2 : 1;
      for(const ch of n) s[+ch] += w;
    }

    const top = argmax(s);
    if(top !== null){
      const u = ura[top];
      if(u !== undefined) s[u] += 2;
      zure1(top).forEach(x=>s[x]+=2);
      zure2(top).forEach(x=>s[x]+=1);
    }

    return s;
  }

  // =========================
  // 5) ãƒ’ãƒ³ãƒˆã¯ã€Œå¿…ãš2ã¤ã ã‘ã€
  // =========================
  function pick2FromHint(meStr, s, prevStr, prev2Str, otherStr){
    const me = uniq(digits(meStr)).map(Number);
    const other = new Set(uniq(digits(otherStr)).map(Number));

    const pull = new Set(digits((prevStr||"") + (prev2Str||"")).map(Number));

    const score = (d) => {
      let sc = 0;
      sc += (s?.[d] ?? 0) * 10;
      if(pull.has(d)) sc += 12;
      if(ura[d] !== undefined) sc += 2;
      if(me.some(x => x !== d && x + d === 9)) sc += 10;
      if(me.some(x => x !== d && Math.abs(x - d) === 1)) sc += 6;
      if(me.some(x => x !== d && Math.abs(x - d) === 2)) sc += 3;
      sc += 1;
      return sc;
    };

    const commons = me.filter(x => other.has(x));
    if(commons.length >= 2){
      return commons.sort((a,b)=>score(b)-score(a)).slice(0,2).map(String);
    }
    if(commons.length === 1){
      const rest = me.filter(x => x !== commons[0]).sort((a,b)=>score(b)-score(a));
      const second = (rest[0] ?? commons[0]);
      return [String(commons[0]), String(second)];
    }

    if(me.length >= 2){
      return me.sort((a,b)=>score(b)-score(a)).slice(0,2).map(String);
    }
    if(me.length === 1){
      const candidates = [...Array(10)].map((_,i)=>i).filter(x=>x!==me[0]);
      candidates.sort((a,b)=>score(b)-score(a));
      return [String(me[0]), String(candidates[0] ?? me[0])];
    }
    return ["4","8"];
  }

  function chooseAxisFromRaw(h1raw, h2raw, s){
    const a = uniq(digits(h1raw)).map(Number);
    const b = uniq(digits(h2raw)).map(Number);
    const setB = new Set(b);
    const score = (d) => (s?.[d] ?? 0);

    const commons = a.filter(x => setB.has(x));
    if(commons.length >= 2){
      commons.sort((x,y)=>score(y)-score(x));
      return [String(commons[0]), String(commons[1])];
    }
    if(commons.length === 1){
      const all = uniq([...a, ...b].filter(x => x !== commons[0]));
      all.sort((x,y)=>score(y)-score(x));
      const second = all[0] ?? commons[0];
      return [String(commons[0]), String(second)];
    }

    const all = uniq([...a, ...b]);
    all.sort((x,y)=>score(y)-score(x));
    if(all.length >= 2) return [String(all[0]), String(all[1])];
    return ["4","8"];
  }

  // =========================
  // 6) ãƒ—ãƒ¼ãƒ«ï¼ˆé‡ã¿ä»˜ã‘ï¼‰
  // =========================
  function buildPoolWeighted(h1_2, h2_2, s){
    let p = [];
    p.push(...h1_2, ...h2_2);

    for(const x of [...h1_2, ...h2_2]){
      const n = +x;
      if(ura[n] !== undefined) p.push(String(ura[n]));
    }

    for(const x of [...h1_2, ...h2_2]){
      const n = +x;
      zure1(n).forEach(z => p.push(String(z)));
      zure2(n).forEach(z => p.push(String(z)));
    }

    for(let d=0; d<=9; d++){
      const w = Math.min(10, Math.floor((s[d] ?? 0)));
      for(let i=0;i<w;i++) p.push(String(d));
    }

    p.push("0","1","2","3","4","5","6","7","8","9");
    return p;
  }

  // =========================
  // 7) ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆè¶³ã™9/é€£ç•ªï¼‹ãƒŠãƒ³ã¡ã‚ƒã‚“åŠ ç‚¹ï¼‰
  // =========================
  function scoreNumberNanChan(n){
    const a = n.split("").map(Number);
    let sc = 0;

    for(let i=0;i<4;i++) for(let j=i+1;j<4;j++){
      if(a[i]+a[j]===9) sc += 3;
      if(Math.abs(a[i]-a[j])===1) sc += 2;
      if(Math.abs(a[i]-a[j])===2) sc += 1;
    }

    for(let i=0;i<4;i++){
      const u = ura[a[i]];
      if(u !== undefined && a.includes(u)) sc += 1;
    }

    const cnt = Array(10).fill(0);
    a.forEach(x=>cnt[x]++);
    const maxc = Math.max(...cnt);
    const pairs = cnt.filter(x=>x===2).length;

    if(maxc >= 2) sc += 2;
    if(pairs === 2) sc += 4;
    if(maxc === 3) sc += 6;
    if(maxc === 4) sc += 10;

    return sc;
  }

  function rank(nums){
    return nums.map(n=>{
      let sc = 0;
      sc += scoreNumberNanChan(n);
      return { n, sc };
    }).sort((A,B)=>B.sc - A.sc);
  }

  function tierLabel(score, best){
    if(best <= 0) return { badge:"â˜…", label:"å¼±" };
    const r = score / best;
    if(r >= 0.92) return { badge:"â˜…â˜…â˜…", label:"å¼·" };
    if(r >= 0.86) return { badge:"â˜…â˜…",  label:"ä¸­" };
    return { badge:"â˜…",   label:"å¼±" };
  }

  function formatRows(rows){
    if(!rows || rows.length === 0) return "ï¼ˆãªã—ï¼‰";
    return rows.map(x => `${x.i}ä½  ${x.badge} [${x.label}]  ${x.num}`).join("\n");
  }

  function splitRanked(ranked, limit=10){
    if(!ranked || ranked.length === 0) return { main: [], ins: [], rows: [] };
    const best = ranked[0].sc;

    const rows = ranked.slice(0, limit).map((r, idx) => {
      const t = tierLabel(r.sc, best);
      return { i: idx+1, num: r.n, badge: t.badge, label: t.label, sc: r.sc };
    });

    return {
      rows,
      main: rows.filter(x => x.label === "å¼·"),
      ins : rows.filter(x => x.label !== "å¼·")
    };
  }

  function judgeDayPower(mainCount){
    if(mainCount >= 5) return "ğŸ”¥ ä»Šæ—¥ã¯å¼·ã„æ—¥ï¼ˆé›†ä¸­å‹è² ï¼‰";
    if(mainCount >= 3) return "â— æ™®é€šã®æ—¥ï¼ˆãƒãƒ©ãƒ³ã‚¹ï¼‰";
    return "â–³ åˆ†æ•£ã®æ—¥ï¼ˆç„¡ç†ã—ãªã„ï¼‰";
  }

  // =========================
  // 8) ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆäºˆæƒ³è¡¨ï¼ˆåƒç™¾åä¸€ï¼‰
  // =========================
  function renderPosCandidates(){
    const posScores = buildPositionScores();

    const ids = ["pos1000","pos100","pos10","pos1"];
    for(let pos=0; pos<4; pos++){
      const arr = posScores[pos];
      const cand = [...Array(10)].map((_,d)=>({d, sc: arr[d]}))
        .sort((A,B)=>B.sc - A.sc)
        .slice(0,4);

      const root = document.getElementById(ids[pos]);
      root.innerHTML = cand.map((x)=>{
        return `
          <div class="candRow">
            <div class="candNum">${x.d}</div>
            <div class="candScore">+${x.sc}</div>
          </div>
        `;
      }).join("");
    }
  }

  // =========================
  // 9) åˆ¤å®šãƒ˜ãƒ«ãƒ‘ãƒ¼
  // =========================
  function posMatch(a,b){
    let c=0;
    for(let i=0;i<4;i++) if(a[i]===b[i]) c++;
    return c;
  }
  function digitMatchCount(a,b){
    const ca = Array(10).fill(0);
    const cb = Array(10).fill(0);
    for(const ch of a) ca[+ch]++;
    for(const ch of b) cb[+ch]++;
    let sum=0;
    for(let i=0;i<10;i++) sum += Math.min(ca[i], cb[i]);
    return sum;
  }
  function inGroup(num, groupRows){
    return groupRows.find(r => r.num === num) || null;
  }
  function setKey(num){
    return num.split("").sort().join("");
  }

  // =========================
  // 10) ç”Ÿæˆã¾ã¨ã‚
  // =========================
  function generateAll(){
    const hist = loadHistory();
    if(hist.length < 10){
      document.getElementById("judgeOut").innerHTML =
        `<span class="warn">ä¿å­˜ãŒå°‘ãªã„</span>ï¼šå†…è‡“ãƒ‡ãƒ¼ã‚¿ãŒ ${hist.length} ä»¶ã€‚ã§ãã‚Œã°ã¾ãš 30ã€œ100 ä»¶ã‚’ä¿å­˜ã—ã¦ã‹ã‚‰ã®æ–¹ãŒç²¾åº¦ãŒä¸ŠãŒã‚‹ã‚ˆã€‚`;
    }
    renderPosCandidates();
    generateRanking();
  }

  function generateRanking(){
    const sHist = scoreDigitsFromHistory();

    const prevStr  = document.getElementById("prev").value;
    const prev2Str = document.getElementById("prev2").value;

    const s = [...sHist];
    digits(prevStr).forEach(x => s[+x] += 2);
    digits(prev2Str).forEach(x => s[+x] += 1);

    const h1raw = document.getElementById("hint1").value;
    const h2raw = document.getElementById("hint2").value;

    const h1_2 = pick2FromHint(h1raw, s, prevStr, prev2Str, h2raw);
    const h2_2 = pick2FromHint(h2raw, s, prevStr, prev2Str, h1raw);

    const axisArr = chooseAxisFromRaw(h1raw, h2raw, s);
    STATE.axis = axisArr[0] + axisArr[1];

    const pool = buildPoolWeighted(h1_2, h2_2, s);

    const historySeed = loadHistory().join(",");
    const seedStr =
      h1raw + "|" + h2raw + "|" +
      prevStr + "|" + prev2Str + "|" +
      historySeed;

    const rand = mulberry32(hash32(seedStr));

    let list = [];
    while(list.length < 100){
      let n = [axisArr[0], axisArr[1]];
      while(n.length < 4) n.push(pick(pool, rand));
      list.push(n.join(""));
    }

    const ranked = rank(uniq(list));
    const top10 = ranked.slice(0, 10);
    const sp = splitRanked(top10, 10);

    document.getElementById("dayPower").textContent = judgeDayPower(sp.main.length);
    document.getElementById("straightMain").textContent = formatRows(sp.main);
    document.getElementById("straightIns").textContent  = formatRows(sp.ins);

    const setNums = uniq(top10.map(r => setKey(r.n)));
    const setRanked = rank(setNums).slice(0,10);
    const setSplit = splitRanked(setRanked, 10);

    document.getElementById("setMain").textContent = formatRows(setSplit.main);
    document.getElementById("setIns").textContent  = formatRows(setSplit.ins);

    STATE.topStraightRows = sp.rows;
    STATE.straightMain = sp.main;
    STATE.straightIns = sp.ins;

    STATE.topSetRows = setSplit.rows;
    STATE.setMain = setSplit.main;
    STATE.setIns = setSplit.ins;

    const out = document.getElementById("judgeOut");
    out.innerHTML =
      `<span class="ok">ç”ŸæˆOK</span>ï¼ˆè»¸ <span class="mono">${STATE.axis}</span>ï¼‰  çµæœãŒå‡ºãŸã‚‰å½“é¸ç•ªå·ã‚’å…¥ã‚Œã¦ã€Œåˆ¤å®šã€ã—ã¦ã­ã€‚`;
  }

  // =========================
  // 11) çµæœåˆ¤å®šï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼‹ã‚»ãƒƒãƒˆï¼‰
  // =========================
  function judge(){
    const win = normalize4(document.getElementById("win").value);
    const out = document.getElementById("judgeOut");

    if(!win){
      out.innerHTML = `<span class="warn">å½“é¸ç•ªå·ã¯4æ¡ã§å…¥ã‚Œã¦ã­</span>`;
      return;
    }

    if(!STATE.topStraightRows || STATE.topStraightRows.length === 0){
      out.innerHTML = `<span class="warn">å…ˆã«ã€Œäºˆæƒ³ã‚’ç”Ÿæˆã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ã­</span>`;
      return;
    }

    const axis = STATE.axis;
    const axisHit = (win.includes(axis[0]) && win.includes(axis[1]));

    const sMainHit = inGroup(win, STATE.straightMain);
    const sInsHit  = inGroup(win, STATE.straightIns);
    const sAnyHit  = inGroup(win, STATE.topStraightRows);

    const winKey = setKey(win);
    const setMainHit = inGroup(winKey, STATE.setMain);
    const setInsHit  = inGroup(winKey, STATE.setIns);
    const setAnyHit  = inGroup(winKey, STATE.topSetRows);

    let bestPos = 0;
    let bestDigit = 0;
    for(const r of STATE.topStraightRows){
      bestPos = Math.max(bestPos, posMatch(win, r.num));
      bestDigit = Math.max(bestDigit, digitMatchCount(win, r.num));
    }

    let headline = "";
    let detail = [];

    if(sMainHit || setMainHit){
      headline = "ğŸ”¥ æ¿€ã‚¢ãƒ„ï¼ˆèª­ã¿ãŒå°„ç¨‹åœï¼‰";
    } else if(sInsHit || setInsHit){
      headline = "â— æƒœã—ã„ï¼ˆæµã‚Œã¯åˆã£ã¦ã‚‹ï¼‰";
    } else if(sAnyHit || setAnyHit || bestPos >= 3){
      headline = "â—‹ æµã‚ŒOKï¼ˆã‚ã¨ä¸€æ­©ï¼‰";
    } else if(bestDigit >= 2 || axisHit){
      headline = "â–³ åˆ†æ•£ã®æ—¥ï¼ˆç„¡ç†ã—ãªã„ï¼‰";
    } else {
      headline = "Ã— ã‚ºãƒ¬ï¼ˆä»Šæ—¥ã¯æµã‚Œé•ã„ï¼‰";
    }

    detail.push(`å½“é¸ï¼š<span class="mono">${win}</span>`);
    detail.push(`è»¸ï¼š<span class="mono">${axis}</span>ã€€/ã€€è»¸ä¸€è‡´ï¼š<span class="${axisHit?'ok':'warn'}">${axisHit?'â—‹':'Ã—'}</span>`);

    if(sMainHit){
      detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼š<span class="ok">æœ¬å‘½ï¼ˆå¼·ï¼‰</span>ã€€${sMainHit.i}ä½`);
    } else if(sInsHit){
      detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼š<span class="ok">ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</span>ã€€${sInsHit.i}ä½`);
    } else if(sAnyHit){
      detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼š<span class="ok">åœå†…</span>ã€€${sAnyHit.i}ä½`);
    } else {
      detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼šåœå¤–ï¼ˆè¿‘ã•ï¼šä½ç½®ä¸€è‡´max ${bestPos}/4ã€æ•°å­—ä¸€è‡´max ${bestDigit}/4ï¼‰`);
    }

    if(setMainHit){
      detail.push(`ã‚»ãƒƒãƒˆï¼š<span class="ok">æœ¬å‘½ï¼ˆå¼·ï¼‰</span>ã€€${setMainHit.i}ä½ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
    } else if(setInsHit){
      detail.push(`ã‚»ãƒƒãƒˆï¼š<span class="ok">ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</span>ã€€${setInsHit.i}ä½ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
    } else if(setAnyHit){
      detail.push(`ã‚»ãƒƒãƒˆï¼š<span class="ok">åœå†…</span>ã€€${setAnyHit.i}ä½ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
    } else {
      detail.push(`ã‚»ãƒƒãƒˆï¼šåœå¤–ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
    }

    out.innerHTML =
      `<div class="big">${headline}</div>` +
      `<div style="margin-top:8px;line-height:1.7">${detail.map(x=>`ãƒ»${x}`).join("<br>")}</div>`;
  }

  // =========================
  // èµ·å‹•
  // =========================
  updateStorageHint();
  renderPosCandidates();
</script>

</body>
</html>
