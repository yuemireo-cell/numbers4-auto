<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒŠãƒ³ãƒãƒ¼ã‚º4 å®Œæˆç‰ˆ</title>
  <style>
    body{font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;padding:16px;max-width:860px;margin:auto}
    h1{font-size:34px;margin:10px 0 18px}
    input,textarea,button,select{font-size:16px;padding:12px;width:100%;box-sizing:border-box;margin:8px 0;border-radius:14px;border:1px solid #e5e5e5}
    textarea{min-height:90px;resize:vertical}
    button{background:#111;color:#fff;border:none;border-radius:999px;padding:16px;font-weight:800}
    .box{background:#fafafa;border:1px solid #eee;border-radius:16px;padding:14px;margin-top:12px}
    .label{font-weight:800;margin-top:6px}
    pre{white-space:pre-wrap;background:#f7f7f7;border-radius:14px;padding:12px;border:1px solid #eee}
    .day{font-weight:900;margin:8px 0 10px}
    .note{color:#666;font-size:12px;margin-top:6px;line-height:1.5}
    h2{margin-top:22px}
    h3{margin:12px 0 6px}
  </style>
</head>
<body>

  <h1>ãƒŠãƒ³ãƒãƒ¼ã‚º4 å®Œæˆç‰ˆ</h1>

  <div class="box">
    <div class="label">ãƒ’ãƒ³ãƒˆ1ï¼ˆä¾‹ï¼š168 / 1ãƒ»6ãƒ»8ï¼‰</div>
    <input id="hint1" inputmode="numeric" placeholder="ãƒ’ãƒ³ãƒˆ1 ä¾‹ï¼š168" />

    <div class="label">ãƒ’ãƒ³ãƒˆ2ï¼ˆä¾‹ï¼š3920 / 3ãƒ»9ãƒ»2ãƒ»0ï¼‰</div>
    <input id="hint2" inputmode="numeric" placeholder="ãƒ’ãƒ³ãƒˆ2 ä¾‹ï¼š3920" />

    <div class="label">å‰å›ï¼ˆä»»æ„ï¼‰</div>
    <input id="prev" inputmode="numeric" placeholder="å‰å› ä¾‹ï¼š5105" maxlength="4" />

    <div class="label">å‰ã€…å›ï¼ˆä»»æ„ï¼‰</div>
    <input id="prev2" inputmode="numeric" placeholder="å‰ã€…å› ä¾‹ï¼š4588" maxlength="4" />

    <div class="label">ç›´è¿‘10å›ï¼ˆä»»æ„ãƒ»4æ¡Ã—10ã‚’è²¼ã‚‹ï¼‰</div>
    <textarea id="recent" placeholder="ä¾‹ï¼š
4141â†’2121â†’7202â†’7526â†’2300â†’7263â†’1632â†’6551â†’2827â†’2699"></textarea>

    <div class="note">
      â€»åŒã˜å…¥åŠ›ãªã‚‰ä½•å›æŠ¼ã—ã¦ã‚‚åŒã˜çµæœï¼ˆãƒ–ãƒ¬ãªã„ï¼‰<br>
      â€»18æ™‚ã‚®ãƒªã‚®ãƒªã®ãƒªãƒãƒ¼ã‚µãƒ«æ•°å­—ã¯å…¥åŠ›ã—ãªã„ï¼ˆã‚†ã†ã¡ã‚ƒã‚“æ–¹é‡ï¼‰
    </div>

    <button type="button" onclick="generate()">ç•ªå·ã‚’ç”Ÿæˆã™ã‚‹</button>
  </div>

  <h2>ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</h2>
  <div id="dayPower" class="day">â€”</div>

  <h3>æœ¬å‘½ï¼ˆå¼·ï¼‰</h3>
  <pre id="straightMain">ï¼ˆã¾ã ï¼‰</pre>

  <h3>ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</h3>
  <pre id="straightIns">ï¼ˆã¾ã ï¼‰</pre>

  <h2>ã‚»ãƒƒãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</h2>

  <h3>æœ¬å‘½ï¼ˆå¼·ï¼‰</h3>
  <pre id="setMain">ï¼ˆã¾ã ï¼‰</pre>

  <h3>ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</h3>
  <pre id="setIns">ï¼ˆã¾ã ï¼‰</pre>

<script>
/* =========================
   0) åŸºæœ¬ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
========================= */

const ura = {0:5,5:0,1:6,6:1,2:7,7:2,3:8,8:3,4:9,9:4}; // è¡¨â†”è£

function digitsOf(str){
  return (str || "").match(/\d/g)?.map(Number) || [];
}
function uniq(arr){
  return [...new Set(arr)];
}
function clampDigit(n){
  n = Number(n);
  if(Number.isNaN(n)) return 0;
  n %= 10;
  if(n < 0) n += 10;
  return n;
}

/* åŒã˜å…¥åŠ›â†’åŒã˜ä¹±æ•° */
function hash32(str){
  let h = 2166136261;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function mulberry32(seed){
  return function(){
    let t = seed += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function pick(pool, rand){
  return pool[Math.floor(rand() * pool.length)];
}

/* =========================
   1) ã‚†ã†ã¡ã‚ƒã‚“æ–¹é‡ï¼šãƒ’ãƒ³ãƒˆã¯å¿…ãš2ã¤ã ã‘
   - 3ã¤ä»¥ä¸Šå…¥ã£ã¦ãŸã‚‰ã€ææ–™ã‹ã‚‰ã€Œå¼·ã„2ã¤ã€ã‚’é¸ã‚“ã§åœ§ç¸®
========================= */

function scoreDigits(){
  const s = Array(10).fill(0);
  digitsOf(document.getElementById("recent").value).forEach(d => s[d] += 1);
  digitsOf(document.getElementById("prev").value).forEach(d => s[d] += 3);
  digitsOf(document.getElementById("prev2").value).forEach(d => s[d] += 2);
  return s;
}

function pick2FromHint(str, s, prevStr, prev2Str){
  const raw = uniq(digitsOf(str));
  // 0 or 1 ã®ã¨ãã¯ä¿é™ºã§åŸ‹ã‚ã‚‹ï¼ˆâ€»å¿…ãš2ã¤ï¼‰
  if(raw.length === 0) return [4,8];
  if(raw.length === 1) return [raw[0], (raw[0] + 5) % 10];

  const pull = new Set(uniq([...digitsOf(prevStr), ...digitsOf(prev2Str)]));

  const scoreOne = (d) => {
    let sc = 0;
    sc += (s?.[d] ?? 0) * 10;             // ç›´è¿‘/å‰å›/å‰ã€…å›ã®é »åº¦
    if(pull.has(d)) sc += 30;             // å¼•ã£å¼µã‚Š
    // è¶³ã™9ï¼ˆåŒãƒ’ãƒ³ãƒˆå†…ã§ï¼‰
    if(raw.some(x => x !== d && x + d === 9)) sc += 15;
    // é€£ç•ªï¼ˆåŒãƒ’ãƒ³ãƒˆå†…ã§ï¼‰
    if(raw.some(x => x !== d && Math.abs(x - d) === 1)) sc += 8;
    // è£æ•°å­—ï¼ˆå˜ä½“ã®ã‚¯ã‚»ã¨ã—ã¦å°‘ã—ï¼‰
    sc += 2;
    return sc;
  };

  // 2ã¤ã ã‘è¿”ã™ï¼ˆã“ã‚Œã§å¿…ãš2ã¤ï¼‰
  const picked = raw.sort((a,b)=>scoreOne(b)-scoreOne(a)).slice(0,2);
  return picked;
}

/* =========================
   2) è»¸æ±ºå®šï¼šå…±é€šæ•°å­—ãŒè»¸ï¼ˆæœ€å„ªå…ˆï¼‰
========================= */

function chooseAxis(h1, h2, s){
  const common = h1.filter(x => h2.includes(x));
  if(common.length >= 2) return common.slice(0,2);

  if(common.length === 1){
    const rest = uniq([...h1, ...h2].filter(x => x !== common[0]));
    const b = rest.sort((a,b)=> (s[b]??0) - (s[a]??0))[0] ?? common[0];
    return [common[0], b];
  }

  // å…±é€šãªã—ï¼šã‚¹ã‚³ã‚¢ä¸Šä½ã‹ã‚‰2ã¤
  const all = uniq([...h1, ...h2]);
  if(all.length >= 2) return all.sort((a,b)=> (s[b]??0)-(s[a]??0)).slice(0,2);

  return [4,8];
}

/* =========================
   3) ãƒ—ãƒ¼ãƒ«ç”Ÿæˆï¼ˆå€™è£œã«ä½¿ã†æ•°å­—ã®é›†åˆï¼‰
   - ãƒ’ãƒ³ãƒˆ2ã¤ + è£ + é€£ç•ªÂ±1 + ææ–™é »åº¦é‡ã¿
========================= */

function buildPool(h1, h2, s){
  let p = [...h1, ...h2];

  // è£
  for(const d of p){
    p.push(ura[d]);
  }

  // é€£ç•ªÂ±1
  for(const d of p){
    p.push(clampDigit(d - 1));
    p.push(clampDigit(d + 1));
  }

  // ã‚¹ã‚³ã‚¢é‡ã¿ï¼ˆé »åº¦ãŒé«˜ã„æ•°å­—ã‚’å°‘ã—æ¿ƒãã™ã‚‹ï¼‰
  for(let d=0; d<=9; d++){
    for(let i=0; i<(s[d]||0); i++) p.push(d);
  }

  return uniq(p).map(Number);
}

/* =========================
   4) ãƒŠãƒ³ã¡ã‚ƒã‚“æ³•å‰‡ï¼ˆè©•ä¾¡åŠ ç‚¹ï¼‰
   - è¡¨è£
   - 1ã‚ºãƒ¬(Â±2)
   - 2ã‚ºãƒ¬(Â±3)
   - ãƒ€ãƒ–ãƒ«ï¼ˆåŒæ•°å­—2å€‹ä»¥ä¸Šï¼‰
   â€»ã€Œè©•ä¾¡ã€ã ã‘ã«ä½¿ã†ï¼ˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã¯å´©ã•ãªã„ï¼‰
========================= */

function zure1(d){ return [clampDigit(d+2), clampDigit(d-2)]; } // 1ã‚ºãƒ¬
function zure2(d){ return [clampDigit(d+3), clampDigit(d-3)]; } // 2ã‚ºãƒ¬

function makeMaterialSet(h1, h2){
  const prev = digitsOf(document.getElementById("prev").value);
  const prev2 = digitsOf(document.getElementById("prev2").value);
  const recent = digitsOf(document.getElementById("recent").value);
  const base = uniq([...h1, ...h2, ...prev, ...prev2, ...recent]);
  return new Set(base);
}

function nanchanBonus(numStr, materialSet){
  const ds = numStr.split("").map(x=>Number(x));
  const inNum = new Set(ds);

  let bonus = 0;

  // A) è¡¨è£ï¼ˆææ–™ã®è£ãŒå…¥ã£ã¦ãŸã‚‰åŠ ç‚¹ï¼‰
  for(const m of materialSet){
    const u = ura[m];
    if(inNum.has(u)) bonus += 2;
  }

  // B) 1ã‚ºãƒ¬ï¼ˆÂ±2ï¼‰
  for(const m of materialSet){
    const [a,b] = zure1(m);
    if(inNum.has(a)) bonus += 2;
    if(inNum.has(b)) bonus += 2;
  }

  // C) 2ã‚ºãƒ¬ï¼ˆÂ±3ï¼‰â€¦å°‘ã—å¼±ã‚
  for(const m of materialSet){
    const [a,b] = zure2(m);
    if(inNum.has(a)) bonus += 1;
    if(inNum.has(b)) bonus += 1;
  }

  // D) ãƒ€ãƒ–ãƒ«ï¼ˆåŒæ•°å­—2å€‹ä»¥ä¸Šï¼‰
  const cnt = Array(10).fill(0);
  ds.forEach(d=>cnt[d]++);
  const maxSame = Math.max(...cnt);
  if(maxSame >= 2) bonus += 2; // ãƒ€ãƒ–ãƒ«
  if(maxSame === 3) bonus += 4; // ãƒˆãƒªãƒ—ãƒ«
  if(maxSame === 4) bonus += 6; // ã‚¯ã‚¢ãƒ‰ãƒ©

  return bonus;
}

/* =========================
   5) æ—¢å­˜è©•ä¾¡ï¼ˆè¶³ã™9 + é€£ç•ªï¼‰ + ãƒŠãƒ³ã¡ã‚ƒã‚“åŠ ç‚¹
========================= */

function baseScore(numStr){
  const a = numStr.split("").map(Number);
  let sc = 0;
  for(let i=0;i<4;i++) for(let j=i+1;j<4;j++){
    if(a[i] + a[j] === 9) sc += 3;           // è¶³ã™9
    if(Math.abs(a[i] - a[j]) === 1) sc += 2; // é€£ç•ª
  }
  return sc;
}

function rank(nums, materialSet){
  return nums.map(n=>{
    const sc = baseScore(n) + nanchanBonus(n, materialSet);
    return { n, sc };
  }).sort((A,B)=>B.sc - A.sc);
}

/* =========================
   6) å¼·/ä¸­/å¼± è¡¨ç¤º
========================= */

function tierLabel(score, best){
  if(best <= 0) return { badge:"â˜…", label:"å¼±" };
  const r = score / best;
  if(r >= 0.92) return { badge:"â˜…â˜…â˜…", label:"å¼·" };
  if(r >= 0.86) return { badge:"â˜…â˜…",  label:"ä¸­" };
  return { badge:"â˜…",   label:"å¼±" };
}

function splitRanked(ranked, limit = 10){
  if(!ranked || ranked.length === 0) return { main: [], ins: [] };

  const best = ranked[0].sc;
  const rows = ranked.slice(0, limit).map((r, i) => {
    const t = tierLabel(r.sc, best);
    return { i:i+1, num:r.n, badge:t.badge, label:t.label };
  });

  return {
    main: rows.filter(x => x.label === "å¼·"),
    ins : rows.filter(x => x.label !== "å¼·")
  };
}

function formatRows(rows){
  if(!rows || rows.length === 0) return "ï¼ˆãªã—ï¼‰";
  return rows.map(x => `${x.i}ä½  ${x.badge}ã€${x.label}ã€‘  ${x.num}`).join("\n");
}

function judgeDayPower(count){
  if(count <= 5) return "ğŸ”¥ ä»Šæ—¥ã¯å¼·ã„æ—¥ï¼ˆé›†ä¸­å‹è² ï¼‰";
  if(count <= 8) return "â— æ™®é€šã®æ—¥ï¼ˆãƒãƒ©ãƒ³ã‚¹ï¼‰";
  return "â–³ åˆ†æ•£ã®æ—¥ï¼ˆç„¡ç†ã—ãªã„ï¼‰";
}

/* =========================
   7) ç”Ÿæˆæœ¬ä½“ï¼ˆåŒã˜å…¥åŠ›â†’åŒã˜çµæœï¼‰
========================= */

function generate(){
  // â‘  ææ–™ã‚¹ã‚³ã‚¢
  const s = scoreDigits();

  // â‘¡ ãƒ’ãƒ³ãƒˆã¯å¿…ãš2ã¤ã«åœ§ç¸®
  const prevStr  = document.getElementById("prev").value;
  const prev2Str = document.getElementById("prev2").value;

  const h1 = pick2FromHint(document.getElementById("hint1").value, s, prevStr, prev2Str);
  const h2 = pick2FromHint(document.getElementById("hint2").value, s, prevStr, prev2Str);

  // â‘¢ è»¸ï¼ˆå…±é€šãŒæœ€å„ªå…ˆï¼‰
  const axis = chooseAxis(h1, h2, s);

  // â‘£ ãƒ—ãƒ¼ãƒ«
  const pool = buildPool(h1, h2, s);

  // â‘¤ ã‚·ãƒ¼ãƒ‰ï¼ˆå®‰å®šï¼‰
  const seedStr =
    document.getElementById("hint1").value + "|" +
    document.getElementById("hint2").value + "|" +
    document.getElementById("prev").value  + "|" +
    document.getElementById("prev2").value + "|" +
    document.getElementById("recent").value;

  const rand = mulberry32(hash32(seedStr));

  // â‘¥ å€™è£œ100æœ¬ï¼ˆè»¸2æ¡ + æ®‹ã‚Š2æ¡ã‚’ãƒ—ãƒ¼ãƒ«ã‹ã‚‰ï¼‰
  let list = [];
  while(list.length < 100){
    let n = [axis[0], axis[1]];
    while(n.length < 4) n.push(pick(pool, rand));
    list.push(n.join(""));
  }

  // â‘¦ ãƒ©ãƒ³ã‚¯ï¼ˆãƒŠãƒ³ã¡ã‚ƒã‚“æ³•å‰‡ï¼šè©•ä¾¡åŠ ç‚¹ï¼‰
  const materialSet = makeMaterialSet(h1, h2);
  const ranked = rank(uniq(list), materialSet);

  // â‘§ ã¾ãšä¸Šä½10ã‚’è¡¨ç¤ºç”¨ã«ä½¿ã†
  const top10 = ranked.slice(0, 10);

  // â‘¨ å¼·/ä¸­/å¼±ã§åˆ†ã‘ã¦è¡¨ç¤ºï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼‰
  const sSplit = splitRanked(top10, 10);
  document.getElementById("straightMain").textContent = formatRows(sSplit.main);
  document.getElementById("straightIns").textContent  = formatRows(sSplit.ins);

  // â‘© ã€Œä»Šæ—¥ã¯å¼·ã„æ—¥ã€ï¼šæœ¬å‘½ï¼ˆå¼·ï¼‰ã®æœ¬æ•°ã§åˆ¤å®š
  document.getElementById("dayPower").textContent =
    judgeDayPower(sSplit.main.length);

  // â‘ª ã‚»ãƒƒãƒˆï¼ˆä¸¦ã³æ›¿ãˆ1ã¤ã‚’ã‚»ãƒƒãƒˆæ‰±ã„ï¼‰
  const setNums = uniq(top10.map(r => r.n.split("").sort().join("")));
  const setRanked = rank(setNums, materialSet).slice(0, 10);
  const setSplit = splitRanked(setRanked, 10);

  document.getElementById("setMain").textContent = formatRows(setSplit.main);
  document.getElementById("setIns").textContent  = formatRows(setSplit.ins);
}
</script>

</body>
</html>
