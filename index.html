<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒŠãƒ³ãƒãƒ¼ã‚º4 å®Œæˆç‰ˆ</title>
  <style>
    body{
      font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;
      padding:16px;max-width:860px;margin:auto
    }
    h1{font-size:34px;margin:10px 0 18px}
    h2{margin:22px 0 10px}
    h3{margin:14px 0 8px}
    input,textarea,button{
      font-size:16px;padding:12px;width:100%;box-sizing:border-box;
      margin:8px 0;border-radius:14px;border:1px solid #e5e5e5
    }
    textarea{min-height:90px;resize:vertical}
    button{
      background:#111;color:#fff;border:none;border-radius:999px;
      padding:16px;font-weight:800;cursor:pointer
    }
    .box{background:#fafafa;border:1px solid #eee;border-radius:16px;padding:14px;margin-top:12px}
    .label{font-weight:800;margin-top:6px}
    .note{color:#666;font-size:12px;margin-top:8px;line-height:1.6}
    .day{font-weight:900;margin:6px 0 10px}
    pre{
      white-space:pre-wrap;background:#f7f7f7;border-radius:14px;
      padding:12px;border:1px solid #eee;margin:0
    }
    .muted{color:#777;font-size:12px}
  </style>
</head>
<body>

  <h1>ãƒŠãƒ³ãƒãƒ¼ã‚º4 å®Œæˆç‰ˆ</h1>

  <div class="box">
    <div class="label">ãƒ’ãƒ³ãƒˆ1ï¼ˆä¾‹ï¼š168 / 1ãƒ»6ãƒ»8ï¼‰</div>
    <input id="hint1" inputmode="numeric" placeholder="ãƒ’ãƒ³ãƒˆ1 ä¾‹ï¼š168">

    <div class="label">ãƒ’ãƒ³ãƒˆ2ï¼ˆä¾‹ï¼š3920 / 3ãƒ»9ãƒ»2ãƒ»0ï¼‰</div>
    <input id="hint2" inputmode="numeric" placeholder="ãƒ’ãƒ³ãƒˆ2 ä¾‹ï¼š3920">

    <div class="label">å‰å›ï¼ˆä»»æ„ï¼‰</div>
    <input id="prev" inputmode="numeric" placeholder="å‰å› ä¾‹ï¼š5105" maxlength="4">

    <div class="label">å‰ã€…å›ï¼ˆä»»æ„ï¼‰</div>
    <input id="prev2" inputmode="numeric" placeholder="å‰ã€…å› ä¾‹ï¼š4588" maxlength="4">

    <div class="label">ç›´è¿‘10å›ï¼ˆä»»æ„ãƒ»4æ¡Ã—10ã‚’è²¼ã‚‹ï¼‰</div>
    <textarea id="recent" placeholder="ä¾‹ï¼š
4141â†’2121â†’7202â†’7526â†’2300â†’7263â†’1632â†’6551â†’2827â†’2699"></textarea>

    <div class="note">
      â€»åŒã˜å…¥åŠ›ãªã‚‰ä½•å›æŠ¼ã—ã¦ã‚‚åŒã˜çµæœï¼ˆãƒ–ãƒ¬ãªã„ï¼‰<br>
      â€»18æ™‚ã‚®ãƒªã‚®ãƒªã®ãƒªãƒãƒ¼ã‚µãƒ«æ•°å­—ã¯å…¥åŠ›ã—ãªã„ï¼ˆã‚†ã†ã¡ã‚ƒã‚“æ–¹é‡ï¼‰
    </div>

    <button type="button" onclick="generate()">ç•ªå·ã‚’ç”Ÿæˆã™ã‚‹</button>
    <div id="hintPicked" class="muted"></div>
  </div>

  <h2>ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</h2>
  <div id="dayPower" class="day"></div>

  <h3>æœ¬å‘½ï¼ˆå¼·ï¼‰</h3>
  <pre id="straightMain">ï¼ˆæœªç”Ÿæˆï¼‰</pre>

  <h3>ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</h3>
  <pre id="straightIns">ï¼ˆæœªç”Ÿæˆï¼‰</pre>

  <h2>ã‚»ãƒƒãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</h2>

  <h3>æœ¬å‘½ï¼ˆå¼·ï¼‰</h3>
  <pre id="setMain">ï¼ˆæœªç”Ÿæˆï¼‰</pre>

  <h3>ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</h3>
  <pre id="setIns">ï¼ˆæœªç”Ÿæˆï¼‰</pre>

<script>
/* =========================
   åŸºæœ¬ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
========================= */
const ura = {0:5,5:0,1:6,6:1,2:7,7:2,3:8,8:3,4:9,9:4};

function digits(str){
  return (str || "").match(/\d/g) || [];
}
function uniq(arr){
  const s = new Set(), out=[];
  for(const x of arr){ if(!s.has(x)){ s.add(x); out.push(x); } }
  return out;
}

// æ–‡å­—åˆ—â†’å®‰å®šã‚·ãƒ¼ãƒ‰ï¼ˆåŒã˜å…¥åŠ›ãªã‚‰åŒã˜ä¹±æ•°åˆ—ï¼‰
function hash32(str){
  let h = 2166136261;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function mulberry32(seed){
  return function(){
    let t = seed += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function pick(pool, rand){
  return pool[Math.floor(rand() * pool.length)];
}

/* =========================
   ææ–™ã‚¹ã‚³ã‚¢ï¼ˆç›´è¿‘/å‰å›/å‰ã€…å›ï¼‰
========================= */
function scoreDigits(){
  const s = Array(10).fill(0);

  // ç›´è¿‘10å›ï¼šå‡ºç¾ã—ãŸæ¡ã‚’+1
  digits(document.getElementById("recent").value).forEach(x => s[+x] += 1);

  // å‰å›+3 / å‰ã€…å›+2ï¼ˆå¼•ã£å¼µã‚Šå¯„ã›ï¼‰
  digits(document.getElementById("prev").value).forEach(x => s[+x] += 3);
  digits(document.getElementById("prev2").value).forEach(x => s[+x] += 2);

  return s;
}

/* =========================
   ãƒ’ãƒ³ãƒˆã¯ã€Œå¿…ãš2ã¤ã ã‘ã€æŠ½å‡º
   - å…±é€šæ•°å­—ãŒã‚ã‚‹ãªã‚‰æœ€å„ªå…ˆã§å…¥ã‚Œã‚‹
========================= */
function pick2FromHint(hintStr, s, commonPreferred, prevStr, prev2Str){
  const raw = digits(hintStr).map(Number);
  const u = uniq(raw);

  // ä½•ã‚‚ãªã„æ™‚ã®ä¿é™ºï¼ˆç©ºå›é¿ï¼‰
  if(u.length === 0) return [4,8];

  // å¼•ã£å¼µã‚Šï¼ˆå‰å›/å‰ã€…å›ï¼‰ã‚»ãƒƒãƒˆ
  const pull = new Set(
    digits((prevStr || "") + (prev2Str || "")).map(Number)
  );

  const scoreOne = (d, allDigitsInHint) => {
    let sc = 0;

    // å‡ºç¾é »åº¦ï¼ˆç›´è¿‘/å‰å›/å‰ã€…å›ï¼‰
    sc += (s?.[d] ?? 0) * 10;

    // è£æ•°å­—ãŒé–¢ã‚ã‚‹æ•°å­—ã¯å°‘ã—åŠ ç‚¹ï¼ˆææ–™ã¨ã—ã¦ï¼‰
    if (ura[d] !== undefined) sc += 2;

    // å¼•ã£å¼µã‚Šï¼ˆå‰å›/å‰ã€…å›ã«å«ã¾ã‚Œã¦ãŸã‚‰å¼·ãï¼‰
    if (pull.has(d)) sc += 30;

    // è¶³ã™9 / é€£ç•ªï¼ˆãƒ’ãƒ³ãƒˆå†…ã«ç›¸æ€§ãŒã‚ã‚Œã°å°‘ã—åŠ ç‚¹ï¼‰
    if (allDigitsInHint.some(x => x !== d && x + d === 9)) sc += 15;
    if (allDigitsInHint.some(x => x !== d && Math.abs(x - d) === 1)) sc += 8;

    return sc;
  };

  // â‘  å…±é€šæ•°å­—ã‚’å„ªå…ˆçš„ã«ç¢ºä¿ï¼ˆæœ€å¤§2ã¤ï¼‰
  const preferred = (commonPreferred || []).filter(x => u.includes(x));
  const picked = [];

  for(const d of preferred){
    if(picked.length < 2 && !picked.includes(d)) picked.push(d);
  }

  // â‘¡ æ®‹ã‚Šã‚’ã‚¹ã‚³ã‚¢é †ã§åŸ‹ã‚ã‚‹
  if(picked.length < 2){
    const rest = u.filter(d => !picked.includes(d));
    rest.sort((a,b)=> scoreOne(b, u) - scoreOne(a, u));
    for(const d of rest){
      if(picked.length < 2) picked.push(d);
    }
  }

  // â‘¢ ãã‚Œã§ã‚‚è¶³ã‚Šãªã„å ´åˆï¼ˆç†è«–ä¸Šã»ã¼ãªã„ï¼‰ä¿é™ºåŸ‹ã‚
  while(picked.length < 2){
    const fallback = (picked[0] === 4 ? 8 : 4);
    picked.push(fallback);
  }

  return picked;
}

/* =========================
   è»¸ã¯ã€Œå…±é€šæ•°å­—ã€æœ€å„ªå…ˆ
========================= */
function chooseAxis(h1, h2, s){
  const common = h1.filter(x => h2.includes(x));
  if(common.length >= 2) return common.slice(0,2);
  if(common.length === 1){
    const rest = uniq([...h1, ...h2].filter(x => x !== common[0]));
    rest.sort((a,b)=> s[b] - s[a]);
    return [common[0], rest[0] ?? common[0]];
  }
  // å…±é€šã‚¼ãƒ­ãªã‚‰ã€å…¨ä½“ã‹ã‚‰ã‚¹ã‚³ã‚¢ä¸Šä½2ã¤
  const all = uniq([...h1, ...h2]);
  all.sort((a,b)=> s[b] - s[a]);
  return [all[0] ?? 4, all[1] ?? 8];
}

/* =========================
   ãƒ—ãƒ¼ãƒ«ä½œæˆï¼ˆãƒ’ãƒ³ãƒˆ2ã¤ + è£æ•°å­— + Â±1 + ã‚¹ã‚³ã‚¢é‡ã¿ï¼‰
   â€»é‡è¤‡ã¯è¨±ã—ã¦é‡ã¿ä»˜ã‘ â†’ æœ€å¾Œã« uniq ã§å€™è£œé›†åˆåŒ–
========================= */
function buildPool(h1, h2, s){
  let p = [];

  // ãƒ’ãƒ³ãƒˆ2ã¤ï¼ˆå¿…ãš2+2ï¼‰
  h1.forEach(x => p.push(String(x)));
  h2.forEach(x => p.push(String(x)));

  // è£æ•°å­—ï¼ˆå…¨æ¡ã®ãƒãƒƒãƒ—ã‹ã‚‰è¿½åŠ ï¼‰
  Object.keys(ura).forEach(k => p.push(String(ura[k])));

  // é€£ç•ªï¼ˆÂ±1ï¼‰
  const base = p.map(Number);
  base.forEach(n => {
    if(n > 0) p.push(String(n-1));
    if(n < 9) p.push(String(n+1));
  });

  // ã‚¹ã‚³ã‚¢é‡ã¿ï¼ˆå‡ºã‚„ã™ã„æ¡ã‚’å€™è£œã«å¢—ã‚„ã™ï¼‰
  for(let digit=0; digit<=9; digit++){
    for(let i=0; i<(s[digit] || 0); i++){
      p.push(String(digit));
    }
  }

  return uniq(p);
}

/* =========================
   ãƒ©ãƒ³ã‚­ãƒ³ã‚°è©•ä¾¡ï¼ˆè¶³ã™9 + é€£ç•ªï¼‰
========================= */
function rank(nums){
  return nums.map(n=>{
    let sc=0;
    const a = n.split("").map(Number);
    for(let i=0;i<4;i++) for(let j=i+1;j<4;j++){
      if(a[i]+a[j]===9) sc += 3;            // è¶³ã™9
      if(Math.abs(a[i]-a[j])===1) sc += 2; // é€£ç•ª
    }
    return { n, sc };
  }).sort((A,B)=>B.sc - A.sc);
}

// å¼·ã•ãƒ©ãƒ™ãƒ«ï¼ˆbestæ¯”ï¼‰
function tierLabel(score, best){
  if(best <= 0) return { badge:"â˜…", label:"å¼±" };
  const r = score / best;
  if(r >= 0.92) return { badge:"â˜…â˜…â˜…", label:"å¼·" };
  if(r >= 0.86) return { badge:"â˜…â˜…",  label:"ä¸­" };
  return { badge:"â˜…",   label:"å¼±" };
}

// æœ¬å‘½/ä¿é™ºã«åˆ†ã‘ã‚‹ï¼ˆå¼·ï¼æœ¬å‘½ã€ãã®ä»–ï¼ä¿é™ºï¼‰
function splitRanked(ranked, limit = 10){
  if(!ranked || ranked.length === 0) return { main: [], ins: [] };

  const best = ranked[0].sc;
  const rows = ranked.slice(0, limit).map((r, i) => {
    const t = tierLabel(r.sc, best);
    return { i:i+1, num:r.n, badge:t.badge, label:t.label };
  });

  return {
    main: rows.filter(x => x.label === "å¼·"),
    ins : rows.filter(x => x.label !== "å¼·")
  };
}

function formatRows(rows){
  if(!rows || rows.length === 0) return "ï¼ˆãªã—ï¼‰";
  return rows.map(x => `${x.i}ä½  ${x.badge}ã€${x.label}ã€‘  ${x.num}`).join("\n");
}

// ã€Œä»Šæ—¥ã¯å¼·ã„æ—¥ã€åˆ¤å®šï¼ˆå¼·ã®æœ¬æ•°ã§åˆ¤å®šï¼‰
function judgeDayPower(strongCount){
  if(strongCount <= 3) return "ğŸ”¥ ä»Šæ—¥ã¯å¼·ã„æ—¥ï¼ˆé›†ä¸­å‹è² ï¼‰";
  if(strongCount <= 5) return "â— æ™®é€šã®æ—¥ï¼ˆãƒãƒ©ãƒ³ã‚¹ï¼‰";
  return "â–³ åˆ†æ•£ã®æ—¥ï¼ˆç„¡ç†ã—ãªã„ï¼‰";
}

/* =========================
   ç”Ÿæˆæœ¬ä½“ï¼ˆåŒã˜å…¥åŠ›â†’åŒã˜çµæœï¼‰
========================= */
function generate(){
  const s = scoreDigits();

  const hint1Str = document.getElementById("hint1").value;
  const hint2Str = document.getElementById("hint2").value;
  const prevStr  = document.getElementById("prev").value;
  const prev2Str = document.getElementById("prev2").value;

  // å…±é€šå€™è£œï¼ˆå…ƒãƒ’ãƒ³ãƒˆæ–‡å­—åˆ—ã‹ã‚‰ï¼‰
  const raw1 = uniq(digits(hint1Str).map(Number));
  const raw2 = uniq(digits(hint2Str).map(Number));
  const commonRaw = raw1.filter(x => raw2.includes(x));

  // ãƒ’ãƒ³ãƒˆã¯å¿…ãš2ã¤ã ã‘ã«æ•´å½¢ï¼ˆå…±é€šãŒã‚ã‚Œã°æœ€å„ªå…ˆï¼‰
  const hint1 = pick2FromHint(hint1Str, s, commonRaw, prevStr, prev2Str);
  const hint2 = pick2FromHint(hint2Str, s, commonRaw, prevStr, prev2Str);

  // è¡¨ç¤ºï¼ˆä»Šã©ã®2ã¤ã‚’æ¡ç”¨ã—ãŸã‹ï¼‰
  document.getElementById("hintPicked").textContent =
    `æ¡ç”¨ãƒ’ãƒ³ãƒˆï¼šãƒ’ãƒ³ãƒˆ1â†’[${hint1.join(",")}] / ãƒ’ãƒ³ãƒˆ2â†’[${hint2.join(",")}]ï¼ˆå„2ã¤å›ºå®šï¼‰`;

  // è»¸ã¯å…±é€šæœ€å„ªå…ˆ
  const axis = chooseAxis(hint1, hint2, s);

  // å€™è£œãƒ—ãƒ¼ãƒ«
  const pool = buildPool(hint1, hint2, s);

  // å…¥åŠ›å…¨éƒ¨ã‹ã‚‰ã‚·ãƒ¼ãƒ‰ä½œã£ã¦å›ºå®šä¹±æ•°
  const seedStr =
    hint1Str + "|" + hint2Str + "|" +
    prevStr  + "|" + prev2Str + "|" +
    document.getElementById("recent").value;

  const rand = mulberry32(hash32(seedStr));

  // å€™è£œç”Ÿæˆï¼ˆ100æœ¬ï¼‰â€»åŒã˜å…¥åŠ›ãªã‚‰åŒã˜100æœ¬
  let list = [];
  while(list.length < 100){
    let n = [String(axis[0]), String(axis[1])];
    while(n.length < 4){
      n.push(pick(pool, rand));
    }
    list.push(n.join(""));
  }

  // ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–â†’ãƒ©ãƒ³ã‚¯
  const ranked = rank(uniq(list));

  // ä¸Šä½10ï¼ˆè¦‹ã‚„ã™ã•å„ªå…ˆï¼‰
  const straightTop = ranked.slice(0, 10);

  // æœ¬å‘½/ä¿é™º
  const straightSplit = splitRanked(straightTop, 10);

  // æ—¥ã®å¼·ã•
  document.getElementById("dayPower").textContent =
    judgeDayPower(straightSplit.main.length);

  // è¡¨ç¤ºï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼‰
  document.getElementById("straightMain").textContent = formatRows(straightSplit.main);
  document.getElementById("straightIns").textContent  = formatRows(straightSplit.ins);

  // ã‚»ãƒƒãƒˆï¼ˆåŒã˜4æ¡ã®ä¸¦ã³æ›¿ãˆï¼ã‚½ãƒ¼ãƒˆã—ã¦åŒä¸€è¦–ï¼‰
  const setNums = uniq(straightTop.map(r => r.n.split("").sort().join("")));
  const setRanked = rank(setNums).slice(0, 10);
  const setSplit = splitRanked(setRanked, 10);

  document.getElementById("setMain").textContent = formatRows(setSplit.main);
  document.getElementById("setIns").textContent  = formatRows(setSplit.ins);
}
</script>

</body>
</html>
