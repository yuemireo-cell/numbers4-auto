<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒŠãƒ³ãƒãƒ¼ã‚º4 å®Œæˆç‰ˆ</title>
  <style>
    body{font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;padding:16px;max-width:860px;margin:auto}
    h1{font-size:34px;margin:10px 0 18px}
    input,textarea,button{font-size:16px;padding:12px;width:100%;box-sizing:border-box;margin:8px 0;border-radius:14px;border:1px solid #e5e5e5}
    textarea{min-height:90px;resize:vertical}
    button{background:#111;color:#fff;border:none;border-radius:999px;padding:16px;font-weight:900}
    .box{background:#fafafa;border:1px solid #eee;border-radius:16px;padding:14px;margin-top:12px}
    .label{font-weight:900;margin-top:6px}
    pre{white-space:pre-wrap;background:#f7f7f7;border-radius:14px;padding:12px;border:1px solid #eee}
    .day{font-weight:900;margin:8px 0 0}
    .note{color:#666;font-size:12px;margin-top:6px;line-height:1.6}
    h2{margin-top:22px}
    h3{margin:12px 0 6px}
    .resultBox{background:#fff;border:1px solid #eee;border-radius:16px;padding:14px;margin-top:12px}
    .big{font-size:18px;font-weight:900}
    .ok{color:#0a7;font-weight:900}
    .warn{color:#b00020;font-weight:900}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1 1 240px}
    .ghost{display:none !important;}
    .miniBtn{padding:12px;font-weight:900}
  </style>
</head>
<body>

  <h1>ãƒŠãƒ³ãƒãƒ¼ã‚º4 å®Œæˆç‰ˆ</h1>

  <div class="box">
    <div class="label">ãƒ’ãƒ³ãƒˆ1ï¼ˆä¾‹ï¼š168 / 1ãƒ»6ãƒ»8ï¼‰</div>
    <input id="hint1" inputmode="numeric" placeholder="ãƒ’ãƒ³ãƒˆ1 ä¾‹ï¼š168">

    <div class="label">ãƒ’ãƒ³ãƒˆ2ï¼ˆä¾‹ï¼š3920 / 3ãƒ»9ãƒ»2ãƒ»0ï¼‰</div>
    <input id="hint2" inputmode="numeric" placeholder="ãƒ’ãƒ³ãƒˆ2 ä¾‹ï¼š3920">

    <div class="row">
      <div>
        <div class="label">å‰å›ï¼ˆä»»æ„ï¼‰</div>
        <input id="prev" inputmode="numeric" placeholder="å‰å› ä¾‹ï¼š5105" maxlength="4">
      </div>
      <div>
        <div class="label">å‰ã€…å›ï¼ˆä»»æ„ï¼‰</div>
        <input id="prev2" inputmode="numeric" placeholder="å‰ã€…å› ä¾‹ï¼š4588" maxlength="4">
      </div>
    </div>

    <!-- ç›´è¿‘10å›å…¥åŠ›æ¬„ã¯ã€Œå»ƒæ­¢ã€ï¼šUIã«ã¯å‡ºã•ãªã„ï¼ˆå†…è”µï¼‰ -->
    <!-- ãŸã ã—éå»ã‚³ãƒ¼ãƒ‰äº’æ›ã®ãŸã‚ã€å†…éƒ¨ã«ã¯æ®‹ã—ã€localStorageã®å±¥æ­´ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã—ã¦ä½¿ã† -->
    <textarea id="recent" class="ghost"></textarea>

    <div class="note">
      â€»ç›´è¿‘ãƒ‡ãƒ¼ã‚¿ã¯<strong>å†…è”µä¿å­˜ï¼ˆæœ€å¤§100å›ï¼‰</strong>ã‚’è§£æã«ä½¿ã†ï¼ˆæ‰‹å…¥åŠ›ãªã—ï¼‰<br>
      â€»åŒã˜å…¥åŠ›ãªã‚‰ä½•å›æŠ¼ã—ã¦ã‚‚åŒã˜çµæœï¼ˆãƒ–ãƒ¬ãªã„ï¼‰<br>
      â€»18æ™‚ã‚®ãƒªã‚®ãƒªã®ãƒªãƒãƒ¼ã‚µãƒ«æ•°å­—ã¯å…¥åŠ›ã—ãªã„ï¼ˆã‚†ã†ã¡ã‚ƒã‚“æ–¹é‡ï¼‰
    </div>

    <button type="button" onclick="generate()">ç•ªå·ã‚’ç”Ÿæˆã™ã‚‹</button>
  </div>

  <div class="resultBox">
    <div class="label">å½“é¸ç•ªå·ï¼ˆçµæœãŒå‡ºãŸã‚‰ã“ã“ã«4æ¡ï¼‰</div>
    <input id="win" inputmode="numeric" placeholder="ä¾‹ï¼š7263" maxlength="4">

    <div class="row">
      <button class="miniBtn" type="button" onclick="judge()">çµæœã‚’åˆ¤å®šã™ã‚‹</button>
      <button class="miniBtn" type="button" onclick="saveWin()">å½“é¸ç•ªå·ã‚’ä¿å­˜ã™ã‚‹ï¼ˆæœ€å¤§100ï¼‰</button>
    </div>

    <div id="judgeOut" class="mono" style="margin-top:10px;"></div>

    <div class="note">
      â€»åˆ¤å®šã¯ã€Œã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼‹ã‚»ãƒƒãƒˆã€ä¸¡æ–¹ã‚’è¦‹ã‚‹ï¼ˆã‚†ã†ã¡ã‚ƒã‚“æŒ‡å®šï¼‰<br>
      â€»ä¿å­˜ã—ãŸå±¥æ­´ã¯ç«¯æœ«å†…ã«ä¿æŒï¼ˆlocalStorageï¼‰ã€‚åŒã˜ç«¯æœ«ãƒ»åŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ã§æ®‹ã‚‹
    </div>
  </div>

  <h2>ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</h2>
  <div id="dayPower" class="day"></div>

  <h3>æœ¬å‘½ï¼ˆå¼·ï¼‰</h3>
  <pre id="straightMain">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>

  <h3>ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</h3>
  <pre id="straightIns">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>

  <h2>ã‚»ãƒƒãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</h2>

  <h3>æœ¬å‘½ï¼ˆå¼·ï¼‰</h3>
  <pre id="setMain">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>

  <h3>ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</h3>
  <pre id="setIns">ï¼ˆã“ã“ã«å‡ºã¾ã™ï¼‰</pre>

<script>
  // =========================================================
  // 0) å†…è”µä¿å­˜ï¼ˆæœ€å¤§100å›ï¼‰â€” ã‚†ã†ã¡ã‚ƒã‚“ä»•æ§˜
  // =========================================================
  const STORAGE_KEY = "n4_history_v2"; // v2: ä»Šå›ã®å†…è”µå±¥æ­´
  const HISTORY_MAX = 100;

  // ===== è£æ•°å­—ï¼ˆã‚†ã†ã¡ã‚ƒã‚“å®šç¾©ï¼‰=====
  const ura = {0:5,5:0,1:6,6:1,2:7,7:2,3:8,8:3,4:9,9:4};

  // ===== çŠ¶æ…‹ä¿æŒï¼ˆç”Ÿæˆçµæœã‚’åˆ¤å®šã«ä½¿ã†ï¼‰=====
  const STATE = {
    axis: "48",
    topStraightRows: [], // [{i,num,badge,label,sc}]
    topSetRows: [],      // åŒä¸Šï¼ˆnumã¯ã‚»ãƒƒãƒˆã‚­ãƒ¼ï¼‰
    straightMain: [],
    straightIns: [],
    setMain: [],
    setIns: [],
    lastAnalysis: null,  // å±¥æ­´è§£æã‚­ãƒ£ãƒƒã‚·ãƒ¥
  };

  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  function digits(str){ return (str || "").match(/\d/g) || []; }
  function uniq(arr){
    const s = new Set(), out=[];
    for(const x of arr){ if(!s.has(x)){ s.add(x); out.push(x); } }
    return out;
  }
  function normalize4(str){
    const d = digits(str).slice(0,4);
    if(d.length !== 4) return null;
    return d.join("");
  }
  function setKey(num){
    return num.split("").sort().join("");
  }

  // åŒã˜å…¥åŠ›ãªã‚‰åŒã˜ä¹±æ•°åˆ—ï¼ˆå›ºå®šï¼‰
  function hash32(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }
  function mulberry32(seed){
    return function(){
      let t = seed += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }
  function pick(pool, rand){
    return pool[Math.floor(rand() * pool.length)];
  }

  // =========================================================
  // 1) å±¥æ­´ã®èª­ã¿æ›¸ãï¼ˆå†…è”µï¼‰
  // =========================================================
  function getHistory(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      if(!Array.isArray(arr)) return [];
      // "4æ¡"ã ã‘ã«æ­£è¦åŒ–
      return arr.map(x => normalize4(String(x))).filter(Boolean);
    }catch(e){
      return [];
    }
  }

  function setHistory(arr){
    const clean = (arr || []).map(x => normalize4(String(x))).filter(Boolean);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(clean.slice(0, HISTORY_MAX)));
  }

  function addToHistory(num4){
    let h = getHistory();
    h.unshift(num4);
    if(h.length > HISTORY_MAX) h = h.slice(0, HISTORY_MAX);
    setHistory(h);
    return h;
  }

  // äº’æ›ã®ãŸã‚ recent ãƒ†ã‚­ã‚¹ãƒˆã‚’å†…éƒ¨ç”Ÿæˆï¼ˆUIã«ã¯å‡ºã•ãªã„ï¼‰
  function syncHiddenRecentFromHistory(){
    const h = getHistory();
    // ç›´è¿‘10å›ã¶ã‚“ã‚’ "â†’" ã§ç¹‹ã„ã§ã€digits() ãŒæ‹¾ãˆã‚‹å½¢ã«
    const last10 = h.slice(0, 10);
    document.getElementById("recent").value = last10.join("â†’");
    return h;
  }

  // ä¿å­˜ãƒœã‚¿ãƒ³ï¼ˆå½“é¸ç•ªå·ï¼‰
  function saveWin(){
    const win = normalize4(document.getElementById("win").value);
    const out = document.getElementById("judgeOut");

    if(!win){
      out.innerHTML = `<span class="warn">å½“é¸ç•ªå·ã¯4æ¡ã§å…¥ã‚Œã¦ã­</span>`;
      return;
    }

    const h = addToHistory(win);
    syncHiddenRecentFromHistory();

    out.innerHTML =
      `<div class="big"><span class="ok">ä¿å­˜OK</span></div>` +
      `<div style="margin-top:8px;line-height:1.7">` +
      `ãƒ»ä¿å­˜ï¼š<span class="mono">${win}</span><br>` +
      `ãƒ»å±¥æ­´ä»¶æ•°ï¼š<span class="mono">${h.length}</span>ï¼ˆæœ€å¤§ ${HISTORY_MAX}ï¼‰<br>` +
      `ãƒ»ç›´è¿‘10ã¯å†…è”µã‹ã‚‰è‡ªå‹•åæ˜ ` +
      `</div>`;
  }

  // åˆæœŸåŒæœŸï¼ˆãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸæ™‚ç‚¹ã§ç›´è¿‘10ãŒå†…è”µã‹ã‚‰å…¥ã‚‹ï¼‰
  syncHiddenRecentFromHistory();

  // =========================================================
  // 2) 100å›ãƒ‡ãƒ¼ã‚¿ã‚’è©•ä¾¡ã«æ··ãœã‚‹è¨­è¨ˆï¼ˆå®Ÿè£…ï¼‰
  //    - å‡ºç¾é »åº¦ï¼ˆç›´è¿‘ã»ã©é‡ãï¼‰
  //    - ä½ç½®ã‚¯ã‚»ï¼ˆåƒ/ç™¾/å/ä¸€ï¼‰
  //    - ç›¸æ€§ï¼ˆåŒã˜å›ã«å‡ºã‚„ã™ã„ãƒšã‚¢ï¼‰
  // =========================================================
  function analyzeHistory(history){
    const h = (history || []).map(String).filter(x => x.length === 4);

    // ä½ç½®ã‚¯ã‚»: posCount[pos][digit]
    const posCount = Array.from({length:4}, ()=>Array(10).fill(0));

    // å‡ºç¾: freq[digit]
    const freq = Array(10).fill(0);

    // ç›¸æ€§ãƒšã‚¢: pairCount[a][b] (a<b)
    const pairCount = Array.from({length:10}, ()=>Array(10).fill(0));

    // ç›´è¿‘é‡ã¿: iãŒå°ã•ã„ã»ã©é‡ã„
    // è¨­è¨ˆï¼š0-9å›:2.0 / 10-29å›:1.0 / 30-99å›:0.5
    const wByIndex = (i)=>{
      if(i < 10) return 2.0;
      if(i < 30) return 1.0;
      return 0.5;
    };

    for(let i=0;i<h.length;i++){
      const num = h[i];
      const w = wByIndex(i);
      const a = num.split("").map(ch=>+ch);

      // freq & pos
      for(let p=0;p<4;p++){
        freq[a[p]] += w;
        posCount[p][a[p]] += w;
      }

      // pairï¼ˆåŒã˜å›ã«å‡ºãŸæ•°å­—åŒå£«ï¼‰
      // é‡è¤‡ã‚‚è€ƒæ…®ã™ã‚‹ãŒã€ç›¸æ€§ã¯ã€Œå­˜åœ¨ã€å¯„ã‚Šã§uniqåŒ–
      const u = uniq(a.map(String)).map(Number);
      for(let x=0;x<u.length;x++){
        for(let y=x+1;y<u.length;y++){
          const d1 = Math.min(u[x], u[y]);
          const d2 = Math.max(u[x], u[y]);
          pairCount[d1][d2] += w;
        }
      }
    }

    // æ­£è¦åŒ–ç”¨ã®æœ€å¤§å€¤
    const maxFreq = Math.max(...freq, 1);
    const maxPos = posCount.map(row => Math.max(...row, 1));
    let maxPair = 1;
    for(let i=0;i<10;i++) for(let j=i+1;j<10;j++) maxPair = Math.max(maxPair, pairCount[i][j], 1);

    return { freq, maxFreq, posCount, maxPos, pairCount, maxPair };
  }

  function getHistoryAnalysis(){
    const h = syncHiddenRecentFromHistory();
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆåŒä¸€å±¥æ­´ãªã‚‰å†è¨ˆç®—ã—ãªã„ï¼šè»½é‡åŒ–ï¼‰
    const key = h.join(",");
    if(STATE.lastAnalysis && STATE.lastAnalysis._key === key) return STATE.lastAnalysis;
    const a = analyzeHistory(h);
    a._key = key;
    STATE.lastAnalysis = a;
    return a;
  }

  // =========================================================
  // 3) ææ–™ã‚¹ã‚³ã‚¢ï¼ˆå†…è”µå±¥æ­´ + å‰å›/å‰ã€…å›ï¼‰
  // =========================================================
  function scoreDigits(){
    // å†…è”µå±¥æ­´ã‹ã‚‰é›†è¨ˆ
    const analysis = getHistoryAnalysis();
    const s = Array(10).fill(0);

    // åŸºæœ¬ï¼šfreqã‚’ãã®ã¾ã¾ï¼ˆæ­£è¦åŒ–ã—ã¦å¼·ã™ããªã„ã‚ˆã†ã«ï¼‰
    for(let d=0; d<=9; d++){
      const norm = analysis.freq[d] / analysis.maxFreq; // 0..1
      s[d] += norm * 10; // 0..10ï¼ˆåŸºç¤ï¼‰
    }

    // å‰å›+3 / å‰ã€…å›+2ï¼ˆã‚†ã†ã¡ã‚ƒã‚“ã€Œå¼•ã£å¼µã‚Šã€ï¼‰
    digits(document.getElementById("prev").value).forEach(x => s[+x] += 3);
    digits(document.getElementById("prev2").value).forEach(x => s[+x] += 2);

    return s;
  }

  // =========================================================
  // 4) ãƒ’ãƒ³ãƒˆã®ã€Œå¿…ãš2ã¤ã ã‘ã€é¸æŠœï¼ˆå…±é€šæœ€å„ªå…ˆï¼‰
  // =========================================================
  function pick2FromHint(meStr, s, prevStr, prev2Str, otherStr){
    const me = uniq(digits(meStr)).map(Number);
    const other = new Set(uniq(digits(otherStr)).map(Number));

    // å¼•ã£å¼µã‚Šé›†åˆ
    const pull = new Set( digits((prevStr||"") + (prev2Str||"")).map(Number) );

    const score = (d) => {
      let sc = 0;
      sc += (s?.[d] ?? 0) * 10;                 // æ¿ƒã•ï¼ˆå†…è”µå±¥æ­´ + å‰å›/å‰ã€…å›ï¼‰
      if (pull.has(d)) sc += 30;                // å¼•ã£å¼µã‚Šå¼·ã‚
      sc += 2;                                  // åŸºç¤ç‚¹
      if (me.some(x => x !== d && x + d === 9)) sc += 15; // è¶³ã™9
      if (me.some(x => x !== d && Math.abs(x - d) === 1)) sc += 8; // é€£ç•ª
      return sc;
    };

    // å…±é€šæœ€å„ªå…ˆ
    const commons = me.filter(x => other.has(x));
    if (commons.length >= 2){
      return commons.sort((a,b)=>score(b)-score(a)).slice(0,2).map(String);
    }
    if (commons.length === 1){
      const rest = me.filter(x => x !== commons[0]).sort((a,b)=>score(b)-score(a));
      const second = (rest[0] ?? commons[0]);
      return [String(commons[0]), String(second)];
    }

    // å…±é€šãªã—ï¼šä¸Šä½2ã¤ï¼ˆå¿…ãš2ã¤ï¼‰
    if (me.length >= 2){
      return me.sort((a,b)=>score(b)-score(a)).slice(0,2).map(String);
    }
    if (me.length === 1){
      const candidates = [...Array(10)].map((_,i)=>i).filter(x=>x!==me[0]);
      candidates.sort((a,b)=>score(b)-score(a));
      return [String(me[0]), String(candidates[0] ?? me[0])];
    }
    return ["4","8"];
  }

  // è»¸2æ¡ï¼šé–“å¼•ãå‰ã®å…±é€šã‚’æœ€å„ªå…ˆ
  function chooseAxisFromRaw(h1raw, h2raw, s){
    const a = uniq(digits(h1raw)).map(Number);
    const b = uniq(digits(h2raw)).map(Number);
    const setB = new Set(b);
    const score = (d) => (s?.[d] ?? 0);

    const commons = a.filter(x => setB.has(x));
    if (commons.length >= 2){
      commons.sort((x,y)=>score(y)-score(x));
      return [String(commons[0]), String(commons[1])];
    }
    if (commons.length === 1){
      const all = uniq([...a, ...b].filter(x => x !== commons[0]));
      all.sort((x,y)=>score(y)-score(x));
      const second = all[0] ?? commons[0];
      return [String(commons[0]), String(second)];
    }

    const all = uniq([...a, ...b]);
    all.sort((x,y)=>score(y)-score(x));
    if (all.length >= 2) return [String(all[0]), String(all[1])];
    return ["4","8"];
  }

  // =========================================================
  // 5) ãƒ—ãƒ¼ãƒ«ï¼ˆé‡ã¿ä»˜ãï¼‰â€” ãƒ’ãƒ³ãƒˆ2å€‹ + è£ + é€£ç•ª + å±¥æ­´æ¿ƒã•
  // =========================================================
  function buildPoolWeighted(h1_2, h2_2, s){
    let p = [];
    p.push(...h1_2, ...h2_2);

    // è£æ•°å­—ï¼ˆãƒ’ãƒ³ãƒˆç”±æ¥ï¼‰
    for(const x of [...h1_2, ...h2_2]){
      const n = +x;
      if (ura[n] !== undefined) p.push(String(ura[n]));
    }

    // é€£ç•ªï¼ˆÂ±1ï¼‰
    for(const x of [...h1_2, ...h2_2]){
      const n = +x;
      if(n > 0) p.push(String(n-1));
      if(n < 9) p.push(String(n+1));
    }

    // ã‚¹ã‚³ã‚¢é‡ã¿ï¼ˆå†…è”µå±¥æ­´ã®æ¿ƒã•ãŒå¼·ã„æ•°å­—ã»ã©å‡ºã‚„ã™ãï¼‰
    for(let d=0; d<=9; d++){
      const w = Math.max(0, Math.round((s[d] ?? 0))); // æ•´æ•°åŒ–
      for(let i=0;i<w;i++) p.push(String(d));
    }

    // æœ€ä½é™ã®å…¨æ•°å­—ï¼ˆä¿é™ºï¼‰
    p.push("0","1","2","3","4","5","6","7","8","9");
    return p;
  }

  // =========================================================
  // 6) ãƒŠãƒ³ã¡ã‚ƒã‚“æ³•å‰‡ï¼ˆå¼·åŒ–åŠ ç‚¹ï¼‰â€” æ•°å€¤åŒ–æ¡ˆã‚’å®Ÿè£…
  //    â€»ã€Œè©•ä¾¡åŠ ç‚¹ã¨ã—ã¦å…¥ã‚Œã‚‹ã€ã€Œæœ¬å‘½ã«ã‚‚å¯ã€â†’ rank()ã«åˆæµ
  // =========================================================
  function nanchanBonus(num){
    // ---- æ•°å€¤åŒ–æ¡ˆï¼ˆã“ã‚ŒãŒâ€œè¨­è¨ˆå›³â€ã®ã‚³ã‚¢ï¼‰----
    // A) è¡¨è£ã‚»ãƒƒãƒˆï¼ˆ0-5,1-6,2-7,3-8,4-9ï¼‰ãŒåŒå±… â†’ +4
    // B) ãƒ€ãƒ–ãƒ«ï¼ˆ00,11,...ï¼‰ãŒå«ã¾ã‚Œã‚‹ â†’ +3
    // C) 1ã‚ºãƒ¬ï¼ˆå·®2ã®ãƒšã‚¢ï¼š0-2,1-3,...,8-0,9-1ï¼‰â†’ +2
    // D) 2ã‚ºãƒ¬ï¼ˆå·®3ã®ãƒšã‚¢ï¼š0-3,1-4,...,7-0,8-1,9-2ï¼‰â†’ +2
    // E) è£æ•°å­—ã®â€œé€£å‹•â€ãŒ2çµ„ä»¥ä¸Š â†’ è¿½åŠ  +2
    const a = num.split("").map(ch=>+ch);

    // pair helper
    const hasPair = (d1,d2)=>{
      const s = new Set(a);
      return s.has(d1) && s.has(d2);
    };

    let bonus = 0;

    // A) è¡¨è£åŒå±…
    let uraPairs = 0;
    for(let d=0; d<=4; d++){
      const u = ura[d];
      if(hasPair(d,u)) uraPairs++;
    }
    if(uraPairs >= 1) bonus += 4;
    if(uraPairs >= 2) bonus += 2; // E)

    // B) ãƒ€ãƒ–ãƒ«ï¼ˆé€£ç¶šåŒæ•°å­—ï¼‰
    if(/00|11|22|33|44|55|66|77|88|99/.test(num)) bonus += 3;

    // C) 1ã‚ºãƒ¬ï¼ˆå·®2, mod10ï¼‰
    const setA = new Set(a);
    const diff2Pairs = [[0,2],[1,3],[2,4],[3,5],[4,6],[5,7],[6,8],[7,9],[8,0],[9,1]];
    if(diff2Pairs.some(([x,y])=> setA.has(x) && setA.has(y))) bonus += 2;

    // D) 2ã‚ºãƒ¬ï¼ˆå·®3, mod10ï¼‰
    const diff3Pairs = [[0,3],[1,4],[2,5],[3,6],[4,7],[5,8],[6,9],[7,0],[8,1],[9,2]];
    if(diff3Pairs.some(([x,y])=> setA.has(x) && setA.has(y))) bonus += 2;

    return bonus;
  }

  // =========================================================
  // 7) ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆã‚†ã†ã¡ã‚ƒã‚“ç†è«– + å†…è”µ100å›è£œæ­£ + ãƒŠãƒ³ã¡ã‚ƒã‚“åŠ ç‚¹ï¼‰
  // =========================================================
  function rank(nums){
    const analysis = getHistoryAnalysis();

    const posScore = (num)=>{
      // ä½ç½®ã‚¯ã‚»ï¼šãã®ä½ç½®ã§å‡ºã‚„ã™ã„æ•°å­—ã»ã©åŠ ç‚¹ï¼ˆ0..1â†’æœ€å¤§+2ï¼‰
      let sc = 0;
      const a = num.split("").map(ch=>+ch);
      for(let p=0;p<4;p++){
        const norm = (analysis.posCount[p][a[p]] / (analysis.maxPos[p] || 1));
        sc += norm * 2; // posåˆè¨ˆã§æœ€å¤§+8ç¨‹åº¦
      }
      return sc;
    };

    const pairScore = (num)=>{
      // ç›¸æ€§ï¼šåŒã˜å›ã«ä¸€ç·’ã«å‡ºã‚„ã™ã„ãƒšã‚¢ã‚’åŠ ç‚¹ï¼ˆ0..1â†’æœ€å¤§+3ï¼‰
      const a = uniq(num.split("")).map(Number);
      let sum = 0;
      let pairs = 0;
      for(let i=0;i<a.length;i++){
        for(let j=i+1;j<a.length;j++){
          const d1 = Math.min(a[i], a[j]);
          const d2 = Math.max(a[i], a[j]);
          const v = analysis.pairCount[d1][d2] / (analysis.maxPair || 1);
          sum += v;
          pairs++;
        }
      }
      if(pairs === 0) return 0;
      return (sum / pairs) * 3; // å¹³å‡ç›¸æ€§ * 3
    };

    return nums.map(n=>{
      let sc = 0;
      const a = n.split("").map(Number);

      // ã‚†ã†ã¡ã‚ƒã‚“ï¼šè¶³ã™9 / é€£ç•ª
      for(let i=0;i<4;i++) for(let j=i+1;j<4;j++){
        if(a[i]+a[j]===9) sc += 3;            // è¶³ã™9
        if(Math.abs(a[i]-a[j])===1) sc += 2; // é€£ç•ª
      }

      // å†…è”µ100å›ï¼šä½ç½®ã‚¯ã‚» + ç›¸æ€§
      sc += posScore(n);
      sc += pairScore(n);

      // ãƒŠãƒ³ã¡ã‚ƒã‚“æ³•å‰‡ï¼šå¼·åŒ–åŠ ç‚¹
      sc += nanchanBonus(n);

      return { n, sc };
    }).sort((A,B)=>B.sc - A.sc);
  }

  // å¼·ã•ãƒ©ãƒ™ãƒ«ï¼ˆbestæ¯”ï¼‰
  function tierLabel(score, best){
    if(best <= 0) return { badge:"â˜…", label:"å¼±" };
    const r = score / best;
    if(r >= 0.92) return { badge:"â˜…â˜…â˜…", label:"å¼·" };
    if(r >= 0.86) return { badge:"â˜…â˜…",  label:"ä¸­" };
    return { badge:"â˜…",   label:"å¼±" };
  }

  function formatRows(rows){
    if(!rows || rows.length === 0) return "ï¼ˆãªã—ï¼‰";
    return rows.map(x => `${x.i}ä½  ${x.badge} [${x.label}]  ${x.num}`).join("\n");
  }

  function splitRanked(ranked, limit=10){
    if(!ranked || ranked.length === 0) return { main: [], ins: [], rows: [] };
    const best = ranked[0].sc;

    const rows = ranked.slice(0, limit).map((r, idx) => {
      const t = tierLabel(r.sc, best);
      return { i: idx+1, num: r.n, badge: t.badge, label: t.label, sc: r.sc };
    });

    return {
      rows,
      main: rows.filter(x => x.label === "å¼·"),
      ins : rows.filter(x => x.label !== "å¼·")
    };
  }

  // ã€Œä»Šæ—¥ã¯å¼·ã„æ—¥ã€ï¼šæœ¬å‘½ä»¶æ•°ã§åˆ¤å®š
  function judgeDayPower(mainCount){
    if(mainCount >= 5) return "ğŸ”¥ ä»Šæ—¥ã¯å¼·ã„æ—¥ï¼ˆé›†ä¸­å‹è² ï¼‰";
    if(mainCount >= 3) return "â— æ™®é€šã®æ—¥ï¼ˆãƒãƒ©ãƒ³ã‚¹ï¼‰";
    return "â–³ åˆ†æ•£ã®æ—¥ï¼ˆç„¡ç†ã—ãªã„ï¼‰";
  }

  // =========================================================
  // 8) åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼‹ã‚»ãƒƒãƒˆï¼‰
  // =========================================================
  function posMatch(a,b){
    let c=0;
    for(let i=0;i<4;i++) if(a[i]===b[i]) c++;
    return c;
  }
  function digitMatchCount(a,b){
    const ca = Array(10).fill(0);
    const cb = Array(10).fill(0);
    for(const ch of a) ca[+ch]++;
    for(const ch of b) cb[+ch]++;
    let sum=0;
    for(let i=0;i<10;i++) sum += Math.min(ca[i], cb[i]);
    return sum;
  }
  function inGroup(num, groupRows){
    return groupRows.find(r => r.num === num) || null;
  }

  // =========================================================
  // 9) ç”Ÿæˆæœ¬ä½“
  // =========================================================
  function generate(){
    // å†…è”µå±¥æ­´ã‚’åŒæœŸï¼ˆç›´è¿‘10ã‚‚å†…å´ã§æ›´æ–°ï¼‰
    syncHiddenRecentFromHistory();

    const s = scoreDigits();

    const prevStr  = document.getElementById("prev").value;
    const prev2Str = document.getElementById("prev2").value;

    const h1raw = document.getElementById("hint1").value;
    const h2raw = document.getElementById("hint2").value;

    // ãƒ’ãƒ³ãƒˆã¯å¿…ãš2ã¤ï¼ˆå…±é€šå„ªå…ˆï¼‰
    const h1_2 = pick2FromHint(h1raw, s, prevStr, prev2Str, h2raw);
    const h2_2 = pick2FromHint(h2raw, s, prevStr, prev2Str, h1raw);

    // è»¸ã¯ã€Œé–“å¼•ãå‰ã®å…±é€šã€ã‚’æœ€å„ªå…ˆ
    const axisArr = chooseAxisFromRaw(h1raw, h2raw, s);
    const axis = axisArr[0] + axisArr[1];
    STATE.axis = axis;

    // ãƒ—ãƒ¼ãƒ«ï¼ˆé‡ã¿ä»˜ãï¼‰
    const pool = buildPoolWeighted(h1_2, h2_2, s);

    // å…¥åŠ›+å†…è”µå±¥æ­´ã§ã‚·ãƒ¼ãƒ‰å›ºå®šï¼ˆå±¥æ­´ãŒå¢—ãˆã‚Œã°â€œåŒã˜å…¥åŠ›â€ã§ã‚‚å¤‰åŒ–ã™ã‚‹ï¼‰
    // â†’ ã€Œè‚²ã¤ãƒ„ãƒ¼ãƒ«ã€ã«ãªã‚‹
    const historySeed = getHistory().join(",");
    const seedStr =
      h1raw + "|" + h2raw + "|" +
      prevStr + "|" + prev2Str + "|" +
      historySeed;

    const rand = mulberry32(hash32(seedStr));

    // å€™è£œ100æœ¬
    let list = [];
    while(list.length < 100){
      let n = [axisArr[0], axisArr[1]];
      while(n.length < 4) n.push(pick(pool, rand));
      list.push(n.join(""));
    }

    // ãƒ¦ãƒ‹ãƒ¼ã‚¯â†’ãƒ©ãƒ³ã‚¯
    const ranked = rank(uniq(list));
    const top10 = ranked.slice(0, 10);
    const sp = splitRanked(top10, 10);

    document.getElementById("dayPower").textContent = judgeDayPower(sp.main.length);
    document.getElementById("straightMain").textContent = formatRows(sp.main);
    document.getElementById("straightIns").textContent  = formatRows(sp.ins);

    // ã‚»ãƒƒãƒˆï¼štop10ã‚’ã‚»ãƒƒãƒˆã‚­ãƒ¼ã«ã—ã¦ãƒ©ãƒ³ã‚¯
    const setNums = uniq(top10.map(r => setKey(r.n)));
    const setRanked = rank(setNums).slice(0,10);
    const setSplit = splitRanked(setRanked, 10);

    document.getElementById("setMain").textContent = formatRows(setSplit.main);
    document.getElementById("setIns").textContent  = formatRows(setSplit.ins);

    // STATEä¿å­˜ï¼ˆåˆ¤å®šã§ä½¿ã†ï¼‰
    STATE.topStraightRows = sp.rows;
    STATE.straightMain = sp.main;
    STATE.straightIns = sp.ins;

    STATE.topSetRows = setSplit.rows;
    STATE.setMain = setSplit.main;
    STATE.setIns = setSplit.ins;

    // ç”Ÿæˆç›´å¾Œã¯åˆ¤å®šè¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
    const hCount = getHistory().length;
    document.getElementById("judgeOut").innerHTML =
      `<span class="ok">ç”ŸæˆOK</span>ï¼ˆè»¸ <span class="mono">${STATE.axis}</span>ï¼‰` +
      ` / å±¥æ­´ <span class="mono">${hCount}</span> ä»¶` +
      `<br><span class="note">â€»å±¥æ­´ãŒå¢—ãˆã‚‹ã»ã©ç²¾åº¦è£œæ­£ï¼ˆä½ç½®ã‚¯ã‚»ãƒ»ç›¸æ€§ãƒ»æ¿ƒã•ãƒ»ãƒŠãƒ³ã¡ã‚ƒã‚“åŠ ç‚¹ï¼‰ãŒåŠ¹ã</span>`;
  }

  // =========================================================
  // 10) çµæœåˆ¤å®šï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼‹ã‚»ãƒƒãƒˆä¸¡æ–¹ï¼‰
  // =========================================================
  function judge(){
    const win = normalize4(document.getElementById("win").value);
    const out = document.getElementById("judgeOut");

    if(!win){
      out.innerHTML = `<span class="warn">å½“é¸ç•ªå·ã¯4æ¡ã§å…¥ã‚Œã¦ã­</span>`;
      return;
    }

    if(!STATE.topStraightRows || STATE.topStraightRows.length === 0){
      out.innerHTML = `<span class="warn">å…ˆã«ã€Œç•ªå·ã‚’ç”Ÿæˆã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ã­</span>`;
      return;
    }

    const axis = STATE.axis; // "72" ãªã©
    const axisHit = win.includes(axis[0]) && win.includes(axis[1]);

    // ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼šæœ¬å‘½/ä¿é™º/åœå¤–
    const sMainHit = inGroup(win, STATE.straightMain);
    const sInsHit  = inGroup(win, STATE.straightIns);
    const sAnyHit  = inGroup(win, STATE.topStraightRows);

    // ã‚»ãƒƒãƒˆï¼šã‚­ãƒ¼ä¸€è‡´
    const winKey = setKey(win);
    const setMainHit = inGroup(winKey, STATE.setMain);
    const setInsHit  = inGroup(winKey, STATE.setIns);
    const setAnyHit  = inGroup(winKey, STATE.topSetRows);

    // ä¸€è‡´åº¦ï¼ˆæƒœã—ã•ç”¨ï¼‰
    let bestPos = 0;
    let bestDigit = 0;
    for(const r of STATE.topStraightRows){
      bestPos = Math.max(bestPos, posMatch(win, r.num));
      bestDigit = Math.max(bestDigit, digitMatchCount(win, r.num));
    }

    // â€œãƒŠãƒ³ã¡ã‚ƒã‚“åŠ ç‚¹çš„ã«â€å½“é¸ã‚‚è¦‹ã¦ãŠãï¼ˆã‚³ãƒ¡ãƒ³ãƒˆç”¨ï¼‰
    const nBonus = nanchanBonus(win);

    // åˆ¤å®šãƒ©ãƒ³ã‚¯
    let headline = "";
    let detail = [];

    if(sMainHit || setMainHit){
      headline = "ğŸ”¥ æ¿€ã‚¢ãƒ„ï¼ˆèª­ã¿ãŒå°„ç¨‹åœï¼‰";
    } else if(sInsHit || setInsHit){
      headline = "â— æƒœã—ã„ï¼ˆæµã‚Œã¯åˆã£ã¦ã‚‹ï¼‰";
    } else if(sAnyHit || setAnyHit || bestPos >= 3){
      headline = "â—‹ æµã‚ŒOKï¼ˆã‚ã¨ä¸€æ­©ï¼‰";
    } else if(bestDigit >= 2 || axisHit){
      headline = "â–³ åˆ†æ•£ã®æ—¥ï¼ˆç„¡ç†ã—ãªã„ï¼‰";
    } else {
      headline = "Ã— ã‚ºãƒ¬ï¼ˆä»Šæ—¥ã¯æµã‚Œé•ã„ï¼‰";
    }

    detail.push(`å½“é¸ï¼š<span class="mono">${win}</span>`);
    detail.push(`è»¸ï¼š<span class="mono">${axis}</span>ã€€/ã€€è»¸ä¸€è‡´ï¼š<span class="${axisHit?'ok':'warn'}">${axisHit?'â—‹':'Ã—'}</span>`);
    detail.push(`ãƒŠãƒ³ã¡ã‚ƒã‚“åŠ ç‚¹ï¼ˆå½“é¸å´ï¼‰ï¼š<span class="mono">+${nBonus.toFixed(1)}</span>`);

    if(sMainHit){
      detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼š<span class="ok">æœ¬å‘½ï¼ˆå¼·ï¼‰</span>ã€€${sMainHit.i}ä½`);
    } else if(sInsHit){
      detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼š<span class="ok">ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</span>ã€€${sInsHit.i}ä½`);
    } else if(sAnyHit){
      detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼š<span class="ok">åœå†…</span>ã€€${sAnyHit.i}ä½`);
    } else {
      detail.push(`ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼šåœå¤–ï¼ˆè¿‘ã•ï¼šä½ç½®ä¸€è‡´max ${bestPos}/4ã€æ•°å­—ä¸€è‡´max ${bestDigit}/4ï¼‰`);
    }

    if(setMainHit){
      detail.push(`ã‚»ãƒƒãƒˆï¼š<span class="ok">æœ¬å‘½ï¼ˆå¼·ï¼‰</span>ã€€${setMainHit.i}ä½ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
    } else if(setInsHit){
      detail.push(`ã‚»ãƒƒãƒˆï¼š<span class="ok">ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</span>ã€€${setInsHit.i}ä½ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
    } else if(setAnyHit){
      detail.push(`ã‚»ãƒƒãƒˆï¼š<span class="ok">åœå†…</span>ã€€${setAnyHit.i}ä½ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
    } else {
      detail.push(`ã‚»ãƒƒãƒˆï¼šåœå¤–ï¼ˆã‚­ãƒ¼ ${winKey}ï¼‰`);
    }

    out.innerHTML =
      `<div class="big">${headline}</div>` +
      `<div style="margin-top:8px;line-height:1.7">${detail.map(x=>`ãƒ»${x}`).join("<br>")}</div>`;
  }

  // =========================================================
  // 11) â€œè¨­è¨ˆå›³â€ã®è¦ç‚¹ï¼ˆã“ã“ã¯ã‚³ãƒ¼ãƒ‰å†…ãƒ¡ãƒ¢ï¼‰
  // =========================================================
  /*
    ã€ğŸ§  100å›ãƒ‡ãƒ¼ã‚¿ã‚’ã©ã†è©•ä¾¡ã«æ··ãœã‚‹ã‹ï¼ˆè¨­è¨ˆå›³ï¼‰ã€‘
    1) æ¿ƒã•ï¼ˆfreqï¼‰
       - ç›´è¿‘ã»ã©é‡ãï¼ˆ0-9å›:2.0 / 10-29å›:1.0 / 30-99å›:0.5ï¼‰
       - digitã‚¹ã‚³ã‚¢ã®åŸºç¤ã«ã™ã‚‹ï¼ˆscoreDigitsï¼‰

    2) ä½ç½®ã‚¯ã‚»ï¼ˆposCountï¼‰
       - åƒ/ç™¾/å/ä¸€ã”ã¨ã«ã€å‡ºã‚„ã™ã„æ•°å­—ã¯â€œãã®ä½ç½®â€ã§åŠ ç‚¹
       - rank()ã§posScoreã¨ã—ã¦åŠ ç‚¹

    3) ç›¸æ€§ï¼ˆpairCountï¼‰
       - åŒã˜å›ã«ä¸€ç·’ã«å‡ºã¦ã‚‹ãƒšã‚¢ã‚’â€œç›¸æ€§â€ã¨ã—ã¦åŠ ç‚¹
       - rank()ã§pairScoreã¨ã—ã¦åŠ ç‚¹

    ã€ğŸ”¥ ãƒŠãƒ³ã¡ã‚ƒã‚“æ³•å‰‡ã®æ•°å€¤åŒ–æ¡ˆï¼ˆå¼·åŒ–åŠ ç‚¹ï¼‰ã€‘
    - è¡¨è£åŒå±…ï¼ˆ0-5,1-6,2-7,3-8,4-9ï¼‰: +4ï¼ˆ2çµ„ä»¥ä¸Šãªã‚‰è¿½åŠ +2ï¼‰
    - ãƒ€ãƒ–ãƒ«ï¼ˆ00,11,...ï¼‰: +3
    - 1ã‚ºãƒ¬ï¼ˆå·®2 mod10ï¼‰: +2
    - 2ã‚ºãƒ¬ï¼ˆå·®3 mod10ï¼‰: +2
    â€»â€œè©•ä¾¡åŠ ç‚¹â€ã¨ã—ã¦rank()ã«åˆæµ â†’ æœ¬å‘½ã«ã‚‚åæ˜ ã•ã‚Œã‚‹
  */
</script>

</body>
</html>
